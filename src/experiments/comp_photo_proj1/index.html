<!DOCTYPE html>
<html>
<head><meta charset="utf-8" />
<title>CS194-26 Project 1</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<link rel="stylesheet" href="bootstrap.css">

<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

<style type="text/css">
h1,h2 {
    margin: auto;
    text-align: center;
}

p {
    /*text-align: left;*/
    text-align: center;
}

img {
    width: 30%;
}

#content {
    /*margin: auto;*/
}

body {
    font-family: 'Roboto', serif;
    font-size: 14px;
}

#headerimage h1 {
    position: absolute;
    width: 100%;

    color: red;
    font-size: 30px;
    text-shadow: 1px 1px 2px white;
    /*text-decoration: underline;*/

    top: 5%;
    display: block;
}

tr:nth-child(even) {
    background-color: #ffffff;
}

tr:nth-child(odd) {
    background-color: #dddddd;
}
</style>

<!-- Custom stylesheet, it must be in the same directory as the html file -->
<link rel="stylesheet" href="custom.css">

<!-- Loading mathjax macro -->
<!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML"></script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
            processEnvironments: true
        },
        // Center justify equations in code and markdown cells. Elsewhere
        // we use CSS to left justify single line equations in code cells.
        displayAlign: 'center',
        "HTML-CSS": {
            styles: {'.MathJax_Display': {"margin": 0}},
            linebreaks: { automatic: true }
        }
    });
    </script>
    <!-- End of mathjax configuration --></head>
<body>

<div id="headerimage">
    <img src="./data/final/kura_river.jpg" style="width: 100%;">
    <h1>CS194-26 Computational Photography: 
    <br> 
    Colorizing the Prokudin-Gorskii Photo Collection
    <br>
    <br>
    Dante Tam
    </h1>
</div>
<br>
<h2></h2>
<br>
<div id="content">
<p>In this project, we reconstruct RGB images from colorized glass plates using color-based image alignment.</p>
<p>Specifically, our goal is to determine a "roll" or an offset such that the digitized glass plates align,</p>
<p>and then recreate the color image from the overlayed plates.</p>
<br>
<p>We used the approach described in CS194-26: use the blue plate as the anchor,</p>
<p>and then minimize the distance metric. We used three different metrics for varying results:</p>
<br>
<!--<p>$$ SSD(a,b) = \sum_{x=1,width; y=1,height} (a - b) \circ (a - b),$$</p>-->
<p>$$ SSD(A,B) = \sum_{i=1}^{width} \sum_{j=1}^{height} (A_{ij} - B_{ij})^2 $$</p>
<br>
<p>where $ \circ $ represents an element-wise Hadamard product.</p>
<br>
<p>$$ NCC(A,B) = - \frac{a}{\vert \vert a \vert \vert} \cdot \frac{b}{\vert \vert b \vert \vert} $$</p>
<br>
<p>where $ a $ and $ b $ represent the flattened vectors of A and B.</p>
<br>
<p>$$ LaplacianDiff(A,B) = SSD(Laplacian(A), Laplacian(B)), where $$</p>
<p>$$ Laplacian(f) = \frac{\partial^2 f}{\partial x^2} + \frac{\partial^2 f}{\partial y^2} $$</p>
<br>
<p>Note the above, where I used a gradient-based approach to determine the alignment.</p>
<br>
<p>Below, we summarize the dataset we have generated from the glass plates:</p>
<br>
<table style="margin: auto; width: 50%;">
    <thead>
        <tr>
            <th>Image File Name</th>
            <th>Best Method Used</th>
            <th>Optimal Red Shift</th>
            <th>Optimal Green Shift</th>
            <th>Looks Pretty?</th>
            <th>Large</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>icon.tif</td>
            <td>SSD</td>
            <td>89, 22</td>
            <td>42, 16</td>
            <td>Yes</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>lady.tif</td>
            <td>NCC</td>
            <td>123, -17</td>
            <td>57, -6</td>
            <td>Maybe</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>melons.tif</td>
            <td>SSD</td>
            <td>176, 7</td>
            <td>83, 4</td>
            <td>Yes</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>three_generations.tif</td>
            <td>SSD</td>
            <td>108, 7</td>
            <td>52, 5</td>
            <td>Yes</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>emir.tif</td>
            <td>NCC</td>
            <td>107, 17</td>
            <td>-3, 7</td>
            <td>No</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>harvesters.tif</td>
            <td>LAP</td>
            <td>123, 12</td>
            <td>60, 14</td>
            <td>Yes</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>onion_church.tif</td>
            <td>LAP</td>
            <td>107, 34</td>
            <td>52, 20</td>
            <td>Yes</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>self_portrait.tif</td>
            <td>LAP</td>
            <td>175, 37</td>
            <td>74, 25</td>
            <td>Yes</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>train.tif</td>
            <td>LAP</td>
            <td>85, 28</td>
            <td>38, 2</td>
            <td>Yes</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>turkmen.tif</td>
            <td>LAP</td>
            <td>117, 29</td>
            <td>57, 22</td>
            <td>Yes</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>kura_river.tif</td>
            <td>LAP</td>
            <td>155, 10</td>
            <td>66, 13</td>
            <td>Yes</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>sawmill.tif</td>
            <td>LAP</td>
            <td>74, 0</td>
            <td>12, 3</td>
            <td>Yes</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>cityscape.tif</td>
            <td>LAP</td>
            <td>40, -24</td>
            <td>0, -10</td>
            <td>Yes</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>village.tif</td>
            <td>LAP</td>
            <td>273, -14</td>
            <td>65, 11</td>
            <td>No</td>
            <td>Yes</td>
        </tr>
        <tr>
            <td>cathedral.jpg</td>
            <td>SSD</td>
            <td>7, -1</td>
            <td>1, -1</td>
            <td>Yes</td>
            <td>No</td>
        </tr>
        <tr>
            <td>monastery.jpg</td>
            <td>LAP</td>
            <td>3, 2</td>
            <td>-3, 2</td>
            <td>Yes</td>
            <td>No</td>
        </tr>
        <tr>
            <td>nativity.jpg</td>
            <td>NCC</td>
            <td>7, 1</td>
            <td>3, 1</td>
            <td>Yes</td>
            <td>No</td>
        </tr>
        <tr>
            <td>tobolsk.jpg</td>
            <td>NCC</td>
            <td>6, 3</td>
            <td>3, 2</td>
            <td>Yes</td>
            <td>No</td>
        </tr>
        <tr>
            <td>settlers.jpg</td>
            <td>SSD</td>
            <td>14, -1</td>
            <td>7, 0</td>
            <td>Yes</td>
            <td>No</td>
        </tr>
    </tbody>
</table>
<br>
<p>The algorithm failed to align a few images due to issues with color balance and the margins.</p>
<p>If I had more time, I would experiment with grayscale balance and normalization to match darker and lighter values together.</p>
<p>Furthermore, I would cut off a predefined margin or programmatically determine an appropriate margin, </p>
<p>which often weighs heavily in the non-gradient distance measures.</p>
<br>
<br>
<br>
<h2>Colorized Large Images</h2>
<img src="./data/final/icon.jpg">
<img src="./data/final/lady.jpg">
<img src="./data/final/melons.jpg">
<img src="./data/final/emir.jpg">
<img src="./data/final/three_generations.jpg">
<img src="./data/final/harvesters.jpg">
<img src="./data/final/onion_church.jpg">
<img src="./data/final/self_portrait.jpg">
<img src="./data/final/train.jpg">
<img src="./data/final/turkmen.jpg">
<img src="./data/final/village.jpg">
<br>
<br>
<br>
<h2>My Own Selected Images</h2>
<img src="./data/final/kura_river.jpg">
<img src="./data/final/sawmill.jpg">
<img src="./data/final/cityscape.jpg">
<br>
<br>
<br>
<h2>Colorized Small Images</h2>
<img src="./data/final/cathedral.jpg">
<img src="./data/final/monastery.jpg">
<img src="./data/final/nativity.jpg">
<img src="./data/final/tobolsk.jpg">
<img src="./data/final/settlers.jpg">
<br>

</div>


  <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<h2>IPython Notebook Code Reference</h2>    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># CS194-26 (CS294-26): Project 1 starter Python code</span>

<span class="c1"># these are just some suggested libraries</span>
<span class="c1"># instead of scikit-image you could use matplotlib and opencv to read, write, and display images</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">skimage</span> <span class="k">as</span> <span class="nn">sk</span>
<span class="kn">import</span> <span class="nn">skimage.io</span> <span class="k">as</span> <span class="nn">skio</span>
<span class="kn">import</span> <span class="nn">skimage.transform</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">math</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># name of the input file</span>
<span class="k">def</span> <span class="nf">loadImage</span><span class="p">(</span><span class="n">imname</span><span class="p">):</span>

    <span class="c1"># read in the image</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">skio</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">imname</span><span class="p">)</span>

    <span class="c1"># convert to double (might want to do this later on to save memory)    </span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">img_as_float</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="c1"># compute the height of each part (just 1/3 of total)</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>
    
    <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
    
    <span class="c1"># separate color channels</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">im</span><span class="p">[:</span><span class="n">height</span><span class="p">]</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="n">height</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">height</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">height</span><span class="p">:</span> <span class="mi">3</span><span class="o">*</span><span class="n">height</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">scoreRegularL2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">scoreNCC</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="n">newA</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">newB</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">newA</span><span class="p">,</span> <span class="n">newB</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">lap</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Laplacian</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">CV_64F</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">scoreLap</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">scoreRegularL2</span><span class="p">(</span><span class="n">lap</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">lap</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># align the images</span>
<span class="c1"># functions that might be useful for aligning the images include:</span>
<span class="c1"># np.roll, np.sum, sk.transform.rescale (for multiscale)</span>

<span class="k">def</span> <span class="nf">alignBasic</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">mode</span><span class="p">):</span>
    <span class="n">startDeltaX</span> <span class="o">=</span> <span class="o">-</span><span class="mi">15</span>
    <span class="n">endDeltaX</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">startDeltaY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">15</span>
    <span class="n">endDeltaY</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">bestDeltaX</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
    <span class="n">bestDeltaY</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">bestMetric</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">currentRolledRed</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">currentRolledGreen</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startDeltaX</span><span class="p">,</span> <span class="n">endDeltaX</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startDeltaX</span><span class="p">,</span> <span class="n">endDeltaY</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
            <span class="n">rolledRed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">dy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">distMetric</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;Laplacian&quot;</span><span class="p">):</span>
                <span class="n">distMetric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">lap</span><span class="p">(</span><span class="n">rolledRed</span><span class="p">),</span> <span class="n">lap</span><span class="p">(</span><span class="n">b</span><span class="p">))))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;NCC&quot;</span><span class="p">):</span>
                <span class="n">distMetric</span> <span class="o">=</span> <span class="n">scoreNCC</span><span class="p">(</span><span class="n">rolledRed</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">distMetric</span> <span class="o">=</span> <span class="n">scoreRegularL2</span><span class="p">(</span><span class="n">rolledRed</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">distMetric</span> <span class="o">&lt;</span> <span class="n">bestMetric</span> <span class="ow">or</span> <span class="n">bestMetric</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">bestDeltaX</span> <span class="o">=</span> <span class="n">dx</span>
                <span class="n">bestDeltaY</span> <span class="o">=</span> <span class="n">dy</span>
                <span class="n">bestMetric</span> <span class="o">=</span> <span class="n">distMetric</span>
                <span class="n">currentRolledRed</span> <span class="o">=</span> <span class="n">rolledRed</span>

    <span class="n">bestMetric</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>            

    <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startDeltaX</span><span class="p">,</span> <span class="n">endDeltaX</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startDeltaX</span><span class="p">,</span> <span class="n">endDeltaY</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
            <span class="n">rolledGreen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">dy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">distMetric</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;Laplacian&quot;</span><span class="p">):</span>
                <span class="n">distMetric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">lap</span><span class="p">(</span><span class="n">rolledGreen</span><span class="p">),</span> <span class="n">lap</span><span class="p">(</span><span class="n">b</span><span class="p">))))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;NCC&quot;</span><span class="p">):</span>
                <span class="n">distMetric</span> <span class="o">=</span> <span class="n">scoreNCC</span><span class="p">(</span><span class="n">rolledGreen</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">distMetric</span> <span class="o">=</span> <span class="n">scoreRegularL2</span><span class="p">(</span><span class="n">rolledGreen</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">distMetric</span> <span class="o">&lt;</span> <span class="n">bestMetric</span> <span class="ow">or</span> <span class="n">bestMetric</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">bestDeltaX</span> <span class="o">=</span> <span class="n">dx</span>
                <span class="n">bestDeltaY</span> <span class="o">=</span> <span class="n">dy</span>
                <span class="n">bestMetric</span> <span class="o">=</span> <span class="n">distMetric</span>
                <span class="n">currentRolledGreen</span> <span class="o">=</span> <span class="n">rolledGreen</span>
                
    <span class="k">return</span> <span class="n">currentRolledRed</span><span class="p">,</span> <span class="n">currentRolledGreen</span><span class="p">,</span> <span class="n">b</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">pyramidAlign</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">mode</span><span class="p">):</span>
    <span class="n">scaledImagesR</span><span class="p">,</span> <span class="n">scaledImagesG</span><span class="p">,</span> <span class="n">scaledImagesB</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">-</span> <span class="mi">6</span>
    <span class="n">times</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">times</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
        <span class="n">desiredScale</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">scaledImagesR</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sk</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">desiredScale</span><span class="p">))</span>
        <span class="n">scaledImagesG</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sk</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">desiredScale</span><span class="p">))</span>
        <span class="n">scaledImagesB</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sk</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">desiredScale</span><span class="p">))</span>
    <span class="n">initStartX</span> <span class="o">=</span> <span class="o">-</span><span class="n">scaledImagesR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span>
    <span class="n">initEndX</span> <span class="o">=</span> <span class="n">scaledImagesR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span>
    <span class="n">initStartY</span> <span class="o">=</span> <span class="o">-</span><span class="n">scaledImagesR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span>
    <span class="n">initEndY</span> <span class="o">=</span> <span class="n">scaledImagesR</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">8</span>
    
    <span class="n">startDeltaXR</span><span class="p">,</span> <span class="n">startDeltaYR</span><span class="p">,</span> <span class="n">endDeltaXR</span><span class="p">,</span> <span class="n">endDeltaYR</span> <span class="o">=</span> <span class="n">initStartX</span><span class="p">,</span> <span class="n">initStartY</span><span class="p">,</span> <span class="n">initEndX</span><span class="p">,</span> <span class="n">initEndY</span>
    <span class="n">startDeltaXG</span><span class="p">,</span> <span class="n">startDeltaYG</span><span class="p">,</span> <span class="n">endDeltaXG</span><span class="p">,</span> <span class="n">endDeltaYG</span> <span class="o">=</span> <span class="n">initStartX</span><span class="p">,</span> <span class="n">initStartY</span><span class="p">,</span> <span class="n">initEndX</span><span class="p">,</span> <span class="n">initEndY</span>
    <span class="n">startDeltaXR</span><span class="p">,</span> <span class="n">startDeltaYR</span><span class="p">,</span> <span class="n">endDeltaXR</span><span class="p">,</span> <span class="n">endDeltaYR</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">startDeltaXG</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">startDeltaYG</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">endDeltaXG</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">endDeltaYG</span><span class="p">)</span> 
    <span class="n">startDeltaXG</span><span class="p">,</span> <span class="n">startDeltaYG</span><span class="p">,</span> <span class="n">endDeltaXG</span><span class="p">,</span> <span class="n">endDeltaYG</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">startDeltaXG</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">startDeltaYG</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">endDeltaXG</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">endDeltaYG</span><span class="p">)</span>
    <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="n">currentRolledRed</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">currentRolledGreen</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">maxPixels</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">limitMaxPixels</span> <span class="o">=</span> <span class="mi">4</span>
    
    <span class="n">curB</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="p">):</span>
        <span class="n">curR</span><span class="p">,</span> <span class="n">curG</span><span class="p">,</span> <span class="n">curB</span> <span class="o">=</span> <span class="n">scaledImagesR</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scaledImagesG</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">scaledImagesB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="n">bestDeltaX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bestDeltaY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bestMetric</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="c1">#print(&quot;Analyzing: &quot;)</span>
        <span class="c1">#print(startDeltaXR, endDeltaXR, startDeltaYR, endDeltaYR)</span>
        <span class="c1">#print(&quot;Current size: &quot;)</span>
        <span class="c1">#print(scaledImagesR[i].shape[0], scaledImagesR[i].shape[1])</span>
        
        <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startDeltaXR</span><span class="p">,</span> <span class="n">endDeltaXR</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startDeltaYR</span><span class="p">,</span> <span class="n">endDeltaYR</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
                <span class="n">distMetric</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">rolledRed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">curR</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">dy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;Laplacian&quot;</span><span class="p">):</span>
                    <span class="n">distMetric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">lap</span><span class="p">(</span><span class="n">rolledRed</span><span class="p">),</span> <span class="n">lap</span><span class="p">(</span><span class="n">curB</span><span class="p">))))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;NCC&quot;</span><span class="p">):</span>
                    <span class="n">distMetric</span> <span class="o">=</span> <span class="n">scoreNCC</span><span class="p">(</span><span class="n">rolledRed</span><span class="p">,</span> <span class="n">curB</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">distMetric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">rolledRed</span><span class="p">,</span> <span class="n">curB</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">distMetric</span> <span class="o">&lt;</span> <span class="n">bestMetric</span> <span class="ow">or</span> <span class="n">bestMetric</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">bestDeltaX</span> <span class="o">=</span> <span class="n">dx</span>
                    <span class="n">bestDeltaY</span> <span class="o">=</span> <span class="n">dy</span>
                    <span class="n">bestMetric</span> <span class="o">=</span> <span class="n">distMetric</span>
                    <span class="n">currentRolledRed</span> <span class="o">=</span> <span class="n">rolledRed</span>   

        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">times</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nextSize</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">scaledImagesR</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scaledImagesR</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">startDeltaXR</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">bestDeltaX</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxPixels</span><span class="p">,</span> <span class="n">nextSize</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">))</span>
            <span class="n">startDeltaYR</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">bestDeltaY</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxPixels</span><span class="p">,</span> <span class="n">nextSize</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">))</span>
            <span class="n">endDeltaXR</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bestDeltaX</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxPixels</span><span class="p">,</span> <span class="n">nextSize</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">))</span>
            <span class="n">endDeltaYR</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bestDeltaY</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxPixels</span><span class="p">,</span> <span class="n">nextSize</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">))</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found best roll&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">bestDeltaX</span><span class="p">,</span> <span class="n">bestDeltaY</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resized to range: &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">startDeltaXR</span><span class="p">,</span> <span class="n">endDeltaXR</span><span class="p">,</span> <span class="n">startDeltaYR</span><span class="p">,</span> <span class="n">endDeltaYR</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Next size: &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">scaledImagesR</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scaledImagesR</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found final result offset for red:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">bestDeltaX</span><span class="p">,</span> <span class="n">bestDeltaY</span><span class="p">)</span>
            
        <span class="n">bestDeltaX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bestDeltaY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bestMetric</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">dx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startDeltaXG</span><span class="p">,</span> <span class="n">endDeltaXG</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startDeltaYG</span><span class="p">,</span> <span class="n">endDeltaYG</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
                <span class="n">distMetric</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">rolledGreen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">curG</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">dy</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;Laplacian&quot;</span><span class="p">):</span>
                    <span class="n">distMetric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">lap</span><span class="p">(</span><span class="n">rolledGreen</span><span class="p">),</span> <span class="n">lap</span><span class="p">(</span><span class="n">curB</span><span class="p">))))</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;NCC&quot;</span><span class="p">):</span>
                    <span class="n">distMetric</span> <span class="o">=</span> <span class="n">scoreNCC</span><span class="p">(</span><span class="n">rolledGreen</span><span class="p">,</span> <span class="n">curB</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">distMetric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">rolledGreen</span><span class="p">,</span> <span class="n">curB</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">distMetric</span> <span class="o">&lt;</span> <span class="n">bestMetric</span> <span class="ow">or</span> <span class="n">bestMetric</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">bestDeltaX</span> <span class="o">=</span> <span class="n">dx</span>
                    <span class="n">bestDeltaY</span> <span class="o">=</span> <span class="n">dy</span>
                    <span class="n">bestMetric</span> <span class="o">=</span> <span class="n">distMetric</span>
                    <span class="n">currentRolledGreen</span> <span class="o">=</span> <span class="n">rolledGreen</span> 

        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">times</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nextSize</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">scaledImagesG</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scaledImagesG</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">startDeltaXG</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">bestDeltaX</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxPixels</span><span class="p">,</span> <span class="n">nextSize</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">))</span>
            <span class="n">startDeltaYG</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">bestDeltaY</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxPixels</span><span class="p">,</span> <span class="n">nextSize</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">))</span>
            <span class="n">endDeltaXG</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bestDeltaX</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxPixels</span><span class="p">,</span> <span class="n">nextSize</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">))</span>
            <span class="n">endDeltaYG</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bestDeltaY</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxPixels</span><span class="p">,</span> <span class="n">nextSize</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">))</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found best roll&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">bestDeltaX</span><span class="p">,</span> <span class="n">bestDeltaY</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Resized to range: &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">startDeltaXG</span><span class="p">,</span> <span class="n">endDeltaXG</span><span class="p">,</span> <span class="n">startDeltaYG</span><span class="p">,</span> <span class="n">endDeltaYG</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Next size: &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">scaledImagesG</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scaledImagesG</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found final result offset for green:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">bestDeltaX</span><span class="p">,</span> <span class="n">bestDeltaY</span><span class="p">)</span>
        
        <span class="n">maxPixels</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxPixels</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">limitMaxPixels</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">currentRolledRed</span><span class="p">,</span> <span class="n">currentRolledGreen</span><span class="p">,</span> <span class="n">curB</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">### ag = align(g, b)</span>
<span class="c1">### ar = align(r, b)</span>
<span class="c1"># create a color image</span>

<span class="c1">#currentRolledRed = np.roll(np.roll(r, 0, axis=0), 1, axis=1)</span>
<span class="c1">#currentRolledGreen = np.roll(np.roll(g, -5, axis=0), 1, axis=1)</span>

<span class="k">def</span> <span class="nf">fullProcessRGB</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">loadImage</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    
    <span class="n">ar</span><span class="p">,</span><span class="n">ag</span><span class="p">,</span><span class="n">ab</span> <span class="o">=</span> <span class="n">alignBasic</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">ar</span><span class="p">,</span> <span class="n">ag</span><span class="p">,</span> <span class="n">ab</span><span class="p">])</span>

    <span class="c1"># save the image</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;./output/&#39;</span> <span class="o">+</span> <span class="n">filename</span>
    <span class="n">skio</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">im_out</span><span class="p">)</span>

    <span class="c1"># display the image</span>
    <span class="c1">#skio.imshow(im_out)</span>

    <span class="c1">#skio.show()</span>
    
    <span class="k">return</span> <span class="n">im_out</span>

<span class="k">def</span> <span class="nf">largeProcessRGB</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">loadImage</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">ar</span><span class="p">,</span><span class="n">ag</span><span class="p">,</span><span class="n">ab</span> <span class="o">=</span> <span class="n">pyramidAlign</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">([</span><span class="n">ar</span><span class="p">,</span> <span class="n">ag</span><span class="p">,</span> <span class="n">ab</span><span class="p">])</span>

    <span class="c1"># save the image</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;./output/&#39;</span> <span class="o">+</span> <span class="n">filename</span>
    <span class="n">skio</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">im_out</span><span class="p">)</span>

    <span class="c1"># display the image</span>
    <span class="c1">#skio.imshow(im_out)</span>

    <span class="c1">#skio.show()</span>
    
    <span class="k">return</span> <span class="n">im_out</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">smallPicturesLaplacian</span> <span class="o">=</span> <span class="p">[</span>
    
<span class="p">]</span>

<span class="n">smallPicturesNCC</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;monastery.jpg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nativity.jpg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tobolsk.jpg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;settlers.jpg&quot;</span>
<span class="p">]</span>

<span class="n">smallPicturesNormalAlign</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1">#&quot;settlers.jpg&quot;</span>
<span class="p">]</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">smallPicturesLaplacian</span><span class="p">:</span>
    <span class="n">fullProcessRGB</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Laplacian&quot;</span><span class="p">)</span>
    
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">smallPicturesNCC</span><span class="p">:</span>
    <span class="n">fullProcessRGB</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;NCC&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">smallPicturesNormalAlign</span><span class="p">:</span>
    <span class="n">fullProcessRGB</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Normal&quot;</span><span class="p">)</span>    
    
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stderr output_text">
<pre>c:\Anaconda3\lib\site-packages\skimage\util\dtype.py:122: UserWarning: Possible precision loss when converting from float64 to uint8
  .format(dtypeobj_in, dtypeobj_out))
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">largePicturesAlign</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;icon.tif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lady.tif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;melons.tif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;three_generations.tif&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">largePicturesNCC</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1">#&quot;lady.tif&quot;,</span>
    <span class="s2">&quot;emir.tif&quot;</span>
<span class="p">]</span>

<span class="n">largePicturesLaplacian</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1">#&quot;emir.tif&quot;,</span>
    <span class="s2">&quot;harvesters.tif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;onion_church.tif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;self_portrait.tif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;turkmen.tif&quot;</span><span class="p">,</span>
    <span class="s2">&quot;village.tif&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">largePicturesAlign</span><span class="p">:</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">largeProcessRGB</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Normal&quot;</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;./output/&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
    <span class="n">skio</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">im_out</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processed image: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
    
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">largePicturesNCC</span><span class="p">:</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">largeProcessRGB</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;NCC&quot;</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;./output/&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
    <span class="n">skio</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">im_out</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processed image: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
    
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">largePicturesLaplacian</span><span class="p">:</span>
    <span class="n">im_out</span> <span class="o">=</span> <span class="n">largeProcessRGB</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;Laplacian&quot;</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;./output/&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
    <span class="n">skio</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">im_out</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processed image: &quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stderr output_text">
<pre>c:\Anaconda3\lib\site-packages\skimage\transform\_warps.py:84: UserWarning: The default mode, &#39;constant&#39;, will be changed to &#39;reflect&#39; in skimage 0.15.
  warn(&#34;The default mode, &#39;constant&#39;, will be changed to &#39;reflect&#39; in &#34;
</pre>
</div>
</div>

<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Found best roll
6 1
Resized to range: 
10 14 0 4
Next size: 
406 468
Found best roll
3 1
Resized to range: 
4 8 0 4
Next size: 
406 468
Found best roll
11 3
Resized to range: 
18 26 2 10
Next size: 
811 935
Found best roll
5 2
Resized to range: 
6 14 0 8
Next size: 
811 935
Found best roll
22 6
Resized to range: 
40 48 8 16
Next size: 
1622 1870
Found best roll
11 4
Resized to range: 
18 26 4 12
Next size: 
1622 1870
Found best roll
45 11
Resized to range: 
86 94 18 26
Next size: 
3244 3741
Found best roll
21 8
Resized to range: 
38 46 12 20
Next size: 
3244 3741
Found final result offset for red:
89 22
Found final result offset for green:
42 16
</pre>
</div>
</div>

<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stderr output_text">
<pre>c:\Anaconda3\lib\site-packages\skimage\util\dtype.py:122: UserWarning: Possible precision loss when converting from float64 to uint8
  .format(dtypeobj_in, dtypeobj_out))
</pre>
</div>
</div>

<div class="output_area">

<div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Processed image: icon.tif
Found best roll
8 -1
Resized to range: 
14 18 -4 0
Next size: 
402 470
Found best roll
3 0
Resized to range: 
4 8 -2 2
Next size: 
402 470
Found best roll
15 -2
Resized to range: 
26 34 -8 0
Next size: 
803 940
Found best roll
7 -1
Resized to range: 
10 18 -6 2
Next size: 
803 940
Found best roll
31 -4
Resized to range: 
58 66 -12 -4
Next size: 
1606 1880
Found best roll
14 -2
Resized to range: 
24 32 -8 0
Next size: 
1606 1880
Found best roll
61 -8
Resized to range: 
118 126 -20 -12
Next size: 
3212 3761
Found best roll
28 -3
Resized to range: 
52 60 -10 -2
Next size: 
3212 3761
Found final result offset for red:
123 -17
Found final result offset for green:
57 -6
Processed image: lady.tif
Found best roll
11 0
Resized to range: 
20 24 -2 2
Next size: 
405 471
Found best roll
5 0
Resized to range: 
8 12 -2 2
Next size: 
405 471
Found best roll
22 1
Resized to range: 
40 48 -2 6
Next size: 
810 942
Found best roll
10 0
Resized to range: 
16 24 -4 4
Next size: 
810 942
Found best roll
44 2
Resized to range: 
84 92 0 8
Next size: 
1620 1885
Found best roll
21 1
Resized to range: 
38 46 -2 6
Next size: 
1620 1885
Found best roll
88 4
Resized to range: 
172 180 4 12
Next size: 
3241 3770
Found best roll
41 2
Resized to range: 
78 86 0 8
Next size: 
3241 3770
Found final result offset for red:
176 7
Found final result offset for green:
83 4
Processed image: melons.tif
Found best roll
7 0
Resized to range: 
12 16 -2 2
Next size: 
401 464
Found best roll
3 0
Resized to range: 
4 8 -2 2
Next size: 
401 464
Found best roll
14 1
Resized to range: 
24 32 -2 6
Next size: 
802 928
Found best roll
7 1
Resized to range: 
10 18 -2 6
Next size: 
802 928
Found best roll
27 2
Resized to range: 
50 58 0 8
Next size: 
1604 1857
Found best roll
13 1
Resized to range: 
22 30 -2 6
Next size: 
1604 1857
Found best roll
54 4
Resized to range: 
104 112 4 12
Next size: 
3209 3714
Found best roll
26 2
Resized to range: 
48 56 0 8
Next size: 
3209 3714
Found final result offset for red:
108 7
Found final result offset for green:
52 5
Processed image: three_generations.tif
Found best roll
7 1
Resized to range: 
12 16 0 4
Next size: 
401 463
Found best roll
0 0
Resized to range: 
-2 2 -2 2
Next size: 
401 463
Found best roll
13 2
Resized to range: 
22 30 0 8
Next size: 
802 926
Found best roll
0 1
Resized to range: 
-4 4 -2 6
Next size: 
802 926
Found best roll
27 4
Resized to range: 
50 58 4 12
Next size: 
1604 1851
Found best roll
-1 2
Resized to range: 
-6 2 0 8
Next size: 
1604 1851
Found best roll
53 9
Resized to range: 
102 110 14 22
Next size: 
3209 3702
Found best roll
-2 4
Resized to range: 
-8 0 4 12
Next size: 
3209 3702
Found final result offset for red:
107 17
Found final result offset for green:
-3 7
Processed image: emir.tif
Found best roll
8 1
Resized to range: 
14 18 0 4
Next size: 
402 460
Found best roll
4 1
Resized to range: 
6 10 0 4
Next size: 
402 460
Found best roll
15 1
Resized to range: 
26 34 -2 6
Next size: 
804 921
Found best roll
8 2
Resized to range: 
12 20 0 8
Next size: 
804 921
Found best roll
31 3
Resized to range: 
58 66 2 10
Next size: 
1609 1842
Found best roll
15 4
Resized to range: 
26 34 4 12
Next size: 
1609 1842
Found best roll
62 5
Resized to range: 
120 128 6 14
Next size: 
3218 3683
Found best roll
30 7
Resized to range: 
56 64 10 18
Next size: 
3218 3683
Found final result offset for red:
123 12
Found final result offset for green:
60 14
Processed image: harvesters.tif
Found best roll
7 2
Resized to range: 
12 16 2 6
Next size: 
402 473
Found best roll
3 2
Resized to range: 
4 8 2 6
Next size: 
402 473
Found best roll
13 5
Resized to range: 
22 30 6 14
Next size: 
804 945
Found best roll
6 4
Resized to range: 
8 16 4 12
Next size: 
804 945
Found best roll
27 9
Resized to range: 
50 58 14 22
Next size: 
1608 1890
Found best roll
13 6
Resized to range: 
22 30 8 16
Next size: 
1608 1890
Found best roll
54 17
Resized to range: 
104 112 30 38
Next size: 
3215 3781
Found best roll
26 10
Resized to range: 
48 56 16 24
Next size: 
3215 3781
Found final result offset for red:
107 34
Found final result offset for green:
52 20
Processed image: onion_church.tif
Found best roll
11 2
Resized to range: 
20 24 2 6
Next size: 
406 476
Found best roll
5 2
Resized to range: 
8 12 2 6
Next size: 
406 476
Found best roll
22 5
Resized to range: 
40 48 6 14
Next size: 
813 952
Found best roll
10 4
Resized to range: 
16 24 4 12
Next size: 
813 952
Found best roll
44 9
Resized to range: 
84 92 14 22
Next size: 
1626 1905
Found best roll
20 8
Resized to range: 
36 44 12 20
Next size: 
1626 1905
Found best roll
87 18
Resized to range: 
170 178 32 40
Next size: 
3251 3810
Found best roll
37 12
Resized to range: 
70 78 20 28
Next size: 
3251 3810
Found final result offset for red:
175 37
Found final result offset for green:
74 25
Processed image: self_portrait.tif
Found best roll
7 2
Resized to range: 
12 16 2 6
Next size: 
401 470
Found best roll
3 1
Resized to range: 
4 8 0 4
Next size: 
401 470
Found best roll
14 3
Resized to range: 
24 32 2 10
Next size: 
802 940
Found best roll
7 3
Resized to range: 
10 18 2 10
Next size: 
802 940
Found best roll
29 7
Resized to range: 
54 62 10 18
Next size: 
1604 1881
Found best roll
14 5
Resized to range: 
24 32 6 14
Next size: 
1604 1881
Found best roll
59 14
Resized to range: 
114 122 24 32
Next size: 
3209 3762
Found best roll
29 11
Resized to range: 
54 62 18 26
Next size: 
3209 3762
Found final result offset for red:
117 29
Found final result offset for green:
57 22
Processed image: turkmen.tif
Found best roll
17 -1
Resized to range: 
32 36 -4 0
Next size: 
409 477
Found best roll
4 1
Resized to range: 
6 10 0 4
Next size: 
409 477
Found best roll
34 -2
Resized to range: 
64 72 -8 0
Next size: 
818 955
Found best roll
8 2
Resized to range: 
12 20 0 8
Next size: 
818 955
Found best roll
68 -4
Resized to range: 
132 140 -12 -4
Next size: 
1635 1910
Found best roll
16 3
Resized to range: 
28 36 2 10
Next size: 
1635 1910
Found best roll
136 -7
Resized to range: 
268 276 -18 -10
Next size: 
3270 3819
Found best roll
32 5
Resized to range: 
60 68 6 14
Next size: 
3270 3819
Found final result offset for red:
273 -14
Found final result offset for green:
65 11
Processed image: village.tif
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

</div>
</div>
</div>

</div>
    </div>
  </div>
</body>

 


</html>
