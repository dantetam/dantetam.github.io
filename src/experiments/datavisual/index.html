<!DOCTYPE html>
<meta charset="utf-8">
<style>
.axis text {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.hexagon {
  fill: none;
  stroke: #000;
  stroke-width: .5px;
}

.svg {
  overflow: visible;
}

.svg:not(:root) {
  overflow: visible;
}

p {
  margin: 0px;
  padding: 0px;
}

#planet-tooltip {
  position: absolute;
  text-align: center;
	left: 10%;
	top: 25%;
  width: auto;
  height: auto;
  max-width: 30% !important;
  min-height: 40% !important;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
	opacity: 0;
  pointer-events: none;
}

#empire-menu, #tech-menu, #diplomacy-menu {
  position: absolute;
  text-align: center;
  left: 10%;
  top: 25%;
  width: auto;
  height: auto;
  min-width: 25% !important;
  min-height: 60% !important;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  opacity: 0;
  pointer-events: none;
}

#contact-menu {
  position: absolute;
  text-align: center;
  left: 35%;
  top: 25%;
  width: auto;
  height: auto;
  min-width: 15% !important;
  min-height: 30% !important;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  opacity: 0;
  pointer-events: none;
}

#planet-tooltip-menu {
  width: 25%;
  float: left;
  padding: 15px;
  /*border: 1px solid red;*/
}

#planet-tooltip-main {
  width: 100%;
  float: left;
  padding: 15px;
  /*border: 1px solid red;*/
}

#system-tooltip-main {
  position: absolute;
  text-align: center;
  left: 40%;
  top: 25%;
  width: auto;
  height: auto;
  min-width: 35% !important;
  min-height: 70% !important;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  opacity: 0;
  pointer-events: none;
}

#outline-tooltip {
  position: absolute;
  text-align: center;
  left: 75%;
  top: 25%;
  width: auto;
  height: auto;
  min-width: 15% !important;
  min-height: 30% !important;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  opacity: 1;
  pointer-events: auto;
}

#planet-build-main, #spaceport-build-main, #satellite-build-main {
  position: absolute;
  text-align: center;
  left: 40%;
  top: 25%;
  width: 20%;
  height: auto;
  min-height: 30% !important;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  opacity: 0;
  pointer-events: none;
}

#system-action-menu {
  position: relative;
  text-align: center;
  left: 0%;
  top: 0%;
  width: auto;
  height: auto;
  min-width: 15% !important;
  min-height: 5% !important;
  max-width: 15% !important;
  max-height: 30% !important;
  padding: 2px;
  font: 12px sans-serif;
  background: white;
  border: 0px;
  border-radius: 8px;
  opacity: 0;
  pointer-events: none;
}

#system-tooltip-header {

}

#system-tooltip-starmap {

}

#fleet-tooltip-main {
  position: absolute;
  text-align: center;
  left: 10%;
  top: 65%;
  width: auto;
  height: auto;
  min-width: 20% !important;
  min-height: 30% !important;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  opacity: 0;
  pointer-events: none;
}

.col-md-3 {
  line-height: 90%;
}

.intro { height: 100px; width: 300px; }

#player-hud {
  position: absolute;
  text-align: center;
	top: 10%;
	left: 40%;
  width: auto;
  height: auto;
  min-width: 50% !important;
  min-height: 10% !important;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  /*pointer-events: none;*/
}

#menu-bar {
  position: absolute;
  text-align: left;
  vertical-align: middle;
  top: 10%;
  width: 30%;
  left: 10%;
  height: 10%;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  opacity: 1;
  pointer-events: auto;
}

#tutorial {
  position: absolute;
  text-align: center;
  top: 25%;
  width: 15%;
  left: 60%;
  height: 5%;
  padding: 2px;
  font: 12px sans-serif;
  background: lightsteelblue;
  border: 0px;
  border-radius: 8px;
  opacity: 1;
  pointer-events: none;
}

#system-tutorial {
  position: relative;
  text-align: center;
  top: 25%;
  width: 30%;
  left: 60%;
  height: 15%;
  padding: 2px;
  font: 12px sans-serif;
  background: rgba(255, 255, 255, 0);
  border: 0px;
  border-radius: 8px;
  opacity: 1;
  pointer-events: none;
}

#message-tooltip {
  position: absolute;
  text-align: center;
  top: 50%;
  width: 30%;
  left: 35%;
  height: 30%;
  padding: 2px;
  font: 12px sans-serif;
  border: 0px;
  border-radius: 8px;
  background: rgb(255, 255, 255); /* Fallback for older browsers without RGBA-support */
  background: rgba(255, 255, 255, 0.75);
  opacity: 0;
  pointer-events: none;
}

h3 span { font-size: 12px; }

.tint {
  position: relative;
  float: left;
  margin-right: 20px;
  margin-bottom: 20px;
  cursor: pointer;
  box-shadow: rgba(0,0,0,.2) 3px 5px 5px;
}

.tint:before {
  content: "";
  display: block;
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,255,255, 0.5);
  transition: all .3s linear;
}

</style>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../favicon.ico">

    <title>Dante Tam</title>

    <!-- Bootstrap core CSS -->
    <link href="../../../dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="../../../assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="index.css" rel="stylesheet">
		<link href="default.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="../../../assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

		<!--<script src="d3.v3.min.js"></script>-->
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="https://d3js.org/d3-random.v1.min.js"></script>
    <script src="https://d3js.org/d3-timer.v1.min.js"></script>
    <script src="https://d3js.org/d3-array.v1.min.js"></script>
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-queue.v2.min.js"></script>

    <script src="d3.hexbin.min.js"></script>

  </head>

  <body>
    <nav class="navbar navbar-intro navbar-fixed-top navie">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
          </button>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav navbar-intro">
						<li class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">@dantetam<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li class="dropdown-header">Professional</li>
								<li><a href="https://github.com/dantetam" target="_blank">GitHub</a></li>
								<li><a href="mailto:dante.tam1@gmail.com">E-mail</a></li>
								<li role="separator" class="divider"></li>
								<li class="dropdown-header">Personal</li>
								<li><a href="#"></a></li>
								<li><a href="#"></a></li>
							</ul>
						</li>
            <li><a href="../../../index.html">Home</a></li>
            <li><a href="../../projects.html">Personal Projects</a></li>
            <li><a href="../../design/dante_design.pdf">Design</a></li>
						<li><a href="../../writings.html">Writings</a></li>
						<li class="dropdown">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Technical Drawings<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li class="dropdown-header">Design</li>
								<li><a href="../../opstrykon_gdd.pdf">Game Design Document</a></li>
								<li><a href="../../drawings.html">Architecture</a></li>
								<li role="separator" class="divider"></li>
								<li class="dropdown-header">Nav header</li>
								<li><a href="#"></a></li>
								<li><a href="#"></a></li>
							</ul>
						</li>
						<li><a href="../../courses.html">Courses</a></li>
						<li><a href="../../resume.pdf">Resume</a></li>
						<li class="dropdown active">
							<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Experiments<span class="caret"></span></a>
							<ul class="dropdown-menu">
								<li class="dropdown-header">Design and Data</li>
                <li><a href="../../experiments/stella/index.html">Stella AI</a></li>
								<li><a href="../../experiments/resume/index.html">Interactive Resume (d3.js)</a></li>
								<li><a href="../../experiments/testglwebsite/src/index.html">Graphics (WebGL)</a></li>
								<li class="active"><a href="../../experiments/datavisual/index.html">Data Visualization (d3.js)</a></li>
								<li role="separator" class="divider"></li>
								<li><a href="#"></a></li>
								<li><a href="#"></a></li>
							</ul>
						</li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">

      <div class="intro">

      </div>

    </div><!-- /.container -->

		<div id="player-hud">
			<p>
        <div id="player-hud-resources">
  				<img src="./images/minerals.png" alt="Minerals" width="50" height="50" style="max-height:20px; max-width:20px; width:10%;"/>&emsp;150 / +0&emsp;&emsp;&emsp;
  				&emsp;<img src="./images/energy.png" alt="Energy" width="50" height="50" style="max-height:20px; max-width:20px; width:10%;"/>&emsp;50 / +0&emsp;&emsp;&emsp;
  				&emsp;<img src="./images/planets.png" alt="Planets" width="50" height="50" style="max-height:20px; max-width:20px; width:10%;"/>&emsp;1&emsp;&emsp;&emsp;
        </div>
        <button type="button" onclick="javascript:setGameSpeed(&quot;Paused&quot;)">Pause</button>
        <button type="button" onclick="javascript:setGameSpeed(&quot;Slow&quot;)">Slow</button>
        <button type="button" onclick="javascript:setGameSpeed(&quot;Fast&quot;)">Fast</button>
        <button type="button" onclick="javascript:setGameSpeed(&quot;Fastest&quot;)">Fastest</button>
        <div id="player-hud-time"></div>
      </p>
		</div>
    <div id="menu-bar">
      <img src="./images/population.png" alt="Minerals" onclick="javascript:displayEmpireMenu();" width="50" height="50" style="max-height:40px; max-width:40px; width:10%;"/>
      <img src="./images/research-icon.png" alt="Research" onclick="javascript:displayTechMenu();" width="50" height="50" style="max-height:40px; max-width:40px; width:10%;"/>
      <img src="./images/diplomacy-icon.png" alt="Diplomacy" onclick="javascript:displayDiplomacyMenu();" width="50" height="50" style="max-height:40px; max-width:40px; width:10%;"/>
		</div>
    <div id="tutorial">
			<p>
				Click on the hexes to learn about the planets in those sectors!
			</p>
		</div>

		<div id="planet-tooltip">

			<div id="planet-tooltip-header">
				<h1>Test</h1>
			</div>

			<!--<div id="planet-tooltip-menu">
				<ul>
					<li>Test</li>
					<li>Test</li>
					<li>Test</li>
					<li>Test</li>
				</ul>
			</div>-->

			<div id="planet-tooltip-main">
				<div class="row">
					<div id="planet-tooltip-tile0" class="col-md-3">Test Text</div>
					<div id="planet-tooltip-tile1" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile2" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile3" class="col-md-3">col-md-3</div>
				</div>
				<div class="row">
					<div id="planet-tooltip-tile4" class="col-md-3">Test Text</div>
					<div id="planet-tooltip-tile5" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile6" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile7" class="col-md-3">col-md-3</div>
				</div>
				<div class="row">
					<div id="planet-tooltip-tile8" class="col-md-3">Test Text</div>
					<div id="planet-tooltip-tile9" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile10" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile11" class="col-md-3">col-md-3</div>
				</div>
				<div class="row">
					<div id="planet-tooltip-tile12" class="col-md-3">Test Text</div>
					<div id="planet-tooltip-tile13" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile14" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile15" class="col-md-3">col-md-3</div>
				</div>
				<div class="row">
					<div id="planet-tooltip-tile16" class="col-md-3">Test Text</div>
					<div id="planet-tooltip-tile17" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile18" class="col-md-3">col-md-3</div>
					<div id="planet-tooltip-tile19" class="col-md-3">col-md-3</div>
				</div>
			</div>

		</div>

    <div id="system-tooltip-main">

      <div id="system-tooltip-header">
				<h1>Test</h1>
			</div>

      <div id="system-action-menu">
      </div>

      <div id="system-tutorial">
        <p>
          Click on the planets to look at their resources and other information!
        </p>
      </div>

      <div id="system-tooltip-starmap">
      </div>

    </div>

    <div id="empire-menu">

    </div>

    <div id="tech-menu">
      <div id="tech-menu-header">
        <h3>Research</h3>
      </div>
      <div id="tech-star-display">
      </div>
      <div id="tech-society-display">
      </div>
      <div id="tech-production-display">
      </div>
    </div>

    <div id="diplomacy-menu">
    </div>

    <div id="contact-menu">
    </div>

    <div id="message-tooltip">
      Yes
      <p>Fit text</p>
    </div>

    <div id="planet-build-main">
      <div id="planet-build-header">
				<h1>Test</h1>
			</div>
      <div id="planet-build-options">
      </div>
    </div>

    <div id="spaceport-build-main">
      <div id="spaceport-build-header">
				<h1>Test</h1>
			</div>
      <div id="spaceport-build-options">
      </div>
    </div>

    <div id="satellite-build-main">
      <div id="satellite-build-header">
				<h1>Test</h1>
			</div>
      <div id="satellite-build-options">
      </div>
    </div>

    <div id="fleet-tooltip-main">
      <div id="fleet-tooltip-header">
				<h1>Test</h1>
			</div>
      <div id="fleet-tooltip-options">
      </div>
    </div>

    <div id="outline-tooltip">

    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="../../../dist/js/bootstrap.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../../../assets/js/ie10-viewport-bug-workaround.js"></script>

    <script type="text/javascript" src="data.js"></script>

		<script>

    var q = d3_queue.queue();

		//var margin = {top: 20, right: 100, bottom: 30, left: 100},
    var margin = {top: 0, right: 0, bottom: 0, left: 0},
				width = $(window).width() - margin.left - margin.right,
				height = $(window).height() - margin.top - margin.bottom;

    var currentZoomLevel = 1;

		var randomX = d3.random.normal(width / 2, 80),
				randomY = d3.random.normal(height / 2, 80);
    /*var randomX = d3.randomUniform(width*0.25, width*0.75),
        randomY = d3.randomUniform(height*0.25, height*0.75);*/

    var planetData = [];
    var removePlanetNames = [];
    //var removePlanetNames = ["Kepler", "HD "];
    d3.csv("./planet-names.csv", function(data) {
      for (var i = 0; i < data.length; i++) {
        //console.log();
        var planetName = data[i]["pl_hostname"];
        var valid = true;
        for (var j = 0; j < removePlanetNames.length; j++) {
          valid = valid && !planetName.includes(removePlanetNames[j]);
        }
        if (valid) {
          planetData.push(data[i]);
        }
      }
      namePlanets();
      updateRender();
    });

    var starData = [];
    var removeStarNames = ["Hip", "BD+", "BD-"];
    var starSpectralClasses = ["O", "B", "A", "F", "G", "K", "M"];
    function determineStarType(stringy) {
      for (var i = 0; i < stringy.length; i++) {
        for (var j = 0; j < starSpectralClasses.length; j++) {
          if (stringy[i] === starSpectralClasses[j]) {
            return stringy[i];
          }
        }
      }
      return "U";
    }
    d3.csv("./stars-cut.csv", function(data) {
      //console.log(data);
      for (var i = 0; i < data.length; i++) {
        //console.log();
        var starName = data[i]["Display Name"];
        var valid = true;
        for (var j = 0; j < removeStarNames.length; j++) {
          valid = valid && !starName.includes(removeStarNames[j]);
        }
        //console.log(data[i]["Spectral Class"][0]);
        data[i]["Star Type"] = determineStarType(data[i]["Spectral Class"]);
        if (valid) {
          starData.push(data[i]);
        }
      }
      nameStars();
      updateRender();
    });

    var smallBodyData = [];
    d3.csv("./small-body.csv", function(data) {
      //console.log(data);
      for (var i = 0; i < data.length; i++) {
        //console.log();
        var smallBodyName = data[i]["name"];
        if (smallBodyName.length < 10) {
          if (smallBodyName !== null && smallBodyName !== "") {
            smallBodyData.push(data[i]);
          }
        }
      }
      nameAsteroids();
      initializeWorld();
      updateRender();
    });

    function createFleet(sector, name, position, owner, shipNames) {
      var ships = [];
      if (shipNames.length === 0) {
        return null;
      }
      for (var i = 0; i < shipNames.length; i++) {
        //console.log(shipNames[i] + " " + shipTypes[shipNames[i]] + " " + shipTypes["Destroyer"]);
        var prototypeShip = shipTypes[shipNames[i]];
        if (prototypeShip === null || prototypeShip === undefined) {
          prototypeShip = shipAliens[shipNames[i]];
        }
        /*
        ships.push({
          name: shipNames[i],
          owner: owner,
          strength: shipTypes[shipNames[i]].strength,
          health: shipTypes[shipNames[i]].maxHealth,
          maxHealth: shipTypes[shipNames[i]].maxHealth,
          action: shipTypes[shipNames[i]].action,
          ftl: shipTypes[shipNames[i]].ftl,
          maxFtl: shipTypes[shipNames[i]].maxFtl,
          speed: shipTypes[shipNames[i]].speed,
          maintenance: shipTypes[shipNames[i]].maintenance
        });
        */
        var clonedShip = Object.assign({}, prototypeShip);
        ships.push(clonedShip);
        clonedShip.health = clonedShip.maxHealth;
      }
      var theId = Object.keys(owner.fleets).length;
      var speed = ships[0].speed;
      for (var i = 0; i < ships.length; i++) {
        if (ships[i].speed < speed) {
          speed = ships[i].speed;
        }
      }
      var fleet = {
        sector: sector,
        position: position,
        owner: owner,
        name: name,
        ships: ships,
        id: theId,
        orders: [],
        speed: speed,
        inBattle: false,
        inRetreat: false
      }
      owner.fleets["Fleet" + theId] = fleet;
      for (var i = 0; i < fleet.ships.length; i++) {
        fleet.ships[i].owner = owner;
      }
      moveFleet(fleet, sector, position);
      return fleet;
    }

    function moveFleet(fleet, destSector, destPosition) {
      if (fleet.sector !== null) {
        var indexOfFleet = fleet.sector.fleets.indexOf(fleet);
        if (indexOfFleet !== -1) {
          fleet.sector.fleets.splice(indexOfFleet, 1);
        }
      }
      fleet.sector = destSector;
      fleet.position = destPosition;
      if (destSector !== null) {
        destSector.fleets.push(fleet);
      }
    }

    function removeFleet(fleet) {
      if (fleet.sector !== null) {
        var indexOfFleet = fleet.sector.fleets.indexOf(fleet);
        if (indexOfFleet !== -1) {
          fleet.sector.fleets.splice(indexOfFleet, 1);
        }
      }
      fleet.ships = [];
      fleet.sector = null;
    }

    /*
    Input arrayOfFleets in the form of an array containing multiple sets of fleets, e.g.
    [
      [civ1 fleet1, civ1 fleet2, ..., civ1 fleetN1],
      [civ2 fleet1, civ2 fleet2, ..., civ2 fleetN2],
      ...
      [civN fleet1, civN fleet2, ..., civN fleetN3],
    ]
    where each array is a different faction in the fight. This generalizes to fights that contain 3 or more teams.
    Also add planets if they are involved in the conflict (not necessarily as defenders).

    ships.push({
      name: shipNames[i],
      owner: owner,
      strength: shipTypes[shipNames[i]].strength,
      health: shipTypes[shipNames[i]].maxHealth,
      maxHealth: shipTypes[shipNames[i]].maxHealth,
      action: shipTypes[shipNames[i]].action,
      ftl: shipTypes[shipNames[i]].ftl,
      maxFtl: shipTypes[shipNames[i]].maxFtl,
      speed: shipTypes[shipNames[i]].speed,
      maintenance: shipTypes[shipNames[i]].maintenance
    });
    */
    function advanceFleetBattleOneDay(battle) {
      var arrayOfFleets = battle.arrayOfFleets;
      var ships = [];
      for (var i = 0; i < arrayOfFleets.length; i++) {
        var fleets = arrayOfFleets[i];
        ships.push([]);
        for (var j = 0; j < fleets.length; j++) {
          var fleet = fleets[j];
          for (var k = 0; k < fleet.ships.length; k++) {
            var ship = fleet.ships[k];
            ships[i].push(ship);
          }
        }
      }
      for (var i = 0; i < arrayOfFleets.length; i++) {
        var civShips = ships[i];
        var otherShips = [];
        for (var k = 0; k < arrayOfFleets.length; k++) {
          if (i === k) continue;
          for (var l = 0; l < ships[k].length; l++) {
            otherShips.push(ships[k][l]);
          }
        }
        for (var j = 0; j < civShips.length; j++) {
          for (var k = otherShips.length - 1; k >= 0; k--) {
            otherShips[k].health--;
          }
        }
      }
    }

    function startBattle(arrayOfFleets, sector, position) {
      var morale = [];
      for (var i = 0; i < arrayOfFleets.length; i++) {
        morale.push(100);
      }
      var battle = {
        fleets: arrayOfFleets,
        days: 0,
        sector: sector,
        position: position,
        morale: morale
      };
      battles.add(battle);

      for (var i = 0; i < arrayOfFleets.length; i++) {
        var fleets = arrayOfFleets[i];
        for (var j = 0; j < fleets.length; j++) {
          var fleet = fleets[j];
          fleet.inBattle = true;
        }
      }
    }

    function endBattle(battle) {
      for (var i = 0; i < arrayOfFleets.length; i++) {
        var fleets = arrayOfFleets[i];
        for (var j = 0; j < fleets.length; j++) {
          var fleet = fleets[j];
          fleet.inBattle = false;
          fleet.inRetreat = true;
        }
      }

      var index = battles.indexOf(battle);
      battle.fleets = [];
      battles.splice(index, 1);
    }

    /*function mergeFleets(fleets) {
      //var thisSector = {position: [d.x, d.y], star: randomStar, planets: [], fleets: []};
      var sectorsByPosition = {};
      var shipsBySector = {};
      for (var i = 0; i < fleets.length; i++) {
        var foundSector = false;
        for (var key in shipsBySector) {
          var dx = fleets.position[0] - key[0];
          var dy = fleets.position[1] - key[1];
          if (fleets.sector.position[0] === key[0] && fleets.sector.position[1] === key[1]) {
            foundSector = true;

            shipsBySector[key].push()
          }
        }

      }
    }*/

    //createFleet(sector, name, position, owner, shipNames)
    /*var fleet = {
      sector: sector,
      position: position,
      owner: owner,
      name: name,
      ships: ships,
      id: theId
    }*/
    function mergeFleet(fleets) {
      if (fleets === null) return;
      if (fleets.length === 0) return;
      var firstSector = fleets[0].sector, firstPosition = fleets[0].position;
      var firstOwner = fleets[0].owner; //, firstName = fleets[0].name;
      var theId = Object.keys(owner.fleets).length;
      var newFleet = {
        sector: fleets[0].sector,
        position: fleets[0].position,
        owner: fleets[0].owner,
        name: fleets[0].name,
        ships: [],
        id: theId
      }
      var shipNames = [];
      for (var i = 0; i < fleets.length; i++) {
        if (fleets[i].sector === firstSector && fleets[i].owner.civId === firstOwner.civId) {
          for (var j = 0; j < fleets[i].ships; j++) {
            newFleet.ships.push(fleets[i].ships[j]);
          }
          removeFleet(fleets[i]);
        }
      }
      owner.fleets["Fleet" + theId] = fleet;
      for (var i = 0; i < fleet.ships.length; i++) {
        fleet.ships[i].owner = owner;
      }
      moveFleet(fleet, firstSector, firstPosition);
    }

    function calcFleetStrength(fleet) {
      var strength = 0;
      for (var i = 0; i < fleet.ships.length; i++) {
        var ship = fleet.ships[i];
        strength += ship.strength;
      }
      return strength;
    }

    function checkIfValidSatellite(planet, satellite, builder) {
      var result = true;
      /*
      if (builder === null) {
        return false;
      }
      */
      if (satellite.biomeRestrict !== null) {
        if (satellite.biomeRestrict === "NotAsteroid") {
          result = result && (planet.biome !== "Asteroid");
        }
      }
      if (builder != null) {
        //result = result && (builder.techLevel >= impr.techLevelRestrictMin && builder.techLevel <= impr.techLevelRestrictMax);
        if (impr.specResRestrict !== null && impr.specResRestrict !== undefined) {
          result = result && (impr.specResRestrict in builder.specialResourcesFlow);
        }
        if (impr.techRestrict !== null) {
          result = result && (impr.techRestrict in builder.techsResearched);
        }
      }
      return result;
    }

    function getValidSatellites(planet, builder) {
      var results = [];
      for (var i = 0; i < planetSatellites.length; i++) {
        var satellite = planetSatellites[i];
        if (checkIfValidSatellite(planet, satellite, builder)) {
          results.push(satellite);
        }
      }
      return results;
    }

		function checkIfValidImprovement(tile, impr, builder) {
      if (impr.name === "Colony") {
        return false;
      }
			var result = true;
			if (impr.biomeRestrict !== null) {
				if (impr.biomeRestrict === "Arable") {
					result = result && (tile.localBiome === "Savanna" || tile.localBiome === "Grassland" || tile.localBiome === "Forest" || tile.localBiome === "Rainforest");
				}
        else if (impr.biomeRestrict === "NotToxic") {
          result = result && (tile.localBiome !== "Toxic");
        }
				else {
					result = result && (impr.biomeRestrict === tile.localBiome);
				}
			}
			if (impr.terrainRestrict !== null) {
				if (impr.terrainRestrict === "Land") {
					result = result && (tile.localTerrain !== "Ocean");
				}
				else if (impr.terrainRestrict === "Sea") {
					result = result && (tile.localTerrain === "Ocean");
				}
        else {
					result = result && (impr.terrainRestrict === tile.localTerrain);
				}
			}
      if (impr.buildingRestrict !== null) {
        if (tile.building == null) {
          result = false;
        }
        else {
          result = result && (tile.building.name === impr.buildingRestrict);
        }
      }
      if (builder != null) {
        result = result && (builder.techLevel >= impr.techLevelRestrictMin && builder.techLevel <= impr.techLevelRestrictMax);
        if (impr.specResRestrict !== null && impr.specResRestrict !== undefined) {
          result = result && (impr.specResRestrict in builder.specialResourcesFlow);
        }
        if (impr.techRestrict !== null && impr.techRestrict !== undefined) {
          result = result && (impr.techRestrict in builder.techsResearched);
        }
      }
			return result;
		}

		function getValidImprovements(tile, builder) {
			var result = [];
			for (var i = 0; i < tileImprovements.length; i++) {
				var impr = tileImprovements[i];
        if (tile.building !== null) {
          if (impr.name === tile.building.name) {
            continue;
          }
        }
				if (checkIfValidImprovement(tile, impr, builder)) {
					result.push(impr);
				}
			}
			return result;
		}

    function getValidSpaceportQueue(spaceport) {
      var result = [];
      var shipNames = Object.keys(shipTypes);
      for (var i = 0; i < shipNames.length; i++) {
        var ship = shipTypes[shipNames[i]];
        if (spaceport.planet.owner != null) {
          //result = result && (builder.techLevel >= impr.techLevelRestrictMin && builder.techLevel <= impr.techLevelRestrictMax);
          if (ship.specResRestrict !== null && ship.specResRestrict !== undefined) {
            result = result && (ship.specResRestrict in builder.specialResourcesFlow);
          }
          if (ship.techRestrict !== null) {
            result = result && (ship.techRestrict in builder.techsResearched);
          }
        }
        result.push(ship);
      }
      return result;
    }

    function calculateAssignment(tiles, population, weights=[2,1,4,1,1,1]) {
      var scores = {};
      for (var i = 0; i < tiles.length; i++) {
        var res = tiles[i].baseResources;
        scores[i] = 0;
        for (var j = 0; j < res.length; j++) {
          scores[i] += res[j] * weights[j];
        }
        if (tiles[i].building !== null) {
          var out = tiles[i].building.output;
          for (var j = 0; j < out.length; j++) {
            scores[i] += out[j] * weights[j];
          }
        }
      }
      var sorted = Object.keys(scores).sort(function(a, b) {
        return scores[b] - scores[a];
      });
      var result = [];
      for (var i = 0; i < population; i++) {
        result.push(sorted[i]);
      }
      return result;
    }
    function calculateAssignmentPlanet(planet, weights=[2,1,4,1,1,1]) {
      return calculateAssignment(planet.tiles, planet.population, weights);
    }

    function calcTileToBuildOn(tiles, builder, weights=[2,1,4,1,1,1], overwriteBuilding=false) {
      var scores = {};
      for (var i = 0; i < tiles.length; i++) {
        if (!overwriteBuilding && tiles[i].building !== null) {
          scores[i] = -1000;
          continue;
        }
        var validImpr = getValidImprovements(tile, builder);
        if (validImpr.length === 0) {
          scores[i] = -1000;
          continue;
        }
        var res = tiles[i].baseResources;
        scores[i] = 0;
        for (var j = 0; j < res.length; j++) {
          scores[i] += res[j] * weights[j];
        }
      }
      var sorted = d3.entries(scores).sort(function(a, b) { return b.value - a.value; });
      return sorted[0].key;
    }

    function calcImprToBuild(tile, builder, weights=[2,1,4,1,1,1]) {
      var scores = {};
      var validImpr = getValidImprovements(tile, builder);
      if (validImpr.length === 0) return null;
      for (var i = 0; i < validImpr.length; i++) {
        var impr = validImpr[i];
        scores[impr.name] = 0;
        for (var j = 0; j < impr.output.length; j++) {
          scores[impr.name] += impr.output[j] * weights[j];
        }
      }
      var max = d3.entries(scores).sort(function(a, b) { return b.value - a.value; });
      return max[0].key;
    }

    for (var i = 0; i < numStars; i++) {
      //var position = [randomX(), randomY()];
      var star = {
				position: position,
				name: "",
				size: size,
        type: "",
				owner: null
			};
      stars.push(star);
			//stars[position] = star;
    }

    /*
    biomeAbbrs["Gaia"] = "G";
    biomeAbbrs["Toxic"] = "Tx";
    biomeAbbrs["Ice Cream"] = "IC";
    biomeAbbrs["Barren"] = "B";
    biomeAbbrs["Gas Giant"] = "GG";
    biomeAbbrs["Primordial"] = "P";
    biomeAbbrs["Asteroid"] = "x";
    */

    var planetPositionsByBiome = {};

    for (var i = 0; i < numMajorCivs; i++) {
      var color = d3.scale.linear()
        .domain([0, 20])
        .range(["white", civColors[i % civColors.length]])
        .interpolate(d3.interpolateLab);
      var civType = "PostInformation";
      var rand = Math.random();
      if (rand < 0.333) {
        planetPreference = temperatePreference;
      }
      else if (rand < 0.666) {
        planetPreference = coldPreference;
      }
      else {
        planetPreference = hotPreference;
      }
      civEthics = [ethics[Math.trunc(Math.random()*ethics.length)]];
      var civilization = {
        name: "Civilization" + i,
        speciesName: "Human" + i,
        id: i,
        civType: civType,
        planetPreference: planetPreference,
        ethics: civEthics,
        speciesMods: [],
        techLevel: 4,
        techsResearched: {},
        techResearchingStar: null,
        techResearchingSociety: null,
        techResearchingProduction: null,
        techChoicesNum: 4,
        techChoicesStar: [],
        techChoicesSociety: [],
        techChoicesProduction: [],
        desc: civTypeDesc[civType],
        color: color,
        worlds: [],
        fleets: {},
        baseResources: [150, 50, 50, 0, 0, 0],
        baseResourcesFlow: {},
        specialResourcesFlow: {},
        relations: {}, //Modifiers that affect my opinion of others
        relationStats: {}, //My opinion of others
        exploredSectorPositions: {}
      };
      civilizations.push(civilization);
    }

    for (var i = 0; i < numMinorCivs; i++) {
      var color = d3.scale.linear()
        .domain([0, 20])
        .range(["white", civColors[i % civColors.length]])
        .interpolate(d3.interpolateLab);
      var techLevel = Math.trunc(Math.random()*4);
      var civType = civTypes[techLevel];
      var rand = Math.random();
      if (rand < 0.333) {
        planetPreference = temperatePreference;
      }
      else if (rand < 0.666) {
        planetPreference = coldPreference;
      }
      else {
        planetPreference = hotPreference;
      }
      var civilization = {
        name: "Civilization" + i,
        speciesName: "Human" + (i + numMajorCivs),
        id: i,
        civType: civType,
        planetPreference: planetPreference,
        ethics: [exampleEthic],
        speciesMods: [],
        techLevel: techLevel,
        techsResearched: {},
        techResearchingStar: null,
        techResearchingSociety: null,
        techResearchingProduction: null,
        techChoicesNum: 4,
        techChoicesStar: [],
        techChoicesSociety: [],
        techChoicesProduction: [],
        desc: civTypeDesc[civType],
        color: color,
        worlds: [],
        fleets: {},
        baseResources: [150, 0, 50, 0, 0, 0],
        baseResourcesFlow: [0, 0, 0, 0, 0, 0], //For GUI purposes
        specialResourcesFlow: {},
        relations: {}, //Modifiers that affect my opinion of others
        relationStats: {}, //My opinion of others
        exploredSectorPositions: {}
      };
      civilizations.push(civilization);
    }

    var color = d3.scale.linear()
      .domain([0, 20])
      .range(["white", "green"])
      .interpolate(d3.interpolateLab);
    var aliens = {
      name: "Aliens",
      speciesName: "Aliens",
      id: (numMajorCivs + numMinorCivs),
      civType: "Information",
      planetPreference: null,
      ethics: [],
      speciesMods: [],
      techLevel: 0,
      techsResearched: {},
      techResearchingStar: null,
      techResearchingSociety: null,
      techResearchingProduction: null,
      techChoicesNum: 0,
      techChoicesStar: [],
      techChoicesSociety: [],
      techChoicesProduction: [],
      desc: "Star wanderers, stateless nomads, pirates and vigilantes, and ancient space life.",
      color: color,
      worlds: [],
      fleets: {},
      baseResources: [0, 0, 0, 0, 0, 0],
      baseResourcesFlow: [0, 0, 0, 0, 0, 0], //For GUI purposes
      specialResourcesFlow: {},
      relations: {}, //Modifiers that affect my opinion of others
      relationStats: {}, //My opinion of others
      exploredSectorPositions: {}
    };
    civilizations.push(aliens);

    var playerCiv = civilizations[0];

    for (var i = 0; i < biomes.length; i++) {
      temperatePreference[biomes[i][0]] = temperatePreferenceNum[i];
      coldPreference[biomes[i][0]] = coldPreferenceNum[i];
      hotPreference[biomes[i][0]] = hotPreferenceNum[i];
      planetPositionsByBiome[biomes[i][0]] = [];
    }

    function normalize(arr) {
      var sum = 0;
      for (var i = 0; i < arr.length; i++) {
        sum += arr[i];
      }
      var result = [];
      for (var i = 0; i < arr.length; i++) {
        result.push(arr[i] / sum);
      }
      return result;
    }

    biomeChances = normalize(biomeChances);

		for (var i = 0; i < numPlanets + numAsteroids; i++) {
			var size = 0;
			var type = "", typeAbbr = "";
      //var habitability = 0;

			var rand = Math.random();

			if (rand < 0.3) {
				size = small();
			}
			else if (rand < 0.7) {
				size = medium();
			}
			else {
				size = large();
			}
			size = Math.round(size);
			if (size > maxTiles) {
				size = maxTiles;
			}

      var baseResources = [];

      if (i < numPlanets) {
  			var rand2 = Math.random();
  			var sum = 0;
        for (var j = 0; j < biomeChances.length; j++) {
          sum += biomeChances[j];
          if (rand < sum) {
            var biomeChoice = biomes[j];
            type = biomeChoice[0];
            typeAbbr = biomeChoice[1];
            //habitability = biomeChoice[2];
            break;
          }
        }
      }
      else {
        type = "Asteroid";
        typeAbbr = "x";
        size = 0;
        //habitability = 0;
      }

      var rand3 = Math.random();
      if (rand3 < 0.7) {
        baseResources = [0, 0, 0, 0, 0, 0];
      }
      else if (rand3 < 0.85) {
        var amount = Math.round(Math.random()*4);
        var rand4 = Math.random();
        if (rand4 < 0.33) {
          baseResources = [amount, 0, 0, 0, 0, 0];
        }
        else if (rand4 < 0.66) {
          baseResources = [0, amount + 1, 0, 0, 0, 0];
        }
        else {
          baseResources = [Math.round(amount/2), Math.round(amount/2 + 1), 0, 0, 0, 0];
        }
      }
      else if (rand3 < 0.90) {
        baseResources = [Math.round(Math.random()*4), Math.round(Math.random()*4), 0, 0, 0, 0];
      }
      else {
        var amount = Math.round(Math.random()*3);
        var rand4 = Math.random(), rand5 = Math.random();
        if (rand4 < 0.33) {
          baseResources = [0, 0, 0, amount, 0, 0];
        }
        else if (rand4 < 0.66) {
          baseResources = [0, 0, 0, 0, amount, 0];
        }
        else {
          baseResources = [0, 0, 0, 0, 0, amount];
        }
        if (rand5 < 0.2) {
          var amount2 = Math.round(Math.random()*2);
          var rand6 = Math.random();
          if (rand6 < 0.33) {
            baseResources[3] += amount2;
          }
          else if (rand6 < 0.66) {
            baseResources[4] += amount2;
          }
          else {
            baseResources[5] += amount2;
          }
        }
      }

			var tiles = [];
			for (var j = 0; j < size; j++) {
				var rand = Math.round(Math.random() * (tileStarts.length - 1));
				var tileStart = tileStarts[rand];
				var biome = Math.round(Math.random() * (tileBiomes.length - 1));
				var terrain = Math.round(Math.random() * (tileTerrains.length - 1));
				//console.log(tileStart);
				var tile = {
					building: null,
					localBiome: tileBiomes[biome],
					localTerrain: tileTerrains[terrain],
          /*
					minerals: tileStart[0],
					energy: tileStart[1],
					food: tileStart[2],
          */
          worker: null,
          baseResources: tileStart,
          order: null
				};
				tiles.push(tile);
			}

			var position = [randomX(), randomY()];

			var planet = {
				position: position,
        sector: null,
				name: "",
        star: "",
				size: size,
				biome: type,
        biomeAbbr: typeAbbr,
        //habitability: habitability,
				owner: null,
				tiles: tiles,
        tileAssignments: [],
        satelliteBuilding: null,
        population: 0,
				food: 0,
        baseResources: baseResources,
        specialResourcesFlow: {},
        planetModifiers: [examplePlanetMod],
        order: null
			};
			planets[position] = planet;
      planetPositionsByBiome[type].push(position);
		}

    //TODO: Add colonization mechanics
    /*
    Add civilizations ranging from primordial, to neolithic, to industrial, and name the post-information nations and make them unique.
    Make colonizable planets more unique and rare and valuable
    Add interactions between civilizations including attitudes, treatments, and combat

    Also add technologies to game and research point resources
    */

    /*
		for (var i = 0; i < numPlanets + numAsteroids; i++) {
			var randPlanet = Math.round(d3.randomUniform(0, planetPositions.length - 1)());
			var randCiv = Math.round(d3.randomUniform(0, civilizations.length - 1)());
      //var planet = planets[planetPositions[randPlanet]];
      var planet = planets[planetPositions[i]];
      if (planet.biome === "Asteroid") {
        planet.owner = null;
        planet.population = 0;
      }
      else {
        if (Math.random() < 0.1) {
          civilizations[randCiv].worlds.push(planet);
    			planet.owner = civilizations[randCiv];
          planet.population = 3;
          var spaceport = planetSatellites[0];
          planet.satelliteBuilding = jQuery.extend({}, spaceport);
          planet.satelliteBuilding.planet = planet;
          buildImprOnTileByName(planet.position, Math.trunc(Math.random()*planet.size), "Colony");
          //moveFleet(fleet, destSector, destPosition);
        }
      }
      //planets[planetPositions[i]].owner = civilizations[randCiv];
		}*/

		var color = d3.scale.linear()
				.domain([0, 20])
				.range(["white", "white"])
				.interpolate(d3.interpolateLab);

    var testColor = d3.scale.linear()
				.domain([0, 20])
				.range(["white", "red"])
				.interpolate(d3.interpolateLab);

		var hexbin = d3.hexbin()
				.size([width, height])
				.radius(sectorRadius);

		var x = d3.scale.identity()
				.domain([0, width]);

		var y = d3.scale.linear()
				.domain([0, height])
				.range([height, 0]);

		var planetTooltip = d3.select("#planet-tooltip");
		var planetTooltipHeader = d3.select("#planet-tooltip-header");

    var systemTooltip = d3.select("#system-tooltip-main");
    var systemTooltipHeader = d3.select("#system-tooltip-header");
    var systemStarMap = d3.select("#system-tooltip-starmap");
    var systemTooltipVisible = false;

    var fleetTooltip = d3.select("#fleet-tooltip-main");
    var fleetTooltipVisible = false, planetTooltipVisible = false;

    var planetBuildTooltip = d3.select("#planet-build-main");
    var spaceportBuildTooltip = d3.select("#spaceport-build-main");
    var satelliteBuildTooltip = d3.select("#satellite-build-main");

    var timeTooltip = d3.select("#player-hud-time");

    var outlineTooltip = d3.select("#outline-tooltip");

    var activeMenuBarTooltip = null;

    var messageTooltip = d3.select("#message-tooltip");

    var empireMenu = d3.select("#empire-menu");

    var techMenu = d3.select("#tech-menu");
    var techStarMenu = d3.select("#tech-star-display");
    var techSocietyMenu = d3.select("#tech-society-display");
    var techProductionMenu = d3.select("#tech-production-display");

    var diplomacyMenu = d3.select("#diplomacy-menu");
    var contactMenu = d3.select("#contact-menu");

    var foodNeededToGrow = 50;

		function hideTooltip() {
			planetTooltip.transition()
				.duration(200)
				.style("opacity", 0);
			//planetTooltip.style("left", "0px")
				//.style("top", "2000px");
      systemTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      fleetTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      planetTooltip.style("pointer-events", "none");
      systemTooltip.style("pointer-events", "none");
      fleetTooltip.style("pointer-events", "none");

      systemTooltipVisible = false;
      planetTooltipVisible = false;
      fleetTooltipVisible = false;

      //var buildMenu = d3.select("#planet-build-main");
      planetBuildTooltip.style("pointer-events", "none");
      planetBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      spaceportBuildTooltip.style("pointer-events", "none");
      spaceportBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      satelliteBuildTooltip.style("pointer-events", "none");
      satelliteBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      currentPlanetSelected = null;
      currentFleetSelected = null;
      currentSectorSelected = null;
      currentSpaceportSelected = null;
		}

    function hideMenuBarTooltips() {
      var menusToHide = [empireMenu, techMenu, diplomacyMenu, contactMenu];
      for (var i = 0; i < menusToHide.length; i++) {
        menusToHide[i].style("pointer-events", "none");
        menusToHide[i].transition()
          .duration(200)
          .style("opacity", 0);
      }
      console.log("done");
    }

    var starMapSvg = systemStarMap.append("svg")
        .attr("width", $("#system-tooltip-starmap").width)
        .attr("height", $("#system-tooltip-starmap").height)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		var svg = d3.select("body").append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", Math.max(720, height + margin.top + margin.bottom))
        .style("overflow", "visible")
			.append("g")
        .call(d3.behavior.zoom().scaleExtent([1, 8]).on("zoom", zoom))
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
      .append("g");

    function zoom() {
      svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
      currentZoomLevel = d3.event.scale;
      //console.log("Zoom");
      //d3.event.preventDefault();
      //d3.event.stopPropagation();
      /*
      executeAsync(function() {
        updateGalaxyMap();
      });
      */
    }

    /*
		svg.append("clipPath")
				.attr("id", "clip")
			.append("rect")
				.attr("class", "mesh")
				.attr("width", width)
				.attr("height", 720);
    */

    var usedStars = {};

    var starMapCircleMarkers = [];

    var blackColor = d3.scale.linear()
        .domain([0, 20])
        .range(["white", "black"])
        .interpolate(d3.interpolateLab);

    //svg.classed("svg-container", true);
		svg.append("g") //.attr("clip-path", "url(#clip)")
			.selectAll(".hexagon")
				.data(hexbin(planets))
			.enter().append("path")
				.attr("class", "hexagon")
				.attr("d", hexbin.hexagon())
				.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
        .attr("data-planetposition", function(d) {return d.x + "," + d.y;})
        .style("stroke", "lightsteelblue")
				.style("fill", function(d) {
					var returnColor = null;
          //console.log("-----");
          var index = Math.round(Math.random()*(stars.length - 1));
          /*while (true) {
            index = Math.round(Math.random()*(stars.length - 1));
            if (usedStars[index] == false) {
              usedStars[index] = true;
              break;
            }
          }*/

          var randomStar = stars[index];
          var thisSector = {position: [d.x, d.y], posX: d.x, posY: d.y, owner: null, star: randomStar, planets: [], fleets: [], neighborPositions: []};
					d.forEach(function(element) {
						//console.log(planets[element]);
            //console.log(element);
            thisSector.planets.push(element);
						var planet = planets[element];
            planet.sector = thisSector;
						if (planet.owner === null) {

						}
						else {
              if (returnColor === null) { //No other civs have been found in this system
                returnColor = planet.owner.color(d.length);
              }
              else { //The system is contested
                returnColor = blackColor(10);
              }
						}
					});
          sectors[[d.x, d.y]] = thisSector;
          if (returnColor === null) {
            returnColor = color(5);
          }
					return returnColor;
				}).on("click", function(d) {
          if (d3.event.defaultPrevented) return;

					d3.event.preventDefault();

          //console.log("click " + systemTooltipVisible);

          if (currentFleetSelected !== null) {
            queueShipOrdersToSector(currentFleetSelected, sectors[[d.x, d.y]]);
            displayFleet(currentFleetSelected);
            return;
          }

          systemTooltipVisible = !systemTooltipVisible;
          if (!systemTooltipVisible) { //Close the tooltip if it's open, don't open another tooltip for another system
            hideTooltip();
            return;
          }

          var sector = sectors[[d.x, d.y]];
          currentSectorSelected = sector;

          planetTooltip.style("pointer-events", "none");
          systemTooltip.style("pointer-events", "auto");

          displaySector(sector);

				}).on("contextmenu", function(data, index) {
          //if (d3.event.defaultPrevented) return;
					d3.event.preventDefault();
					hideTooltip();

				}).on("mouseover", function() {

				});

    systemStarMap.on("click", function() {
      d3.event.preventDefault();
      d3.event.stopPropagation();
    });

    systemStarMap.on("contextmenu", function() {
      d3.event.preventDefault();

      var click = d3.mouse(this);
      var width = $("#system-tooltip-starmap").width();
      var height = $("#system-tooltip-main").height()*0.8;

      //console.log(click + " " + $("#system-tooltip-starmap").width() + " " + ($("#system-tooltip-main").height()*0.8));
      if (currentFleetSelected !== null) { //Selected fleet can do an action on the planet like building a new satellite
        d3.event.stopPropagation(); //Do not click the body. Events propagate up the hierachy.
        var temp = d3.event.target;

        //console.log(temp);
        //console.log(temp.dataset["planetposition"]);

        var percentX = click[0] / width * 2 - 1;
        var percentY = click[1] / height * 2 - 1;
        //console.log(percentX + " " + percentY);
        var destSector = currentSectorSelected;
        var newPosition = [destSector.position[0] + sectorRadius * percentX, destSector.position[1] + sectorRadius * percentY];

        var noActionsFound = false;
        if (temp.src.includes("planet_")) { //Also includes asteroids
          var actions = [];
          for (var i = 0; i < fleet.ships.length; i++) {
            if (fleet.ships[i].action !== null && fleet.ships[i].action !== undefined) {
              actions.push(fleet.ships[i].action);
            }
          }
          if (actions.length > 0) {
            var trueX = click[0] / width;
            var trueY = click[1] / height;
            var actionsTooltip = d3.select("#system-action-menu");
            actionsTooltip.transition()
              .duration(200)
              .style("opacity", .9)
              .style("pointer-events", "auto");
            actionsTooltip.html("")
              .style("left", Math.round(trueX*100) + "%")
              .style("top", Math.round(trueY*100) + "%");
            var menuString = "";
            for (var i = 0; i < actions.length; i++) {
              menuString += "<p>" +
              "<button type=\"button\" class=\"tile-build-button\" " +
              "onclick=\"javascript:requestActionOnPlanet([" + temp.dataset["planetposition"] + "], " + currentFleetSelected.id + ", &quot;" + actions[i] + "&quot;); " +
              "javascript:hideActionMenu(); " +
              "javascript:displayPlanetFromCoord([" + temp.dataset["planetposition"] + "]); \"" +
              "style=\"max-height:50px; max-width:300px; width:100%; position:relative; z-index:" + i + ";\">" + actions[i] + "</button>" +
              "</p>";
            }
            actionsTooltip.html(menuString);
          }
          else {
            noActionsFound = true;
          }
        }
        if (!temp.src.includes("planet_") || noActionsFound) {
          if (currentFleetSelected.sector === currentSectorSelected) {
            //console.log("Success");
            //Move a ship within the same sector by an order
            var order = {
              orderType: "MoveWithinSector",
              fleet: currentFleetSelected,
              destination: newPosition,
              desc: "Cruise in " + destSector.star.name
            };
            currentFleetSelected.orders = [order];
            moveWithinSectorOrders.push(currentFleetSelected);
          }
          else {
            //Create an order to move a ship from its sector to the current sector selected
            //Move the same ship within the sector through an order as above
            queueShipOrdersToSector(currentFleetSelected, currentSectorSelected, newPosition);
          }
        }

        displayFleet(currentFleetSelected);
      }
    });

    /*
    svg.append("defs")
    .append("pattern")
    .attr("id", "venus")
    .attr('patternUnits', 'userSpaceOnUse')
    .attr("width", max.x)
    .attr("height", max.y)
    .append("image")
    .attr("xlink:href", imgUrl)
    .attr("width", max.x)
    .attr("height", max.y);

svg.append("rect")
    .attr("x", "0")
    .attr("y", "0")
    .attr("width", max.x)
    .attr("height", max.y)
    .attr("fill", "url(#venus)");
  */

    systemTooltip.on("click", function() {
      d3.event.preventDefault();
    });

    messageTooltip.on("contextmenu", function() {
      d3.event.preventDefault();
      d3.event.stopPropagation();
      messageTooltip.style("pointer-events", "none");
      messageTooltip.transition()
        .duration(200)
        .style("opacity", 0);
    });

    d3.select("#system-tooltip-main").on("click", function() {
      d3.event.preventDefault();
    });

		//d3.select("body").style("background-color", "#326EFF");
    d3.select("body").style("background-color", "#333333");

    d3.select("body").on("contextmenu", function() {
			d3.event.preventDefault();
			hideTooltip();
      hideMenuBarTooltips();
		});

    fleetTooltip.on("contextmenu", function() {
      d3.event.preventDefault();
      fleetTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      fleetTooltip.style("pointer-events", "none");
      fleetTooltipVisible = false;
    });

    techMenu.on("contextmenu", function() {
      d3.event.preventDefault();
      d3.event.stopPropagation();
      hideMenuBarTooltips();
    });

    planetBuildTooltip.on("contextmenu", function() {
      d3.event.preventDefault();
      d3.event.stopPropagation();
      planetBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      planetBuildTooltip.style("pointer-events", "none");
    });

    spaceportBuildTooltip.on("contextmenu", function() {
      d3.event.preventDefault();
      d3.event.stopPropagation();
      spaceportBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      spaceportBuildTooltip.style("pointer-events", "none");
    });

    satelliteBuildTooltip.on("contextmenu", function() {
      d3.event.preventDefault();
      d3.event.stopPropagation();
      satelliteBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      satelliteBuildTooltip.style("pointer-events", "none");
    });

    //An O(N^2) squared method but it can be applied and generalized to any shape
    for (var pos in sectors) {
      var thisSector = sectors[pos];
      for (var pos2 in sectors) {
        if (pos == pos2) continue;
        //console.log(">>>>" + typeof pos + " " + typeof pos2);
        //pos = pos.split(",");
        //pos2 = pos2.split(",");
        /*var split = pos.split(",");
        var split2 = pos2.split(",");
        var dx = (+split[0]) - (+split2[0]), dy = (+split[1]) - (+split2[1]);*/
        var otherSector = sectors[pos2];
        var dx = thisSector.posX - otherSector.posX, dy = thisSector.posY - otherSector.posY;
        var dist = Math.sqrt(dx*dx + dy*dy);
        //console.log(split + " " + split2 + " " + dx + " " + dy + " " + dist);
        if (dist < 20) {
          thisSector.neighborPositions.push(pos2);
          //console.log("Success: " + dx + " " + dy + " " + dist);
        }
      }
    }

    var planetPositions = Object.keys(planets);
    for (var i = 0; i < civilizations.length - 1; i++) {
      var randPlanet = null, planet = null;
      while (true) {
        randPlanet = Math.round(d3.randomUniform(0, planetPositions.length - 1)());
        planet = planets[planetPositions[randPlanet]];
        //console.log(planet.size + " " + habitability + " " + planet.sector.owner);
        var habitability = civilizations[i].planetPreference[planet.biome];
        if (planet.size > 14 && planet.biome !== "Asteroid" && planet.sector.owner === null && habitability >= 0.6) { //Use sector as temporary variable to show ownership
          break;
        }
      }
      civilizations[i].worlds.push(planet);
      planet.owner = civilizations[i];
      planet.sector.owner = civilizations[i];
      civilizations[i].exploredSectorPositions[planet.sector.position] = true;
      //planet.sector = civilizations[i];
      if (civilizations[i].civType === "PostInformation") {
        planet.population = 7;
        var spaceport = planetSatellites[0];
        planet.satelliteBuilding = jQuery.extend({}, spaceport);
        planet.satelliteBuilding.planet = planet;
        buildImprOnTileByName(planet.position, Math.trunc(Math.random()*planet.size), "Colony");
        for (var j = 0; j < 5; j++) {
          var tileIndex = calcTileToBuildOn(planet.tiles, planet.owner, [1,4,2,1,1,1]);
          var tile = planet.tiles[tileIndex];
          var imprName = calcImprToBuild(tile, planet.owner);
          if (imprName !== null) {
            buildImprOnTileByName(planet.position, tileIndex, imprName);
          }
        }
      }
      else {
        planet.population = 4;
        if (civilizations[i].civType === "Neolithic" || civilizations[i].civType === "Modern" || civilizations[i].civType === "Information") {
          buildImprOnTileByName(planet.position, Math.trunc(Math.random()*planet.size), "Primitive City");
          for (var j = 0; j < 3; j++) {
            buildImprOnTileByName(planet.position, Math.trunc(Math.random()*planet.size), "Primitive Farm");
          }
        }
      }

      var workers = [];
      for (var j = 0; j < planet.population; j++) {
        workers.push({
          speciesName: civilizations[i].speciesName,
          ethics: civilizations[i].ethics.slice(0)
        });
      }

      var assignment = calculateAssignment(planet.tiles, planet.population, [2,2,2,1,1,1]);
      for (var j = 0; j < assignment.length; j++) {
        planet.tiles[assignment[j]].worker = workers[j];
      }

      //moveFleet(fleet, destSector, destPosition);
    }

    /*
    var xSet = new Set(), ySet = new Set();
    var minX = 0, maxX = 0, minY = 0, maxY = 0;
    for (var key in sectors) {
      //console.log(key);
      var rawPos = sectors[key].position;
      var pos = [Math.trunc(rawPos[0]), Math.trunc(rawPos[1])];
      if (minX === 0 && minY === 0) {
        minX = pos[0]; maxX = pos[0];
        minY = pos[1]; maxY = pos[1];
        continue;
      }
      xSet.add(pos[0]); //ySet.add(pos[1]);
      if (pos[0] < minX) minX = pos[0];
      else if (pos[0] > maxX) maxX = pos[0];
      if (pos[1] < minY) minY = pos[1];
      else if (pos[1] > maxY) maxY = pos[1];
    }
    var temp = Array.from(xSet).sort();
    console.log(temp);
    */
    //console.log(minX + " " + maxX);

    //hexagons.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })

    var black = d3.scale.linear()
      .domain([0, 20])
      .range(["black", "black"])
      .interpolate(d3.interpolateLab);

    function updateGalaxyMap() {
      d3.selectAll(".hexagon")
          .data(hexbin(planets))
          .style("fill", function(d) {
            var returnColor = null;
            var sector = sectors[[d.x, d.y]];
            if (!([d.x, d.y] in playerCiv.exploredSectorPositions)) {
              return black(5);
            }
            d.forEach(function(element) {
              var planet = planets[element];
              if (planet.owner === null) {

              }
              else {
                if (returnColor === null) { //No other civs have been found in this system
                  returnColor = planet.owner.color(d.length);
                }
                else { //The system is contested
                  returnColor = blackColor(10);
                }
              }
            });
            if (returnColor === null) {
              returnColor = color(5);
            }
            return returnColor;
          })
          .style("stroke", function(d) {
            var sector = sectors[[d.x, d.y]];
            if (currentSectorSelected === sector) {
              return "red";
            }
            if (currentPlanetSelected !== null) {
              if (currentPlanetSelected.sector === sector) {
                return "red";
              }
            }
            if (currentFleetSelected !== null) {
              if (currentFleetSelected.sector === sector) {
                return "red";
              }
            }
            return "none";
          });

        if (currentZoomLevel >= 4) {
          d3.selectAll(".hexagon")
            .data(hexbin(planets))
            .attr("x", function(d) {
              return d.x;
            })
            .attr("y", function(d) {
              svg.append("svg:image")
                .attr("x", d.x - sectorRadius)
                .attr("y", d.y - sectorRadius)
                .attr('width', sectorRadius*2)
                .attr('height', sectorRadius*2)
                .attr("xlink:href","images/population.png")
                .style("opacity", 0.5)
                .style("pointer-events", "none");
              return d.y;
            });
        }

      /*
      var hexes = d3.selectAll(".hexagon")[0];
      console.log(hexes);
      for (var i = 0; i < hexes.length; i++) {
        var hex = hexes[i];
        //console.log(hex);
        //hex.attr("src", "yes");

        hex.append("svg:image")
         .attr('x',9)
         .attr('y',12)
         .attr('width', 20)
         .attr('height', 24)
         .attr("xlink:href","images/population.png");

      }
      */

    }

    /*
    function updateGalaxyMapCallback(callback) {
      setTimeout(function() {
        updateGalaxyMap();
        callback(null);
      }, 1);
    }
    */

    function executeAsync(func) {
      setTimeout(func, 0)
    }

    updateGalaxyMap();

    /*
    console.log(	d3.selectAll(".hexagon").style("fill", function() {return testColor(10);}));
    console.log(d3.selectAll(".hexagon"));

    var hexes = d3.selectAll(".hexagon")[0];
    for (var i = 0; i < hexes.length; i++) {
      console.log(hexes[i]["__data__"]);
      console.log(Object.keys(hexes[i]));
    }
    */
      /*
				.style("fill", function() {
					var returnColor = null;

					d.forEach(function(element) {
						if (planet.owner === null) {

						}
						else {
              if (returnColor === null) { //No other civs have been found in this system
                returnColor = planet.owner.color(d.length);
              }
              else { //The system is contested
                returnColor = blackColor(10);
              }
						}
					});
          if (returnColor === null) {
            returnColor = color(5);
          }
					return returnColor;
				});*/

    //for (var pos in sectors) {
      //console.log(sectors[pos].neighborPositions.length);
    //}

    function displaySector(sector) {
      while (starMapCircleMarkers.length > 0) {
        var circle = starMapCircleMarkers.pop();
        circle.remove();
      }
      /*planetTooltip.transition()
        .duration(200)
        .style("opacity", 0.9);*/
      systemTooltip.transition()
        .duration(200)
        .style("opacity", 0.7);
      systemTooltip.style("background-color", "rgba(0.25,0.5,1.0,0.1)");
      systemTooltip.style("pointer-events", "auto");
      //planetTooltip.style("left", (d3.event.pageX) + "px")
        //.style("top", (d3.event.pageY - 28) + "px");
      //planetTooltip.style("left", "10%")
        //.style("top", "25%");
      //systemTooltip.style("left", "50%")
        //.style("top", "25%");
      d3.select("#tutorial").transition()
        .duration(200)
        .style("opacity", 0.0);

      systemTooltipHeader.html("<h3>" + sector.star.name + ", Star " + sector.star.type + "&nbsp;" +
      "<img src=\"images/"+sector.star.type.toUpperCase()+"_Star.png\" alt=\"Star\" align=\"center\" style=\"max-height:40px; max-width:40px; width:100%\"/>&nbsp;" +
      "<span>" +
      "<button type=\"button\" onclick=\"javascript:hideSystemMap();\">Close System Map</button>" +
      "</span>" +
      "</h3>");

      if (sector.owner !== null && sector.owner !== undefined) {
        systemTooltipHeader.html(systemTooltipHeader.html() + "<h4>" + sector.owner.name + "</h4>");
      }
      else {
        systemTooltipHeader.html(systemTooltipHeader.html() + "<h4>Unclaimed</h4>");
      }

      //var rect = systemStarMap.getBoundingClientRect();
      //console.log(rect.top, rect.right, rect.bottom, rect.left);

      var starMapWidth = $("#system-tooltip-main").width();
      var starMapHeight = $("#system-tooltip-main").height();
      systemStarMap.html(
        "<img src=\"./images/blank.png\" alt=\"Planet\" width=\"50\" height=\"50\" align=\"center\" " +
        "style=\"left:0%; top:0%; max-height:" + starMapHeight + "px; max-width:" + starMapWidth + "px; width:100%; height:100%; position:absolute; z-index:-1;\" />"
      );
      for (var planetPos in sector.planets) {
        var planet = planets[sector.planets[planetPos]];
        var dx = planet.position[0] - sector.position[0];
        var dy = planet.position[1] - sector.position[1];
        //console.log(dx/10 + " " + dy/10);
        //console.log(starMapWidth + " " + starMapHeight);
        var trueX = Math.round((dx/10 + 1.0) / 2.0 * 100);
        var trueY = Math.round((dy/10 + 1.0) / 2.0 * 100);
        var sizePlanet = 15 + Math.round(planet.size / maxTiles * 25);
        if (planet.biome === "Asteroid") {
          sizePlanet = 15;
        }
        var textOffsetX = starMapWidth*(trueX/100) - 80;
        var textOffsetY = starMapHeight*(trueY/100) + sizePlanet;

        /*
        var total = [];
        for (var k = 0; k < planet.baseResources.length; k++) {
          total.push(planet.baseResources[k]);
        }
        if (planet.satelliteBuilding !== null) {
          for (var k = 0; k < planet.baseResources.length; k++) {
            total[k] += planet.satelliteBuilding.output[k];
          }
        }
        */

        var resourceString = "<p>";
        if (planet.baseResources[0] > 0) {
          resourceString += planet.baseResources[0] + "&nbsp;<img src=\"./images/minerals.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;"
        }
        if (planet.baseResources[1] > 0) {
          resourceString += planet.baseResources[1] + "&nbsp;<img src=\"./images/energy.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
        }
        if (planet.baseResources[2] > 0) {
          resourceString += planet.baseResources[2] + "&nbsp;<img src=\"./images/food.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
        }
        if (planet.baseResources[3] > 0) {
          resourceString += planet.baseResources[3] + "&nbsp;<img src=\"./images/star_research.png\" alt=\"Star Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;"
        }
        if (planet.baseResources[4] > 0) {
          resourceString += planet.baseResources[4] + "&nbsp;<img src=\"./images/society_research.png\" alt=\"Society Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;"
        }
        if (planet.baseResources[5] > 0) {
          resourceString += planet.baseResources[5] + "&nbsp;<img src=\"./images/production_research.png\" alt=\"Production Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;"
        }
        resourceString += "</p>"
        if (resourceString === "<p></p>") resourceString = "";
        var planetInfoString = planet.name;
        if (planet.biome !== "Asteroid") {
          planetInfoString += " (" + planet.biomeAbbr + ", " + planet.size + ")";
        }
        else {
          planetInfoString = "";
        }

        systemStarMap.html(
          systemStarMap.html() +
          //"<figure class=\"tint\" style=\"background: rgba(0, 0, 255, 0.5);\">" +
          "<img src=\"./images/planet_" + planet.biome.toLowerCase() + ".png\" data-planetposition=\"" + planet.position + "\" alt=\"Planet\" width=\"50\" height=\"50\" align=\"center\" " +
          "onclick=\"javascript:displayPlanetFromCoord([" + planet.position[0] + "," + planet.position[1] + "]); " +
          "javascript:hideBuildMenu(); \" " +
          "style=\"left:" + trueX + "%; top:" + trueY + "%; max-height:" + sizePlanet + "px; max-width:" + sizePlanet + "px; width:100%; position:absolute; z-index:-1;\" />" +
          //"</figure>" +
          "<div style=\"left:" + textOffsetX + "px; top:" + textOffsetY + "px; max-height:200px; max-width:200px; width:100%; pointer-events:none; position:absolute; z-index:-1;\">" +
          planetInfoString + resourceString +
          "</div>"
        );
        var circle = starMapSvg.append("circle").attr({
                      cx: starMapWidth*(trueX/100),
                      cy: starMapHeight*(trueY/100),
                      r: 30,
                      fill: "none",
                      stroke: "black"
                    });
        starMapCircleMarkers.push(circle);
      }
      for (var i = 0; i < sector.fleets.length; i++) {
        var fleet = sector.fleets[i];
        var dx = fleet.position[0] - sector.position[0];
        var dy = fleet.position[1] - sector.position[1];
        //console.log(dx/10 + " " + dy/10);
        //console.log(starMapWidth + " " + starMapHeight);
        var trueX = Math.round((dx/10 + 1.0) / 2.0 * 100);
        var trueY = Math.round((dy/10 + 1.0) / 2.0 * 100);

        var textOffsetX = starMapWidth*(trueX/100) - 20;
        var textOffsetY = starMapHeight*(trueY/100) - 10;

        //console.log(trueX + " " + trueY);
        var strength = calcFleetStrength(fleet);

      // displayFleet(civId, fleetId)
        systemStarMap.html(
          systemStarMap.html() +
          "<img src=\"./images/red_ship.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
          "onclick=\"javascript:displayFleetFromId(" + fleet.owner.id + "," + fleet.id + ");\" " +
          "style=\"left:" + trueX + "%; top:" + trueY + "%; max-height:20px; max-width:20px; width:100%; position:absolute; z-index:" + i + ";\" />" +
          "<div style=\"left:" + textOffsetX + "px; top:" + textOffsetY + "px; max-height:20px; max-width:100px; width:100%; pointer-events:none; position:absolute; z-index:" + i + ";\">" +
          strength +
          "<img src=\"./images/strength.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
          "style=\"max-height:10px; max-width:10px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />" + "&nbsp;" +
          fleet.ships.length +
          "<img src=\"./images/ship.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
          "style=\"max-height:10px; max-width:10px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />" +
          "</div>"
        );
      }
      executeAsync(function() {
        updateGalaxyMap();
      });
    }

    function displaySatelliteBuildMenuFromCoord(planetPosition) {
      var planet = planets[planetPosition];
      displaySatelliteBuildMenu(planet);
    }

    function displaySatelliteBuildMenu(planet) {
      satelliteBuildTooltip.style("pointer-events", "auto");
      satelliteBuildTooltip.transition()
        .duration(200)
        .style("opacity", 1);

      spaceportBuildTooltip.style("pointer-events", "none");
      spaceportBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      planetBuildTooltip.style("pointer-events", "none");
      planetBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      var validSate = getValidSatellites(planet, planet.owner);

      satelliteBuildTooltip.html("<h4>Build Satellite</h4>");
      //{name: "Mine", output: [1,0,0], cost: [70,0,0], maintenance: [0,-1,0], biomeRestrict: null, terrainRestrict: "Land"}
      //{name: "Spaceport", planet: null, output: [0,0,0,1,1,1], buildTime: 400, cost: [250,0,0,0,0,0], maintenance: [0,-3,-2,0,0,0], biomeRestrict: "NotAsteroid", starRestrict: null, orders: []},
      if (planet.sector.owner === playerCiv) {
        for (var i = 0; i < validSate.length; i++) {
          var impr = validSate[i];

          var satelliteString = "";
          if (impr.output[0] > 0) satelliteString += impr.output[0] + "<img src=\"./images/minerals.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
          if (impr.output[1] > 0) satelliteString += impr.output[1] + "<img src=\"./images/energy.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
          if (impr.output[2] > 0) satelliteString += impr.output[2] + "<img src=\"./images/food.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
          if (impr.output[3] > 0) satelliteString += impr.output[3] + "<img src=\"./images/star_research.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
          if (impr.output[4] > 0) satelliteString += impr.output[4] + "<img src=\"./images/society_research.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
          if (impr.output[5] > 0) satelliteString += impr.output[5] + "<img src=\"./images/production_research.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
          satelliteString += impr.buildTime + "<img src=\"./images/time.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>";

          satelliteBuildTooltip.html(satelliteBuildTooltip.html() +
            "<div>" +
            "<button type=\"button\" class=\"tile-build-button\" onclick=\"javascript:requestQueueSatelliteOnPlanet([" + planet.position[0] + "," + planet.position[1] + "], &quot;" + impr.name + "&quot;, " + planet.sector.owner.id + "); " +
            "javascript:hideBuildSatelliteMenu(); " +
            "javascript:displayPlanetFromCoord([" + planet.position[0] + "," + planet.position[1] + "]); \"" +
            "style=\"max-height:50px; max-width:300px; width:100%; position:relative; z-index:" + i + ";\">" + impr.name + "</button>" +
            "<p>" + satelliteString + "</p>" +
            "</div>"
          );
        }
      }
    }

    function displaySpaceportBuildMenuFromCoord(planetPosition) {
      var planet = planets[planetPosition];
      var port = planet.satelliteBuilding;
      if (port === null) {
        hideTooltip();
        return;
      }

      displaySpaceportBuildMenu(port);
    }

    function displaySpaceportBuildMenu(port) {
      var planetPosition = port.planet.position;
      currentSpaceportSelected = port;

      spaceportBuildTooltip.style("pointer-events", "auto");
      spaceportBuildTooltip.transition()
        .duration(200)
        .style("opacity", 1);

      planetBuildTooltip.style("pointer-events", "none");
      planetBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      satelliteBuildTooltip.style("pointer-events", "none");
      satelliteBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      var validQueue = getValidSpaceportQueue(port);
      spaceportBuildTooltip.html("<h4>Spaceport Queue</h4>");
      for (var i = 0; i < port.orders.length; i++) {
        var order = port.orders[i];
        spaceportBuildTooltip.html(spaceportBuildTooltip.html() +
        "<h5>" +
        "Queue: " + order.unit.name + ", " +
        order.timeRemaining + "&nbsp;<img src=\"./images/time.png\" alt=\"Time\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>" +
        "</h5>");
      }
      //{name: "Mine", output: [1,0,0], cost: [70,0,0], maintenance: [0,-1,0], biomeRestrict: null, terrainRestrict: "Land"}
      //<button type="button" class="button" onclick="alert('Hello world!')">Click Me!</button>
      if (port.planet.owner === playerCiv) {
        for (var i = 0; i < validQueue.length; i++) {
          var impr = validQueue[i];
          spaceportBuildTooltip.html(spaceportBuildTooltip.html() +
            "<p>" +
            "<button type=\"button\" class=\"tile-build-button\" onclick=\"javascript:requestQueueUnitOnPosition([" + planetPosition[0] + "," + planetPosition[1] + "], &quot;" + impr.name + "&quot;, " + port.planet.owner.id +"); " +
            "javascript:hideSpaceportMenu(); " +
            "javascript:displayPlanetFromCoord([" + planetPosition[0] + "," + planetPosition[1] + "]); \"" +
            "style=\"max-height:50px; max-width:300px; width:100%; position:relative; z-index:" + i + ";\">" + impr.name + "</button>" +
            "</p>"
          );
        }
      }
    }

    function displayTileBuildMenu(planetPosition, tileNum) {
      var planet = planets[planetPosition];
      var tile = planet.tiles[tileNum];
      //var buildMenu = d3.select("#planet-build-main");
      planetBuildTooltip.style("pointer-events", "auto");
      planetBuildTooltip.transition()
        .duration(200)
        .style("opacity", 1);

      spaceportBuildTooltip.style("pointer-events", "none");
      spaceportBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      satelliteBuildTooltip.style("pointer-events", "none");
      satelliteBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);

      if (planet.owner === playerCiv) {
        var validImprovements = getValidImprovements(tile, planet.owner);
        planetBuildTooltip.html("<h4>Build Improvement</h4>");
        //{name: "Mine", output: [1,0,0], cost: [70,0,0], maintenance: [0,-1,0], biomeRestrict: null, terrainRestrict: "Land"}
        //<button type="button" class="button" onclick="alert('Hello world!')">Click Me!</button>
        if (validImprovements.length <= 0) {
          planetBuildTooltip.html(planetBuildTooltip.html() + "<p>No improvements to build.</p>")
        }
        for (var i = 0; i < validImprovements.length; i++) {
          var impr = validImprovements[i];
          planetBuildTooltip.html(planetBuildTooltip.html() +
            "<p>" +
            "<button type=\"button\" class=\"tile-build-button\" onclick=\"javascript:requestQueueImprOnTile([" + planetPosition[0] + "," + planetPosition[1] + "], " + tileNum + ", &quot;" + impr.name + "&quot;, " + planet.owner.id +"); " +
            "javascript:hideBuildMenu(); " +
            "javascript:displayPlanetFromCoord([" + planetPosition[0] + "," + planetPosition[1] + "]); \"" +
            "style=\"max-height:50px; max-width:300px; width:100%; position:relative; z-index:" + i + ";\">" + impr.name + "</button>" +
            "</p>"
          );
        }
      }
      else {
        planetBuildTooltip.html("<h4>Uncolonized (Cannot Build)</h4>");
      }
    }

    function displayEmpireMenu() {
      hideMenuBarTooltips();

      empireMenu.style("pointer-events", "auto");
      empireMenu.transition()
        .duration(200)
        .style("opacity", 0.9);

      empireMenu.html("<h4>" + playerCiv.name + "</h4>");
      var sumPop = 0;
      for (var i = 0; i < playerCiv.worlds.length; i++) {
        sumPop += playerCiv.worlds[i].population;
      }
      if (playerCiv.worlds.length === 1) {
        empireMenu.html(empireMenu.html() + "<p>" + sumPop + " pops in " + playerCiv.worlds.length + " world</p>")
      }
      else {
        empireMenu.html(empireMenu.html() + "<p>" + sumPop + " pops in " + playerCiv.worlds.length + " worlds</p>")
      }

      if (playerCiv.baseResourcesFlow[0] === undefined) {
        playerCiv.baseResourcesFlow = [0,0,0,0,0,0];
      }
      empireMenu.html(empireMenu.html() + "<p>" +
        "&emsp;<img src=\"./images/minerals.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + Math.trunc(playerCiv.baseResources[0]) + " / " + Math.trunc(playerCiv.baseResourcesFlow[0]) + "&emsp;" +
        "&emsp;<img src=\"./images/energy.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + Math.trunc(playerCiv.baseResources[1]) + " / " + Math.trunc(playerCiv.baseResourcesFlow[1]) + "&emsp;" +
        "&emsp;<img src=\"./images/planets.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + playerCiv.worlds.length + "&emsp;" +
        "&emsp;<img src=\"./images/star_research.png\" alt=\"Star Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + Math.trunc(playerCiv.baseResourcesFlow[3]) + "&emsp;" +
        "&emsp;<img src=\"./images/society_research.png\" alt=\"Society Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + Math.trunc(playerCiv.baseResourcesFlow[4]) + "&emsp;" +
        "&emsp;<img src=\"./images/production_research.png\" alt=\"Production Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + Math.trunc(playerCiv.baseResourcesFlow[5]) + "&emsp;" +
        "</p>"
      );

      var star = 0, society = 0, production = 0;
      for (var i = 0; i < playerCiv.techsResearched.length; i++) {
        var tech = playerCiv.techsResearched[i];
        if (tech.techType === "Star") star++;
        if (tech.techType === "Society") society++;
        if (tech.techType === "Production") production++;
      }
      empireMenu.html(empireMenu.html() + "<p>" +
        "&emsp;<img src=\"./images/star_research.png\" alt=\"Star Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + star + " techs&emsp;" +
        "&emsp;<img src=\"./images/society_research.png\" alt=\"Society Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + society + " techs&emsp;" +
        "&emsp;<img src=\"./images/production_research.png\" alt=\"Production Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + production + " techs&emsp;" +
        "</p>");
    }

    function displayTechMenu() {
      hideMenuBarTooltips();

      techMenu.style("pointer-events", "auto");
      techMenu.transition()
        .duration(200)
        .style("opacity", 0.9);

      techStarMenu.style("pointer-events", "auto");
      techSocietyMenu.style("pointer-events", "auto");
      techProductionMenu.style("pointer-events", "auto");

      if (playerCiv.techResearchingStar !== null) {
        var tech = playerCiv.techResearchingStar;
        techStarMenu.html("Researching " + tech.name + " (" + tech.researchCompleted + "/" + tech.researchNeeded + ")");
      }
      else {
        techStarMenu.html("No Universe Research");
      }
      if (playerCiv.techResearchingSociety !== null) {
        var tech = playerCiv.techResearchingSociety;
        techSocietyMenu.html("Researching " + tech.name + " (" + tech.researchCompleted + "/" + tech.researchNeeded + ")");
      }
      else {
        techSocietyMenu.html("No Society Research");
      }
      if (playerCiv.techResearchingProduction !== null) {
        var tech = playerCiv.techResearchingProduction;
        techProductionMenu.html("Researching " + tech.name + " (" + tech.researchCompleted + "/" + tech.researchNeeded + ")");
      }
      else {
        techProductionMenu.html("No Production Research");
      }

      for (var i = 0; i < playerCiv.techChoicesStar.length; i++) {
        var tech = playerCiv.techChoicesStar[i];
        techStarMenu.html(techStarMenu.html() +
          "<div onclick=\"javascript:requestResearchStarTech(" + i + "); displayTechMenu();\">" +
          tech.name + "&nbsp;" +
          tech.researchNeeded + "&nbsp;<img src=\"./images/star_research.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;" +
          "</div>"
        );
      }
      for (var i = 0; i < playerCiv.techChoicesSociety.length; i++) {
        var tech = playerCiv.techChoicesSociety[i];
        techSocietyMenu.html(techSocietyMenu.html() +
          "<div onclick=\"javascript:requestResearchSocietyTech(" + i + "); displayTechMenu();\">" +
          tech.name + "&nbsp;" +
          tech.researchNeeded + "&nbsp;<img src=\"./images/society_research.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;" +
          "</div>"
        );
      }
      for (var i = 0; i < playerCiv.techChoicesProduction.length; i++) {
        var tech = playerCiv.techChoicesProduction[i];
        techProductionMenu.html(techProductionMenu.html() +
          "<div onclick=\"javascript:requestResearchProductionTech(" + i + "); displayTechMenu();\">" +
          tech.name + "&nbsp;" +
          tech.researchNeeded + "&nbsp;<img src=\"./images/production_research.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;" +
          "</div>"
        );
      }
    }

    function displayDiplomacyMenu() {
      hideMenuBarTooltips();

      diplomacyMenu.style("pointer-events", "auto");
      diplomacyMenu.transition()
        .duration(200)
        .style("opacity", 0.9);

      var diplomacyString = "<h3>Galaxy Communications</h3>";
      for (var i = 0; i < civilizations.length; i++) {
        var civ = civilizations[i];
        if (civ === playerCiv) continue;
        var relation = civ.relationStats[playerCiv.name] + "";
        if (relation >= 0) {
          relation = "+" + relation;
        }
        diplomacyString += "<div onclick=\"javascript:displayContactMenu(" + i + ");\">"
          + civ.name + "&nbsp;" + relation +
          "<p>" + "Test" + "</p>" +
          "</div>";
      }
      diplomacyMenu.html(diplomacyString);
    }

    function displayContactMenu(civIndex) {
      contactMenu.style("pointer-events", "auto");
      contactMenu.transition()
        .duration(200)
        .style("opacity", 0.9);

      var civ = civilizations[civIndex];
      var relations = civ.relationStats[playerCiv.name];
      contactMenu.html("<h4>" + civ.name + " (" + relations + ")</h4>");
      if (isAtWar(playerCiv, civ)) {

      }
      else {
        contactMenu.html(contactMenu.html() + "<div onclick=\"javascript:declareWar(0, " + civIndex + "); javascript:displayContactMenu(" + civIndex + ");\"><p>" + "Declare War" + "</p></div>");
      }
    }

    function declareWar(attackerCivIndex, defenderCivIndex) {
      var attacker = civilizations[attackerCivIndex], defender = civilizations[defenderCivIndex];
      for (var i = attacker.relations[defender.name].length - 1; i >= 0; i--) {
        var relations = attacker.relations[defender.name];
        var relation = relations[i];
        if (relation[0] === "Peace") {
          relations.splice(i, 1);
        }
      }
      for (var i = defender.relations[attacker.name].length - 1; i >= 0; i--) {
        var relations = defender.relations[attacker.name];
        var relation = relations[i];
        if (relation[0] === "Peace") {
          relations.splice(i, 1);
        }
      }
      attacker.relations[defender.name].push(["War", "Your nations are at war!", -50, 0]);
      defender.relations[attacker.name].push(["War", "Your nations are at war!", -50, 0]);
      defender.relations[attacker.name].push(["Declared War", "You declared war!", -25, 0]);
      updateRelationStats(attacker);
      updateRelationStats(defender);
    }

    function updateRelationStats(civ) {
      //civ.relations[otherCiv.name] = [["Peace", "Your nations are at peace.", 10, 0]];
      civ.relationStats = {};
      for (var civName in civ.relations) {
        var relation = 0;
        for (var i = 0; i < civ.relations[civName].length; i++) {
          var modifier = civ.relations[civName][i];
          relation += modifier[2];
        }
        civ.relationStats[civName] = relation;
      }
    }

    function isAtWar(civ, otherCiv) {
      var relations = civ.relations[otherCiv.name];
      for (var i = 0; i < relations.length; i++) {
        if (relations[i][0] === "War") {
          return true;
        }
      }
      return false;
    }

    function updateOutlineTooltip() {
      var outlineString = "<h3>" + playerCiv.name + "</h3><br>";

      outlineString += "<h4>Worlds</h4>";
      for (var i = 0; i < playerCiv.worlds.length; i++) {
        var planet = playerCiv.worlds[i];

        var planetSize = Math.round(planet.size / maxTiles * 20) + 10;
        var habitability = playerCiv.planetPreference[planet.biome];

        outlineString += "<div id=\"generated-outline-planet-" + i + "\" onclick=\"javascript:" +
          "outlineDisplayPlanetFromCoord([" + planet.position + "]);" +
          "\"><b>" + planet.name + "</b>&nbsp;" +
          "<img src=\"./images/planet_" + planet.biome.toLowerCase() + ".png\" alt=\"Planet\" width=\"" + planetSize + "\" height=\"" + planetSize + "\" style=\"max-height:" + planetSize + "px; max-width:" + planetSize + "px; width:100%;\"/>" +
          "&nbsp;" + planet.biomeAbbr + ", " + planet.size + ", " + Math.round(habitability*100) + "%, ";

        outlineString += planet.population + "<img src=\"./images/population.png\" alt=\"Population\" width=\"20\" height=\"20\" style=\"max-height:20px; max-width:20px; width:100%;\"/>" +
          //planet.food + "/" + foodNeededToGrow + "&nbsp;<img src=\"./images/food.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>" +
          "</div>";

        //console.log(d3.select("#generated-outline-planet-" + i));
        //d3.select("#generated-outline-planet-" + i).on("click", function() {console.log(i);});
      }

      outlineString += "<br><h4>Fleets</h4>";
      for (var fleetId in playerCiv.fleets) {
        var fleet = playerCiv.fleets[fleetId];
        var str = calcFleetStrength(fleet);
        outlineString += "<div onclick=\"javascript:outlineDisplayFleetFromId(" + playerCiv.id + ", &quot;" + fleetId + "&quot;);\"><b>" + fleet.name + "</b>&nbsp;" +
        str + "&nbsp;" +
        "<img src=\"./images/strength.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
        "style=\"max-height:20px; max-width:20px; width:100%; pointer-events:auto; position:relative; z-index:" + i + ";\" />" + "&nbsp;&nbsp;" +
        fleet.ships.length + "&nbsp;" +
        "<img src=\"./images/ship.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
        "style=\"max-height:20px; max-width:20px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />" +
        "</div>";
      }

      outlineTooltip.html(outlineString);
    }
    function outlineDisplayPlanetFromCoord(planetPosition) {
      var planet = planets[planetPosition];
      if (currentPlanetSelected === planet) {
        displaySector(planet.sector);
      }
      displayPlanet(planet);
    }
    function outlineDisplayFleetFromId(civId, fleetId) {
      var fleet = civilizations[civId].fleets["Fleet" + fleetId];
      if (fleet === null || fleet === undefined) {
        fleet = civilizations[civId].fleets[fleetId];
      }
      if (currentFleetSelected === fleet) {
        displaySector(fleet.sector);
      }
      displayFleet(fleet);
    }

    function displayMessage(title, message) {
      messageTooltip.style("pointer-events", "auto");
      messageTooltip.transition()
        .duration(200)
        .style("opacity", 0.75);
      messageTooltip.html("<h4>" + title + "</h4>")
      messageTooltip.html(messageTooltip.html() +
        "<p>" + message + "</p>");
    }

    function hideFleetTooltip() {
      //var fleetTooltip = d3.select("#fleet-tooltip-main");
      fleetTooltip.style("pointer-events", "none");
      fleetTooltip.transition()
        .duration(200)
        .style("opacity", 0);
    }

    function hideSpaceportMenu() {
      spaceportBuildTooltip.style("pointer-events", "none");
      spaceportBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);
    }

    function hideBuildMenu() {
      planetBuildTooltip.style("pointer-events", "none");
      planetBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);
    }

    function hideBuildSatelliteMenu() {
      satelliteBuildTooltip.style("pointer-events", "none");
      satelliteBuildTooltip.transition()
        .duration(200)
        .style("opacity", 0);
    }

    function hidePlanetMap() {
      planetTooltip.style("pointer-events", "none");
      planetTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      currentPlanetSelected = null;
      planetTooltipVisible = false;
    }

    function hideSystemMap() {
      console.log("yesssss");
      systemTooltip.style("pointer-events", "none");
      systemTooltip.transition()
        .duration(200)
        .style("opacity", 0);
      //planetTooltip.style("pointer-events", "none");
      //planetTooltip.transition()
        //.duration(200)
        //.style("opacity", 0);
      currentSectorSelected = null;
      //currentPlanetSelected = null;
      systemTooltipVisible = false;
    }

    function hideTechMenu() {
      techMenu.style("pointer-events", "none");
      techMenu.transition()
        .duration(200)
        .style("opacity", 0);
    }

    function findNewSetTechs(civ, techType) {
      //TODO: Find the most likely useful to the player from the group techEraN in data
      var candidates = [];
      for (var i = 0; i < techEra0.length; i++) {
        var tech = techEra0[i];
        if (tech.type === techType && (civ.techsResearched[tech.name] === undefined || civ.techsResearched[tech.name] === null)) {
          candidates.push(tech);
        }
      }
      var finalChoices = [];
      for (var i = 0; i < civ.techChoicesNum; i++) {
        //Use a weighing system later, where earlier and less expensive techs are more likely
        if (candidates.length === 0) {
          break;
        }
        var randIndex = Math.trunc(Math.random()*candidates.length);
        var randomTech = candidates.splice(randIndex, 1)[0];
        finalChoices.push(randomTech);
      }
      return finalChoices;
    }

    function requestResearchStarTech(index) {
      var tech = playerCiv.techChoicesStar[index];
      queueNewTech(playerCiv, tech);
    }
    function requestResearchSocietyTech(index) {
      var tech = playerCiv.techChoicesSociety[index];
      queueNewTech(playerCiv, tech);
    }
    function requestResearchProductionTech(index) {
      var tech = playerCiv.techChoicesProduction[index];
      queueNewTech(playerCiv, tech);
    }

    function queueNewTech(civ, tech) {
      if (tech.type === "Star") {
        civ.techResearchingStar = jQuery.extend({}, tech);
        civ.techResearchingStar.researchCompleted = 0;
      }
      else if (tech.type === "Society") {
        civ.techResearchingSociety = jQuery.extend({}, tech);
        civ.techResearchingSociety.researchCompleted = 0;
      }
      else if (tech.type === "Production") {
        civ.techResearchingProduction = jQuery.extend({}, tech);
        civ.techResearchingProduction.researchCompleted = 0;
      }
      else {
        console.log("Invalid tech type: " + tech.type);
      }
    }

    //requestActionOnPlanet([" + temp.dataset["planetposition"] + "], " + currentFleetSelected.id + ", &quot;" + actions[i] + "&quot;); " +
    function requestActionOnPlanet(planetPosition, fleetOwnerCivId, fleetId, actionString) {
      var planet = planets[planetPosition];
      var civ = civilizations[fleetOwnerCivId];
      var fleet = civ.fleets["Fleet" + fleetId];
      if (actionString === "Colonize") {

      }
      else if (actionString === "Explore") {
        if (!(planetPosition in civ.exploredSectorPositions)) {
          civ.exploredSectorPositions[planetPosition] = true;
        }
      }
      else if (actionString === "Build") {
        if (fleet.owner === planet.owner) {

        }
      }
      else {

      }
    }

    function requestQueueSatelliteOnPlanet(planetPosition, satelliteName, ownerId) {
      var planet = planets[planetPosition];
      var owner = civilizations[ownerId];
      if (planet.sector.owner === owner) {
        var satellite = null;
        for (var i = 0; i < planetSatellites.length; i++) {
          if (planetSatellites[i].name === satelliteName) {
            satellite = planetSatellites[i];
          }
        }
        if (satellite !== null) {
          var cost = satellite.cost;
          var civRes = owner.baseResources;
          for (var i = 0; i < cost.length; i++) {
            if (cost[i] > civRes[i]) {
              //Not enough resources to build the improvement
              return;
            }
          }
          for (var i = 0; i < cost.length; i++) {
            civRes[i] -= cost[i];
          }
          queueSatelliteOnPlanet(planetPosition, satellite);
        }
      }
    }

    function queueSatelliteOnPlanet(planetPosition, satellite) {
      var planet = planets[planetPosition];
      var order = {
        orderType: "buildSatellite",
        timeRemaining: satellite.buildTime,
        owner: planet.owner,
        planetPosition: planetPosition,
        satellite: satellite
      };
      planet.order = order;
      satelliteOrders.push(order);
    }

    function buildSatelliteOnPlanet(planetPosition, satellite) {
      var planet = planets[planetPosition];
      planet.satelliteBuilding = {name: satellite.name, output: satellite.output, maintenance: satellite.maintenance};
      planet.order = null;
    }

    function requestQueueUnitOnPosition(planetPosition, shipName, ownerId) {
      var impr = shipTypes[shipName];
      var planet = planets[planetPosition];
      var owner = civilizations[ownerId];
      if (impr !== null && planet.sector.owner === owner) {
        var cost = impr.cost;
        var owner = civilizations[ownerId];
        var civRes = owner.baseResources;
        for (var i = 0; i < cost.length; i++) {
          if (cost[i] > civRes[i]) {
            //Not enough resources to build the improvement
            return;
          }
        }
        for (var i = 0; i < cost.length; i++) {
          civRes[i] -= cost[i];
        }
        queueUnitOrderOnPosition(planetPosition, impr, owner);
        //buildImprOnTile(planetPosition, tileNum, impr);
      }
    }

    function queueUnitOrderOnPosition(planetPosition, unit, owner) {
      var spaceport = planets[planetPosition].satelliteBuilding;
      var order = {
        orderType: "buildUnit",
        timeRemaining: unit.buildTime,
        owner: owner,
        planetPosition: planetPosition,
        spaceport: spaceport,
        unit: unit
      };
      spaceport.orders.push(order);
      unitOrders.push(order);
    }

    function bulidUnitOnSpaceport(owner, planetPosition, spaceport, unit) {
      var planet = planets[planetPosition];
      if (unit !== null) {
        var fleet = createFleet(planet.sector, planet.name + " Fleet", planetPosition, owner, [unit.name]);
      }
      spaceport.orders.splice(0, 1);
    }

    function requestQueueImprOnTile(planetPosition, tileNum, imprName, ownerId) {
      var impr = null;
      for (var i = 0; i < tileImprovements.length; i++) {
        if (tileImprovements[i].name === imprName) {
          impr = tileImprovements[i];
        }
      }
      if (impr !== null) {
        var cost = impr.cost;
        var owner = civilizations[ownerId];
        var civRes = owner.baseResources;
        for (var i = 0; i < cost.length; i++) {
          if (cost[i] > civRes[i]) {
            //Not enough resources to build the improvement
            return;
          }
        }
        for (var i = 0; i < cost.length; i++) {
          civRes[i] -= cost[i];
        }
        queueImprOrderOnTile(planetPosition, tileNum, impr);
        //buildImprOnTile(planetPosition, tileNum, impr);
      }
    }

    function queueImprOrderOnTile(planetPosition, tileNum, impr) {
      var order = {
        orderType: "buildTileImpr",
        timeRemaining: impr.buildTime,
        planetPosition: planetPosition,
        tileNum: tileNum,
        impr: impr
      };
      var tile = planets[planetPosition].tiles[tileNum];
      tile.order = order;
      constructionOrders.push(order);
    }

    function buildImprOnTile(planetPosition, tileNum, impr) {
      if (impr !== null) {
        var tile = planets[planetPosition].tiles[tileNum];
        tile.order = null;
        tile.building = {name: impr.name, output: impr.output, maintenance: impr.maintenance};
      }
    }

    function buildImprOnTileByName(planetPosition, tileNum, imprName) {
      var impr = null;
      for (var i = 0; i < tileImprovements.length; i++) {
        if (tileImprovements[i].name === imprName) {
          impr = tileImprovements[i];
        }
      }
      buildImprOnTile(planetPosition, tileNum, impr);
    }

    function queueShipOrdersToSector(fleet, destSector, newPosition=null) {
      fleet.orders = [];
      if (newPosition === null) {
        newPosition = fleet.position;
      }
      var path = aStarSearch(fleet.sector, destSector);
      if (path === null) return;
      for (var i = 0; i < path.length; i++) {
        var order = {
          orderType: "MoveToSector",
          fleet: currentFleetSelected,
          destSector: path[i],
          destination: path[i].position,
          desc: "Move to " + destSector.star.name
        };
        fleet.orders.push(order);
      }
      if (moveToSectorOrders.indexOf(fleet) === -1) {
        moveToSectorOrders.push(fleet);
      }
    }
    /*function queueFleetOrder(fleet, positionInSameSector) {
      var order = {
        orderType: "moveFleetInSector",
        fleet: fleet,
        destination: positionInSameSector
      };
      moveWithinSectorOrders.push(order);
    }*/

    function defaultEuclideanHeuristic(inspectSector, destSector) {
      var dx = inspectSector.position[0] - destSector.position[0];
      var dy = inspectSector.position[1] - destSector.position[1];
      return Math.sqrt(dx*dx + dy*dy) / 20;
    }

    /*
    Given a query [startSector, endSector], with function heuristic(inspect, goal),
    where the optimal path is [startSector, sector1, sector2, ..., sectorN, endSector],
    and the nodes are expanded with lowest priority first (priority = total cost + heuristic cost),
    return [sector1, sector2, ..., sectorN, endSector].
    */
    function aStarSearch(startSector, endSector, heuristic=defaultEuclideanHeuristic) {
      if (startSector == endSector) return [];

      var closedPositions = new Set();
      var fringe = [];
      fringe.push([startSector, [], 0, 0]);

      while (true) {
        if (fringe.length === 0) {
          //console.log("Path not found");
          return null;
        }
        var node = null, minIndex = 0, minCost = 0;
        for (var i = 0; i < fringe.length; i++) {
          if (fringe[i][3] < minCost || node === null) {
            node = fringe[i];
            minIndex = i;
            minCost = fringe[i][3];
          }
        }
        fringe.splice(minIndex, 1);
        if (endSector === node[0]) {
          //node[1].push(endSector);
          //console.log(startSector.position + " " + endSector.position);
          //console.log(node[1]);
          return node[1];
        }
        if (!closedPositions.has(node[0].position)) {
          closedPositions.add(node[0].position);
          for (var i = 0; i < node[0].neighborPositions.length; i++) {
            var successor = sectors[node[0].neighborPositions[i]];
            var newList = node[1].slice(0);
            newList.push(successor);
            fringe.push([successor, newList, node[2] + 1, node[2] + 1 + heuristic(successor, endSector)]);
          }
        }
      }

      return null;
    }

    function displayFleetFromId(civId, fleetId) {
      //console.log(civId + " " + fleetId + " " + civilizations[civId] + " " + civilizations[civId].fleets[fleetId]);
      var fleet = civilizations[civId].fleets["Fleet" + fleetId];
      if (fleet === null || fleet === undefined) {
        fleet = civilizations[civId].fleets[fleetId];
      }
      displayFleet(fleet);
    }

    function displayFleet(fleet) {
      currentFleetSelected = fleet;
      if (fleet === null) {
        hideTooltip();
      }
      else {
        fleetTooltip.transition()
          .duration(200)
          .style("opacity", 1);
        fleetTooltip.style("pointer-events", "auto");
        fleetTooltipVisible = true;
        if (planetTooltipVisible) {
          planetTooltipVisible = false;
          planetTooltip.transition()
            .duration(200)
            .style("opacity", 0);
          planetTooltip.style("pointer-events", "none");
          currentPlanetSelected = null;
          currentSpaceportSelected = null;
        }
      }

      var fleetStrength = calcFleetStrength(fleet);
      var fleetStringy = "<h4>" + fleet.name + "&emsp;" +
      fleetStrength + "&nbsp;" +
      "<img src=\"./images/strength.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
      "style=\"max-height:20px; max-width:20px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />" + "&nbsp;&nbsp;" +
      fleet.ships.length + "&nbsp;" +
      "<img src=\"./images/ship.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
      "style=\"max-height:20px; max-width:20px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />"
      + "</h4>";
      if (fleet.orders.length === 0) {
        fleetStringy += "<p>Idle</p>";
      }
      else {
        var firstOrder = fleet.orders[0];
        fleetStringy += "<p>";
        fleetStringy += firstOrder.desc;
        if (fleet.orders.length > 1) {
          fleetStringy += "&nbsp;(" + (fleet.orders.length - 1) + " more";
          if (fleet.orders.length === 2) {
            fleetStringy += " order)";
          }
          else {
            fleetStringy += " orders)";
          }
        }
        fleetStringy += "</p>";
      }
      fleetTooltip.html(fleetStringy);
      for (var i = 0; i < fleet.ships.length; i++) {
        var ship = fleet.ships[i];
        //var health = Math.ceil(ship.health / ship.maxHealth * 100);
        fleetTooltip.html(
          fleetTooltip.html() + "<p>" + ship.name + "&emsp;" +
          ship.strength + "&nbsp;" +
          "<img src=\"./images/strength.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
          "style=\"max-height:20px; max-width:20px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />" + "&nbsp;&nbsp;" +
          ship.health + "/" + ship.maxHealth + "&nbsp;" +
          "<img src=\"./images/health.png\" alt=\"Fleet\" width=\"50\" height=\"50\" align=\"center\" " +
          "style=\"max-height:20px; max-width:20px; width:100%; pointer-events:none; position:relative; z-index:" + i + ";\" />" +
          "</p>"
        );
      }
      executeAsync(function() {
        updateGalaxyMap();
      });
    }

    function displayBattle(battle) {

    }

    function displayPlanetFromCoord(position) {
      //console.log(position);
      var planet = planets[position];
      //console.log(planet);
      displayPlanet(planet);
    }

    function displayPlanet(planetClicked) {
      currentPlanetSelected = planetClicked;

      if (currentSectorSelected !== null && planetClicked !== null) {
        if (currentSectorSelected !== planetClicked.sector) {
          hideSystemMap();
        }
      }

      d3.select("#system-tutorial").transition()
				.duration(200)
				.style("opacity", 0);
      if (planetClicked === null) {
        hideTooltip();
      }
      else {
        planetTooltip.transition()
          .duration(200)
          .style("opacity", 0.9);
        planetTooltip.style("pointer-events", "auto");
        planetTooltipVisible = true;
        if (fleetTooltipVisible) {
          fleetTooltipVisible = false;
          fleetTooltip.transition()
            .duration(200)
            .style("opacity", 0);
          fleetTooltip.style("pointer-events", "none");
          currentFleetSelected = null;
          currentSpaceportSelected = null;
        }
      }

      /*
      function displayPlanetPlayerCivWorld(planetPosition) {
        for (var i = 0; i < playerCiv.worlds.length; i++) {
          var candidate = playerCiv.worlds[i];
          if (candidate.name === name) {
            displayPlanet(candidate);
            break;
          }
        }
      }
      */

      var planetString = "";
      var total = [];
      for (var k = 0; k < planetClicked.baseResources.length; k++) {
        total.push(planetClicked.baseResources[k]);
      }
      if (planetClicked.satelliteBuilding !== null) {
        for (var k = 0; k < planetClicked.baseResources.length; k++) {
          total[k] += planetClicked.satelliteBuilding.output[k];
        }
      }
      if (total[0] > 0) planetString += total[0] + "&nbsp;<img src=\"./images/minerals.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
      if (total[1] > 0) planetString += total[1] + "&nbsp;<img src=\"./images/energy.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
      if (total[2] > 0) planetString += total[2] + "&nbsp;<img src=\"./images/food.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
      if (total[3] > 0) planetString += total[3] + "&nbsp;<img src=\"./images/star_research.png\" alt=\"Star Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
      if (total[4] > 0) planetString += total[4] + "&nbsp;<img src=\"./images/society_research.png\" alt=\"Society Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";
      if (total[5] > 0) planetString += total[5] + "&nbsp;<img src=\"./images/production_research.png\" alt=\"Production Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&nbsp;";

      var planetSize = Math.round(planetClicked.size / maxTiles * 50 + 25);
      var habitability = playerCiv.planetPreference[planetClicked.biome];
      var currentText = "";
      if (!(planetClicked.sector.position in playerCiv.exploredSectorPositions)) {
        if (planetClicked.biome !== "Asteroid") {
          currentText = "<h3>" + planetClicked.name + "&emsp;" +
            "<span>" +
            "<button type=\"button\" onclick=\"javascript:hidePlanetMap();\">Close Planet Map</button>" +
            "</span>" +
            "</h3>" +
            "<h4>" + planetClicked.biome + ", " + planetClicked.size + "</h4>" +
            "<p><img src=\"./images/planet_" + planetClicked.biome.toLowerCase() + ".png\" alt=\"Planet\" width=\"" + planetSize + "\" height=\"" + planetSize + "\" style=\"max-height:" + planetSize + "px; max-width:" + planetSize + "px; width:100%;\"/></p>";
        }
        else {
          currentText = "<h3>" + planetClicked.name + "</h3><h4>" + planetClicked.biome + "&nbsp;&nbsp;" + "</h4>" +
            "<p><img src=\"./images/planet_" + planetClicked.biome.toLowerCase() + ".png\" alt=\"Planet\" width=\"30\" height=\"30\" style=\"max-height:30px; max-width:30px; width:100%;\"/></p>";
        }

        if (planetClicked.owner === null) {
          currentText += "<h4>Uncolonized</h4>";
        }
        else {
          currentText += "<h4>" + planetClicked.owner.name + "</h4>";
        }
      }
      else {
        if (planetClicked.biome !== "Asteroid") {
          currentText = "<h3>" + planetClicked.name + "&emsp;" +
            "<span>" +
            "<button type=\"button\" onclick=\"javascript:hidePlanetMap();\">Close Planet Map</button>" +
            "</span>" +
            "</h3>" +
            "<h4>" + planetClicked.biome + ", " + planetClicked.size + ", " + Math.round(habitability*100) + "% habitability&nbsp;&nbsp;" + planetString + "</h4>" +
            "<p><img src=\"./images/planet_" + planetClicked.biome.toLowerCase() + ".png\" alt=\"Planet\" width=\"" + planetSize + "\" height=\"" + planetSize + "\" style=\"max-height:" + planetSize + "px; max-width:" + planetSize + "px; width:100%;\"/></p>";
        }
        else {
          currentText = "<h3>" + planetClicked.name + "</h3><h4>" + planetClicked.biome + "&nbsp;&nbsp;" + planetString + "</h4>" +
            "<p><img src=\"./images/planet_" + planetClicked.biome.toLowerCase() + ".png\" alt=\"Planet\" width=\"30\" height=\"30\" style=\"max-height:30px; max-width:30px; width:100%;\"/></p>";
        }

        if (planetClicked.owner === null) {
          currentText += "<h4>Uncolonized";
        }
        else {
          currentText += "<h4>" + planetClicked.owner.name + ", " +
          planetClicked.population + "<img src=\"./images/population.png\" alt=\"Population\" width=\"20\" height=\"20\" style=\"max-height:20px; max-width:20px; width:100%;\"/>, " +
          planetClicked.food + "/" + foodNeededToGrow + "&nbsp;<img src=\"./images/food.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>";
        }
        if (planetClicked.satelliteBuilding === null) {
          if (planetClicked.order === null) {
            currentText += ", No Satellite&nbsp;"
          }
          else {
            currentText += ", Building&nbsp;" + planetClicked.order.satellite.name + "&nbsp;" + planetClicked.order.timeRemaining + "&nbsp;<img src=\"./time.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>"
          }
          currentText += "&nbsp;" +
          "<img src=\"images/build-icon.png\" alt=\"Build\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\" "+
          "onclick=\"javascript:displaySatelliteBuildMenuFromCoord([" + planetClicked.position[0] + "," + planetClicked.position[1] + "]);\" " +
          "/>" +
          "</h4>";
        }
        else {
          currentText += ", " + planetClicked.satelliteBuilding.name + "&nbsp;" +
          "<img src=\"images/build-icon.png\" alt=\"Build\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\" "+
          "onclick=\"javascript:displaySatelliteBuildMenuFromCoord([" + planetClicked.position[0] + "," + planetClicked.position[1] + "]);\" " +
          "/>";
          if (planetClicked.satelliteBuilding.name === "Spaceport") {
            var port = planetClicked.satelliteBuilding;
            if (port.orders.length > 0) {
              var order = port.orders[0];
              currentText +=
                "&nbsp;(" + order.unit.name + ", " +
                order.timeRemaining + "<img src=\"./images/time.png\" alt=\"Time\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>";
              if (port.orders.length != 1) {
                currentText += ", +" + (port.orders.length - 1) + " more";
              }
              currentText += ")";
            }
            currentText += "&nbsp;<img src=\"images/hammer.png\" alt=\"Produce\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\" "+
            "onclick=\"javascript:displaySpaceportBuildMenuFromCoord([" + planetClicked.position[0] + "," + planetClicked.position[1] + "]);\" " +
            "/>";
            if (planetClicked.order !== null) {

            }
          }
          currentText += "</h4>";
        }
      }

      currentText += "<p>" + biomeDesc[planetClicked.biome] + "</p>";

      planetTooltipHeader.html(currentText);
      //console.log(planetClicked.tiles.length);

      var assignment = calculateAssignmentPlanet(planetClicked);

      for (var j = 0; j < maxTiles; j++) {
        var planetTooltipTile = d3.select("#planet-tooltip-tile" + j);
        if (j < planetClicked.tiles.length) {
          //planetTooltipTile.html("<p>Test"+j+"<img src=\"./minerals.png\"></img></p>");
          var tile = planetClicked.tiles[j];
          var tileResourceString = "";
          //var minerals = tile.baseResources[0], energy = tile.baseResources[1], food = tile.baseResources[2];
          var total = [];
          for (var k = 0; k < tile.baseResources.length; k++) {
            total.push(tile.baseResources[k]);
          }
          if (tile.building !== null) {
            for (var k = 0; k < tile.baseResources.length; k++) {
              total[k] += tile.building.output[k];
            }
          }
          if (total[0] > 0) {
            tileResourceString += total[0] + "<img src=\"./images/minerals.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&emsp;";
          }
          if (total[1] > 0) {
            tileResourceString += total[1] + "<img src=\"./images/energy.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&emsp;";
          }
          if (total[2] > 0) {
            tileResourceString += total[2] + "<img src=\"./images/food.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&emsp;";
          }
          if (total[3] > 0) {
            tileResourceString += total[3] + "<img src=\"./images/star_research.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&emsp;";
          }
          if (total[4] > 0) {
            tileResourceString += total[4] + "<img src=\"./images/society_research.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>&emsp;";
          }
          if (total[5] > 0) {
            tileResourceString += total[5] + "<img src=\"./images/production_research.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>";
          }
          var tileInfo = "" +
            "<p>" +
            tileResourceString +
            "</p>" +
            "<p>" +
            tile.localBiome + ", " + tile.localTerrain + " " +
            "<img src=\"images/build-icon.png\" alt=\"Build\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\" "+
            "onclick=\"javascript:displayTileBuildMenu([" + planetClicked.position[0] + "," + planetClicked.position[1] + "], " + j + ")\" " +
            "/>";
          if (assignment.indexOf(j + "") !== -1) {
            tileInfo += "<img src=\"./images/population.png\" alt=\"Worker\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\" "+
              "onclick=\" \" " +
              "/>" +
              "</p>";
          }
          else {
            tileInfo += "</p>";
          }
          planetTooltipTile.html(tileInfo);
          if (tile.order !== null) {
            planetTooltipTile.html(planetTooltipTile.html() +
              "<p>Build: " + tile.order.impr.name + ", " +
              tile.order.timeRemaining + "&nbsp;<img src=\"./images/time.png\" alt=\"Time\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:100%;\"/>" +
              "</p>");
          }
          else if (tile.building === null) {
            //planetTooltipTile.html(planetTooltipTile.html() + "<p>-</p>");
          }
          else {
            planetTooltipTile.html(planetTooltipTile.html() +
              "<p>" + tile.building.name + "</p>");
          }
        }
        else {
          planetTooltipTile.html("");
        }
      }
      if (planetClicked.owner !== null) {
        var assignment = calculateAssignmentPlanet(planetClicked);
        for (var j = 0; j < maxTiles; j++) {
          var planetTooltipTile = d3.select("#planet-tooltip-tile" + j);
          if (assignment.indexOf(j + "") !== -1) {
            planetTooltipTile.style("border", "1px solid red");
          }
          else {
            planetTooltipTile.style("border", "none");
          }
        }
      }
      else {
        for (var j = 0; j < maxTiles; j++) {
          var planetTooltipTile = d3.select("#planet-tooltip-tile" + j);
          planetTooltipTile.style("border", "none");
        }
      }

      executeAsync(function() {
        updateGalaxyMap();
      });
    }

		function namePlanets() {
			for (var key in planets) {
				var planet = planets[key];
        if (planet.biome === "Asteroid") {
  				var randPlanet = Math.round(Math.random()*(planetData.length - 1));
  				planet.name = planetData[randPlanet]["pl_hostname"] + " " + planetData[randPlanet]["pl_letter"];
        }
			}
			/*for (var key in planets) {
				var planet = planets[key];
				console.log(planet.name);
			}*/
		}

    function displayPlayerResources() {
      var resourceTooltip = d3.select("#player-hud-resources");

      if (playerCiv.baseResourcesFlow[0] === undefined) {
        playerCiv.baseResourcesFlow = [0,0,0,0,0,0];
      }

      resourceTooltip.html("" +
        "&emsp;<img src=\"./images/minerals.png\" alt=\"Minerals\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + Math.trunc(playerCiv.baseResources[0]) + " / " + Math.trunc(playerCiv.baseResourcesFlow[0]) + "&emsp;&emsp;&emsp;" +
        "&emsp;<img src=\"./images/energy.png\" alt=\"Energy\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + Math.trunc(playerCiv.baseResources[1]) + " / " + Math.trunc(playerCiv.baseResourcesFlow[1]) + "&emsp;&emsp;&emsp;" +
        "&emsp;<img src=\"./images/planets.png\" alt=\"Planets\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + playerCiv.worlds.length + "&emsp;&emsp;&emsp;" +
        "&emsp;<img src=\"./images/star_research.png\" alt=\"Star Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + Math.trunc(playerCiv.baseResourcesFlow[3]) + "&emsp;&emsp;&emsp;" +
        "&emsp;<img src=\"./images/society_research.png\" alt=\"Society Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + Math.trunc(playerCiv.baseResourcesFlow[4]) + "&emsp;&emsp;&emsp;" +
        "&emsp;<img src=\"./images/production_research.png\" alt=\"Production Research\" width=\"50\" height=\"50\" style=\"max-height:20px; max-width:20px; width:10%;\"/>&emsp;" + Math.trunc(playerCiv.baseResourcesFlow[5]) + "&emsp;&emsp;&emsp;"
      );
    }

    function nameStars() {
			for (var key in stars) {
				var star = stars[key];
				var randStar = Math.round(Math.random()*(starData.length - 1));
        var displayName = starData[randStar]["Display Name"];
        var displayName2 = starData[randStar]["BayerFlamsteed"];
        if (displayName === displayName2) {
          star.name = starData[randStar]["Display Name"];
        }
        else {
  				star.name = starData[randStar]["Display Name"] + " " + starData[randStar]["BayerFlamsteed"];
        }
        star.type = starData[randStar]["Star Type"];
        //console.log(">>>" + star.type);
			}
			/*for (var key in planets) {
				var planet = planets[key];
				console.log(planet.name);
			}*/
		}

    function nameAsteroids() {
      for (var key in planets) {
        var planet = planets[key];
        if (planet.biome !== "Asteroid") {
          var randPlanet = Math.round(Math.random()*(smallBodyData.length - 1));
          planet.name = smallBodyData[randPlanet]["name"].trim();
        }
      }
    }

    function updateRender() {
      if (currentSpaceportSelected !== null) {
        displaySpaceportBuildMenu(currentSpaceportSelected);
      }
      if (currentPlanetSelected !== null) {
        displayPlanet(currentPlanetSelected);
      }
      if (currentFleetSelected !== null) {
        displayFleet(currentFleetSelected);
      }
      if (currentSectorSelected !== null) {
        //TODO: Display updated sector
        displaySector(currentSectorSelected);
      }
      displayPlayerResources();
      updateOutlineTooltip();
    }

    //Ships need to be evaluated every frame to have a relatively smooth animation
    function evaluateShips() {
      var speedMod = 0;
      if (gameMode === "Paused") {
        return;
      }
      else if (gameMode === "Slow") speedMod = 0.25;
      else if (gameMode === "Fast") speedMod = 0.5;
      else if (gameMode === "Fastest") speedMod = 1;
      //TODO: Combine moveWithinSectorOrders and moveToSectorOrders and determine which order by the orderType property
      //All ships with any orders should be in this list and removed when there are no orders of any type left.
      for (var i = moveWithinSectorOrders.length - 1; i >= 0; i--) {
        var fleet = moveWithinSectorOrders[i];
        var finalSpeed = fleet.speed*speedMod/2;
        if (fleet.orders.length <= 0) {
          moveWithinSectorOrders.splice(i, 1);
          continue;
        }
        var order = fleet.orders[0];
        //TODO: Move fleet linearly towards its destination
        var shipPos = fleet.position, shipDes = order.destination;
        var dir = [shipDes[0] - shipPos[0], shipDes[1] - shipPos[1]];
        var len = Math.sqrt(dir[0]*dir[0] + dir[1]*dir[1]);
        if (len <= finalSpeed) {
          fleet.position = shipDes;
          fleet.orders.splice(0, 1);
          continue;
        }
        dir[0] /= len; dir[1] /= len;
        fleet.position = [shipPos[0] + finalSpeed*dir[0], shipPos[1] + finalSpeed*dir[1]];
      }
      for (var i = moveToSectorOrders.length - 1; i >= 0; i--) {
        var fleet = moveToSectorOrders[i];
        var canFtlTravel = true;
        for (var j = 0; j < fleet.ships.length; j++) {
          var ship = fleet.ships[i];
          if (ship.ftl !== ship.maxFtl || ship.maxFtl === 0) {
            canFtlTravel = false;
            break;
          }
        }
        if (fleet.orders.length > 0) {
          var firstOrder = fleet.orders[0];
          if (canFtlTravel && firstOrder.orderType === "MoveToSector") {
            moveFleet(fleet, destSector, destPosition)
            moveFleet(fleet, firstOrder.destSector, firstOrder.destination);
            for (var j = 0; j < fleet.ships.length; j++) {
              var ship = fleet.ships[i];
              ship.ftl = 0;
            }
            shipRecoverFTL.push(fleet);
          }
        }
      }
    }

    function evaluateDay() {
      //Move all fleets towards destination
      //Evaluate battles and other actions like excavations
      //Evaluate construction progress and create new buildings when done
      for (var i = constructionOrders.length - 1; i >= 0; i--) {
        var order = constructionOrders[i];
        order.timeRemaining--;
        if (order.timeRemaining <= 0) {
          buildImprOnTile(order.planetPosition, order.tileNum, order.impr);
          constructionOrders.splice(i, 1);
        }
      }
      for (var i = unitOrders.length - 1; i >= 0; i--) {
        var order = unitOrders[i];
        order.timeRemaining--;
        if (order.timeRemaining <= 0) {
          //TODO: Create new fleet, merge if another fleet nearby
          bulidUnitOnSpaceport(order.owner, order.planetPosition, order.spaceport, order.unit);
          unitOrders.splice(i, 1);
        }
      }
      for (var i = satelliteOrders.length - 1; i >= 0; i--) {
        var order = satelliteOrders[i];
        order.timeRemaining--;
        if (order.timeRemaining <= 0) {
          buildSatelliteOnPlanet(order.planetPosition, order.satellite);
          satelliteOrders.splice(i, 1);
        }
      }

      for (var i = battles.length - 1; i >= 0; i--) {
        var battle = battles[i];
        advanceFleetBattleOneDay(battle);
        battle.days++;
        if (battle.days >= 30) {
          endBattle(battle);
        }
      }

      //TODO: Ideally later on here, all sectors that could possibly contain hostile interactions only are checked, not all sectors.
      /*
      This list would be updated when
      a fleet moves (current and destination),
      and when a civilization declares war/peace (all sectors with fleets belonging to the two parties)
      */
      for (var i = 0; i < civilizations.length; i++) {
        for (var j = 0; j < civilizations[i].fleets.length; j++) {
          var fleet = civilizations[i].fleets[j];
          if (fleet.inBattle || fleet.inRetreat) continue;
          var sector = fleet.sector;
          for (var k = 0; k < sector.fleets.length; k++) {
            var otherFleet = sector.fleets[k];
            if (otherFleet.inBattle || otherFleet.inRetreat) continue;
            if (isAtWar(fleet, otherFleet)) {
              //startBattle(arrayOfFleets, sector, position)
              //TODO: Look for other ships in the area
              var arrayOfFleets = [[fleet], [otherFleet]];
              startBattle(arrayOfFleets, sector, fleet.position);
            }
          }
        }
      }

      for (var i = shipRecoverFTL.length - 1; i >= 0; i--) {
        var fleet = shipRecoverFTL[i];
        var needsToRecover = false;
        for (var j = 0; j < fleet.ships.length; j++) {
          var ship = fleet.ships[j];
          if (ship.ftl < ship.maxFtl) {
            ship.ftl++;
          }
          if (ship.ftl >= ship.maxFtl) {
            ship.ftl = ship.maxFtl;
          }
          else {
            needsToRecover = true;
          }
        }
        if (!needsToRecover) {
          shipRecoverFTL.splice(i, 1);
        }
      }
      updateRender();
    }

    function evaluateMonth() {
      //Evaluate tech progress
      var totalStar = 0, totalSociety = 0, totalProduction = 0;
      for (var civIndex = 0; civIndex < civilizations.length; civIndex++) {
        var civ = civilizations[civIndex];
        civ.baseResourcesFlow = [0,0,0,0,0,0];
        civ.specialResourcesFlow = {};
        for (var key in civ.worlds) {
          var planet = civ.worlds[key];
          if (planet.owner !== null) {
            planet.tileAssignments = calculateAssignmentPlanet(planet);
            //var sumMinerals = 0, sumEnergy = 0, sumFood = 0;
            var sumYield = [0,0,0,0,0,0];
            //var maintMinerals = 0, maintEnergy = 0, maintFood = 0;
            var sumMaint = [0,0,0,0,0,0];

            var sumMod = [0,0,0,0,0,0]; //e.g. [0.2, 0, 0, 0, -0.15, 0] represents +20% minerals, -15% society research
            //TODO: Factor in resource to this, generalize with a loop
            for (var i = 0; i < planet.tileAssignments.length; i++) {
              var tile = planet.tiles[planet.tileAssignments[i]];
              for (var j = 0; j < tile.baseResources.length; j++) {
                sumYield[j] += tile.baseResources[j];
              }
              if (tile.building !== null) {
                for (var j = 0; j < tile.building.output.length; j++) {
                  sumYield[j] += tile.building.output[j];
                  sumMaint[j] += tile.building.maintenance[j];
                }
                if (tile.building.mod !== null && tile.building.mod !== undefined) {
                  for (var j = 0; j < tile.building.mod.length; j++) {
                    sumMod[j] += tile.building.mod[j];
                  }
                }
              }
              if (tile.worker !== null) {
                for (var j = 0; j < tile.worker.ethics; j++) {
                  var mod = tile.worker.ethics[i].mod;
                  for (var k = 0; k < mod.length; k++) {
                    sumMod[k] += mod[k];
                  }
                }
              }
            }

            for (var i = 0; i < planet.planetModifiers.length; i++) {
              var mod = planet.planetModifiers[i].mod;
              for (var k = 0; k < mod.length; k++) {
                sumMod[k] += mod[k];
              }
            }

            for (var i = 0; i < civ.ethics.length; i++) {
              var mod = civ.ethics[i].mod;
              for (var k = 0; k < mod.length; k++) {
                sumMod[k] += mod[k];
              }
            }

            for (var i = 0; i < civ.speciesMods.length; i++) {
              var mod = civ.speciesMods[i].mod;
              for (var k = 0; k < mod.length; k++) {
                sumMod[k] += mod[k];
              }
            }

            planet.owner.baseResources[0] += (sumYield[0] + sumMaint[0]) * (1 + sumMod[0]);
            planet.owner.baseResources[1] += (sumYield[1] + sumMaint[1]) * (1 + sumMod[1]);

            for (var i = 0; i < sumYield.length; i++) {
              civ.baseResourcesFlow[i] += (sumYield[i] + sumMaint[i]) * (1 + sumMod[i]);
            }

            totalStar += (sumYield[3] + sumMaint[3]) * (1 + sumMod[3]);
            totalSociety += (sumYield[4] + sumMaint[4]) * (1 + sumMod[4]);
            totalProduction += (sumYield[5] + sumMaint[5]) * (1 + sumMod[5]);
            /*
            sumMinerals *= planet.habitability;
            sumEnergy *= planet.habitability;
            */

            //console.log(sumMinerals + " " + sumEnergy + " " + sumFood);
            sumYield[2] = sumYield[2] - (planet.population * 1 + sumMaint[2]);
            planet.food += sumYield[2];
            if (planet.food > foodNeededToGrow) {
              if (planet.population < planet.tiles.length) {
                planet.population++;
                var newWorker = {
                  speciesName: civ.speciesName,
                  ethics: civ.ethics.slice(0)
                }
                for (var i = 0; i < planet.tiles.length; i++) {
                  var tile = planet.tiles[i];
                  if (tile.worker === null) {
                    tile.worker = newWorker;
                    break;
                  }
                }
                planet.food = Math.round(planet.food / 4);
              }
            }

            for (var specRes in planet.specialResourcesFlow) {
              if (specRes in civ.specialResourcesFlow) {
                civ.specialResourcesFlow[specRes] += planet.specialResourcesFlow[specRes];
              }
              else {
                civ.specialResourcesFlow[specRes] = planet.specialResourcesFlow[specRes];
              }
            }
          }
        }
        //TODO: Evaluate progress towards techs
        var tech = null;
        if (civ.techResearchingStar !== null) {
          tech = civ.techResearchingStar;
          tech.researchCompleted += totalStar;
          if (tech.researchCompleted >= tech.researchNeeded) {
            civ.techResearchingStar = null;
            civ.techsResearched[tech.name] = tech;
            var newChoices = findNewSetTechs(civ, tech.type);
            civ.techChoicesStar = newChoices;
          }
        }
        if (civ.techResearchingSociety !== null) {
          tech = civ.techResearchingSociety;
          tech.researchCompleted += totalSociety;
          if (tech.researchCompleted >= tech.researchNeeded) {
            civ.techResearchingSociety = null;
            civ.techsResearched[tech.name] = tech;
            var newChoices = findNewSetTechs(civ, tech.type);
            civ.techChoicesSociety = newChoices;
          }
        }
        if (civ.techResearchingProduction !== null) {
          tech = civ.techResearchingProduction;
          tech.researchCompleted += totalProduction;
          if (tech.researchCompleted >= tech.researchNeeded) {
            civ.techResearchingProduction = null;
            civ.techsResearched[tech.name] = tech;
            var newChoices = findNewSetTechs(civ, tech.type);
            civ.techChoicesProduction = newChoices;
          }
        }
      }
    }

    function initializeWorld() {
      for (var i = 0; i < civilizations.length; i++) {
        var civ = civilizations[i];
        if (civ.techLevel >= 4) {
          for (var j = 0; j < civilizations[i].worlds.length; j++) {
            var world = civilizations[i].worlds[j];
            var fleet = createFleet(world.sector, world.name + " Fleet", world.position, civilizations[i], ["Destroyer", "Destroyer", "Destroyer", "Constructor"]);
          }
          civ.techChoicesStar = findNewSetTechs(civ, "Star");
          civ.techChoicesSociety = findNewSetTechs(civ, "Society");
          civ.techChoicesProduction = findNewSetTechs(civ, "Production");
        }
        for (var j = 0; j < civilizations.length; j++) {
          if (i !== j) {
            var otherCiv = civilizations[j];
            civ.relations[otherCiv.name] = [["Peace", "Your nations are at peace.", 10, 0]];
          }
          updateRelationStats(civ);
        }
      }
      var planetPositions = Object.keys(planets);
      for (var i = 0; i < planetPositions.length; i++) {
        var planet = planets[planetPositions[i]];
        if (planet.sector.owner === null) {
          if (planet.sector.fleets.length === 0) {
            var types = Object.keys(shipAliens);
            var randomType = types[Math.trunc(Math.random()*types.length)];
            var dist = d3.random.normal(shipAliens[randomType].mean, shipAliens[randomType].stdDev);
            var shipNames = [];
            for (var i = 0; i < Math.round(dist()); i++) {
              shipNames.push(shipAliens[randomType].name);
            }
            var fleet = createFleet(planet.sector, shipAliens[randomType].name + " Aliens", planet.position, aliens, shipNames);
          }
        }
      }
      updateRender();
    }

    updateRender();

    /*function requestFullScreen(element) {
        // Supports most browsers and their versions.
        var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;

        if (requestMethod) { // Native full screen.
            requestMethod.call(element);
        } else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
            var wscript = new ActiveXObject("WScript.Shell");
            if (wscript !== null) {
                wscript.SendKeys("{F11}");
            }
        }
    }

    var elem = document.body; // Make the body go full screen.
    requestFullScreen(elem);*/

    function displayTime() {
      timeTooltip.html(
        currentDate.getFullYear() + "." +
        (currentDate.getMonth() + 1) + "." +
        currentDate.getDate() + "&emsp;" +
        gameMode
      );
    }

    function setGameSpeed(newMode) {
      gameMode = newMode;
      displayTime();
    }

    window.addEventListener("resize", updateRender);

    var timer = d3.interval(function(elapsed) {
      var advanceDay = false;
      evaluateShips();
      frames++;
      if (frames >= 8) {
        frames = 0;
      }
      if (gameMode === "Paused") {

      }
      else if (gameMode === "Slow") {
        if (frames % 8 == 0) {
          advanceDay = true;
        }
      }
      else if (gameMode === "Fast") {
        if (frames % 4 == 0) {
          advanceDay = true;
        }
      }
      else if (gameMode === "Fastest") {
        if (frames % 2 == 0) {
          advanceDay = true;
        }
      }
      if (advanceDay) {
        var currentMonth = currentDate.getMonth();
        currentDate.setDate(currentDate.getDate() + 1);
        var newMonth = currentDate.getMonth();
        if (currentMonth !== newMonth) {
          //Advance a month
          evaluateMonth();
        }
        //console.log(currentDate);

        days++;
        if (days >= 365) {
          days = 0;
        }
        evaluateDay();
      }
      displayTime();
    }, 250);

		</script>

  </body>
</html>
