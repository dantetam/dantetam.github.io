<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Piketty Wealth Inequality Simulation</title>
    
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <style>
    body,button,a,h1 {
        font-family: 'Roboto', serif;
        font-size: 16px;
    }
    </style>
    
</head>
<body>
    <svg width="1920" height="1080"></svg>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
    <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
    <script src="./svgsave.js"></script>
    
    <div class="container">

        <div class="intro">
            <br>
            <br>
            <h3>Thomas Piketty: Capital in the Twenty-First Century</h3>
            <br>
            <h4>Wealth and Income Inequalty Simulation</h4>
            <br>
            <p><i>Dante Tam, 8/13/2017</i></p>
            <br>
            <br>
            <br>
            <br>
            <br>
        </div>
    <div>
    
    <script> 

    var actors = [];

    var initNumActors = 100;
    var birthRate = 20; //per 1,000 people

    var returnRateOnCapital = 0.05; //pre-tax
    var growthRate = 0.015; //total national growth rate of the economy
    var savingRate = 0.12;

    //var baseCapitalIncomeRatio = 5; //beta, units of annual national income

    var mortalityRate = 7; //per 1,000 people
    var lifeExpectancy = 85; 

    var scaleMoney = 1000;
    
    var startingAverageIncome = 50000.0 / scaleMoney;
    var startingAverageCapital = 120000.0 / scaleMoney;
    var minimumLivingIncome = 40000.0 / scaleMoney; //after tax
    
    var numYears = 30;
    
    //2016 US tax brackets, a standard progressive income tax
    var progressiveIncomeTaxes = [
        {"income": 0 / scaleMoney, "taxRate": 0.1},
        {"income": 9275 / scaleMoney, "taxRate": 0.15},
        {"income": 37650 / scaleMoney, "taxRate": 0.25},
        {"income": 91150 / scaleMoney, "taxRate": 0.28},
        {"income": 190150 / scaleMoney, "taxRate": 0.33},
        {"income": 413350 / scaleMoney, "taxRate": 0.35},
        {"income": 415050 / scaleMoney, "taxRate": 0.396},
        {"income": 99999999, "taxRate": 1.0},
        //{"income": 999999999, "taxRate": 1.0}
    ];

    var baseLaborIncome = function(percentile) {
        var data = [
            {"percentile": 0.99, "laborIncome": 7.0},
            {"percentile": 0.9, "laborIncome": 2.0},
            {"percentile": 0.5, "laborIncome": 45.0/40.0},
            {"percentile": 0.0, "laborIncome": 0.6}
        ];
        for (var i = 0; i < data.length; i++) {
            var point = data[i];
            if (percentile > point.percentile) {
                return point.laborIncome;
            }
        }
    };

    var baseCapital = function(percentile) {
        var data = [
            {"percentile": 0.99, "laborIncome": 20.0},
            {"percentile": 0.9, "laborIncome": 30.0/9.0},
            {"percentile": 0.5, "laborIncome": 40.0/40.0},
            {"percentile": 0.0, "laborIncome": 0.2}
        ];
        for (var i = 0; i < data.length; i++) {
            var point = data[i];
            if (percentile > point.percentile) {
                return point.laborIncome;
            }
        }
    };

    //This data is evaluated every year

    //Evaluate a progressive tax based on the brackets table
    function getTaxOwed(income) {
        var bracketIndex = 0;
        var taxOwed = 0;
        while (true) {
            if (bracketIndex >= progressiveIncomeTaxes.length - 1) {
                return taxOwed + income; //Tax 100% the rest of the income above the hard limit
            }
            else if (income > 0) {
                var curBracket = progressiveIncomeTaxes[bracketIndex];
                var nextBracket = progressiveIncomeTaxes[bracketIndex + 1];
                var taxableWithinBracket = Math.min(income, nextBracket.income - curBracket.income);   
             
                taxOwed += curBracket.taxRate * taxableWithinBracket;
                income -= taxableWithinBracket;
                
                bracketIndex++;
            }
            else {
                return taxOwed;
            }
        }
    }

    //console.log(getTaxOwed(50000));

    function initActors() {
        for (var i = 0; i < initNumActors; i++) {
            var age = Math.floor(d3.randomUniform(16, 80)());
            var percentile = Math.random();
            
            var income = baseLaborIncome(percentile) * startingAverageIncome;
            var capital = baseCapital(percentile) * startingAverageCapital;
            
            var actor = {"age": age, "income": income, "capital": capital, "children": [], "percentileBirth": percentile};
            
            actors.push(actor);
        }
    }
    
    /*
    var initNumActors = 30;
    var birthRate = 20; //per 1,000 people

    var returnRateOnCapital = 0.05; //pre-tax
    var growthRate = 0.015; //total national growth rate of the economy
    var savingRate = 0.12;

    //var baseCapitalIncomeRatio = 5; //beta, units of annual national income

    var mortalityRate = 7; //per 1,000 people
    var lifeExpectancy = 85; 
    */

    function gameTurn() {
        for (var i = actors.length - 1; i >= 0; i--) {
            var actor = actors[i];
            var afterTaxIncome = getTaxOwed(actor.income);
            
            actor.capital *= 1 + returnRateOnCapital;
            
            if (afterTaxIncome >= minimumLivingIncome) {
                var savedIncome = Math.max(0, afterTaxIncome - minimumLivingIncome);
                actor.capital += savingRate * savedIncome;
            }
            
            actor.income *= 1 + growthRate;
            
            actor.age++;
            
            if (actor.age > 30) {
                var rand = Math.random();
                if (rand <= mortalityRate / 1000.0) {
                    for (var j = 0; j < actor.children.length; j++) {
                        var child = actor.children[j];
                        child.capital += actor.capital / actor.children.length;
                    }
                    actors.splice(i, 1);
                }
                else if (rand >= 1.0 - birthRate / 1000.0) {
                    var newPercentile = actor.percentileBirth + d3.randomNormal(0, 0.025)();
                    var income = baseLaborIncome(newPercentile) * startingAverageIncome;
                    var capital = baseCapital(newPercentile) * startingAverageCapital;
                    var child = {"age": 16, "income": income, "capital": capital, "children": [], "percentileBirth": newPercentile};
                    actors.push(child);
                    
                    actor.children.push(child);
                }
            }
        }   
    }
    
    function evaluateEquality() {
        var totalCapital = 0;
        var totalIncome = 0;
        
        for (var i = 0; i < actors.length; i++) {
            var actor = actors[i];
            
            totalCapital += actor.capital;
            totalIncome += actor.income;
        }
        
        console.log(totalCapital + " " + totalIncome);
        
        var percentiles = [1.0, 0.99, 0.9, 0.5, 0.0];
        
        var actorsByCapital = actors.sort(function(x, y) {
            return d3.ascending(x.capital, y.capital);
        });
        
        for (var i = 0; i < percentiles.length - 1; i++) {
            var start = Math.floor(percentiles[i+1] * actors.length);
            var end = Math.ceil(percentiles[i] * actors.length); 
            var classCapital = 0;
            var classIncome = 0;
            for (var j = start; j < end; j++) {
                var actor = actors[j];
                
                classCapital += actor.capital;
                classIncome += actor.income;
            }
            
            var capitalPercent = classCapital / totalCapital;
            var incomePercent = classIncome / totalIncome;
            
            console.log("Class between " + percentiles[i+1]*100 + " and " + percentiles[i]*100 + " percentiles");
            console.log("has " + incomePercent + "% of total income, and " + capitalPercent + "% of all capital.");
            console.log("--------");
        }
    }

    initActors();

    //console.log(actors[0]);
    //console.log(baseLaborIncome(0.57));
    
    console.log("Starting population: " + actors.length);
    
    evaluateEquality();
    for (var i = 0; i < numYears; i++) {
        gameTurn();
    }
    console.log("After " + numYears + " years...");
    evaluateEquality();
    
    console.log("Ending population: " + actors.length);

    </script>
</body>