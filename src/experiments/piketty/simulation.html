<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Piketty Wealth Inequality Simulation</title>
    
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <style>
    body,button,a,h1 {
        font-family: 'Roboto', serif;
        font-size: 16px;
    }

    h3,h4 {
        text-align: center;
        margin: auto;
    }
    
    button {
        background-color: #cccccc;
        border: 1px solid white;
        color: black; /* White text */
        padding: 5px 12px; /* Some padding */
        cursor: pointer; /* Pointer/hand icon */
        float: left; /* Float the buttons side by side */
    }

    </style>
    
    <link href="twitter_ipynb.css" rel="stylesheet">
    
</head>
<body>
    <div class="container">

        <div class="intro">
            <br>
            <br>
            <h3>Thomas Piketty: Capital in the Twenty-First Century</h3>
            <br>
            <h4>Wealth and Income Inequalty Simulation</h4>
            <br>
            <p><i>Dante Tam, 8/13/2017</i></p>
            <br>
            <br>
            <div style="position: fixed; top: 15%; left: 0;">
                <button id='toggleProgressiveWealthTax'>Progressive Wealth Tax (Off)</button><br>
                <button id='toggleCapitalGainsTax'>Capital Gains Tax (Off)</button>
            </div>
            <br>
            <br>
            <br>
        </div>
    <div>
    
    <div id="graph">
    
    </div>

    <!--<svg width="1920" height="1080"></svg>-->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
    <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
    <script src="./svgsave.js"></script>
    
    <script> 

    var actors = [];

    var progressiveWealthTaxEnabled = false;
    var capitalGainsTaxEnabled = false;
    
    var initNumActors = 1000;
    var initNumSuperManagers = 20;
    var birthRate = 15; //per 1,000 people

    //var returnRateOnCapital = 0.05; //pre-tax
    //var growthRate = 0.015; //total national growth rate of the economy
    var savingRate = 0.12;
    
    var returnRateOnCapital = 0.065; //pre-tax
    var growthRate = 0.015; //total national growth rate of the economy

    //var baseCapitalIncomeRatio = 5; //beta, units of annual national income

    var mortalityRate = 7; //per 1,000 people
    var lifeExpectancy = 85; 

    var scaleMoney = 1000;
    
    var startingAverageIncome = 40000.0 / scaleMoney;
    var startingAverageCapital = 100000.0 / scaleMoney;
    var minimumLivingIncome = 40000.0 / scaleMoney; //after tax
    
    var numYears = 60;
    
    var temporaryEmploymentRate = 0.04;
    var permanentEmploymentRate = 0.33;
    
    //2016 US tax brackets, a standard progressive income tax
    var progressiveIncomeTaxes = [
        {"income": 0 / scaleMoney, "taxRate": 0.1},
        {"income": 9275 / scaleMoney, "taxRate": 0.15},
        {"income": 37650 / scaleMoney, "taxRate": 0.25},
        {"income": 91150 / scaleMoney, "taxRate": 0.28},
        {"income": 190150 / scaleMoney, "taxRate": 0.33},
        {"income": 413350 / scaleMoney, "taxRate": 0.35},
        {"income": 415050 / scaleMoney, "taxRate": 0.396},
        {"income": 99999999, "taxRate": 1.0},
        //{"income": 999999999, "taxRate": 1.0}
    ];
    
    var capitalGainsTaxes = [
        {"income": 0 / scaleMoney, "taxRate": 0.0},
        {"income": 9275 / scaleMoney, "taxRate": 0.0},
        {"income": 37650 / scaleMoney, "taxRate": 0.15},
        {"income": 91150 / scaleMoney, "taxRate": 0.15},
        {"income": 190150 / scaleMoney, "taxRate": 0.15},
        {"income": 413350 / scaleMoney, "taxRate": 0.15},
        {"income": 415050 / scaleMoney, "taxRate": 0.20},
        {"income": 99999999, "taxRate": 1.0},
        //{"income": 999999999, "taxRate": 1.0}
    ];

    var progressiveWealthTaxes = [
        {"income": 0 / scaleMoney, "taxRate": 0.0},
        {"income": 1000000 / scaleMoney, "taxRate": 0.01},
        {"income": 5000000 / scaleMoney, "taxRate": 0.02},
        {"income": 100000000 / scaleMoney, "taxRate": 0.05},
        {"income": 1000000000 / scaleMoney, "taxRate": 0.10},
        {"income": 9999999999, "taxRate": 1.0},
        //{"income": 999999999, "taxRate": 1.0}
    ];
    
    var baseLaborIncome = function(percentile) {
        var data = [
            {"percentile": 0.99, "laborIncome": 7.0},
            {"percentile": 0.9, "laborIncome": 2.0},
            {"percentile": 0.5, "laborIncome": 45.0/40.0},
            {"percentile": 0.0, "laborIncome": 0.6}
        ];
        for (var i = 0; i < data.length; i++) {
            var point = data[i];
            if (percentile > point.percentile) {
                return point.laborIncome;
            }
        }
    };

    var baseCapital = function(percentile) {
        var data = [
            {"percentile": 0.99, "laborIncome": 20.0},
            {"percentile": 0.9, "laborIncome": 30.0/9.0},
            {"percentile": 0.5, "laborIncome": 40.0/40.0},
            {"percentile": 0.0, "laborIncome": 0.2}
        ];
        for (var i = 0; i < data.length; i++) {
            var point = data[i];
            if (percentile > point.percentile) {
                return point.laborIncome;
            }
        }
    };
    
    var margIncCapitalReturnRate = 1.0 / scaleMoney * 0.0005;

    //This data is evaluated every year

    // 2. Use the margin convention practice 
    var margin = {top: 50, right: Math.round(window.innerWidth * 0.15), bottom: 50, left: Math.round(window.innerWidth * 0.15)}, 
        width = window.innerWidth - margin.left - margin.right, // Use the window's width
        height = window.innerHeight - margin.top - margin.bottom; // Use the window's height

    //Evaluate a progressive tax based on the brackets table
    function getTaxOwed(income, dataSrc) {
        var bracketIndex = 0;
        var taxOwed = 0;
        while (true) {
            if (bracketIndex >= dataSrc.length - 1) {
                return taxOwed + income; //Tax 100% the rest of the income above the hard limit
            }
            else if (income > 0) {
                var curBracket = dataSrc[bracketIndex];
                var nextBracket = dataSrc[bracketIndex + 1];
                var taxableWithinBracket = Math.min(income, nextBracket.income - curBracket.income);   
             
                taxOwed += curBracket.taxRate * taxableWithinBracket;
                income -= taxableWithinBracket;
                
                bracketIndex++;
            }
            else {
                return taxOwed;
            }
        }
    }

    //console.log(getTaxOwed(50000));

    function initActors() {
        actors = [];
        for (var i = 0; i < initNumActors; i++) {
            var age = Math.floor(d3.randomUniform(16, 80)());
            var percentile = Math.random();
            
            var income = baseLaborIncome(percentile) * startingAverageIncome;
            var capital = baseCapital(percentile) * startingAverageCapital;
            
            var actor = {"age": age, "income": income, "capital": capital, "children": [], "percentileBirth": percentile, "alive": true};
            
            actors.push(actor);
        }
        for (var i = 0; i < initNumSuperManagers; i++) {
            var age = Math.floor(d3.randomUniform(20, 40)());
            
            var income = baseLaborIncome(percentile) * 20.0;
            var capital = baseCapital(percentile) * 100.0;
            
            var actor = {"age": age, "income": income, "capital": capital, "children": [], "percentileBirth": 1.0, "alive": true};
            
            actors.push(actor);
        }
    }

    function gameTurn() {
        for (var i = actors.length - 1; i >= 0; i--) {
            var actor = actors[i];
            if (!actor.alive) {
                continue;
            }
            
            var afterTaxIncome = getTaxOwed(actor.income, progressiveIncomeTaxes);
            
            actor.capital *= 1 + returnRateOnCapital + margIncCapitalReturnRate * actor.capital;
            
            var randEmployed = Math.random();
            if (afterTaxIncome >= minimumLivingIncome && randEmployed > temporaryEmploymentRate) {
                var savedIncome = Math.max(0, afterTaxIncome - minimumLivingIncome);
                if (capitalGainsTaxEnabled) { //TODO: Implement this correctly
                    var capitalTax = getTaxOwed(savedIncome, capitalGainsTaxes);
                    savedIncome -= capitalTax;
                }
                actor.capital += savedIncome;
            }
            
            if (progressiveWealthTaxEnabled) {
                var capitalTax = getTaxOwed(actor.capital, progressiveWealthTaxes);
                actor.capital -= capitalTax;
            }
            
            actor.income *= 1 + growthRate;
            
            actor.age++;
            
            if (actor.age > 30) {
                var rand = Math.random();
                if (rand <= mortalityRate / 1000.0) {
                    if (actor.children.length > 0) {
                        for (var j = 0; j < actor.children.length; j++) {
                            var child = actor.children[j];
                            if (child.alive) {
                                child.capital += actor.capital / actor.children.length;
                            }
                        }
                    }
                    else {
                        var share = actor.capital / (actors.length - 1);
                        for (var j = 0; j < actors.length; j++) {
                            if (i == j) {
                                continue;
                            }
                            actors[j].capital += share;
                        }
                    }
                    actors.splice(i, 1);
                    actor.alive = false;
                    continue;
                }
                else if (rand >= 1.0 - birthRate / 1000.0) {
                    var newPercentile = actor.percentileBirth + d3.randomNormal(0, 0.025)();
                    newPercentile = Math.min(0.9999, Math.max(0.0001, newPercentile));
                    //var predictedIncome = baseLaborIncome(newPercentile) * startingAverageIncome;
                    var predictedIncome = actor.income * 0.75;
                    var capital = baseCapital(newPercentile) * startingAverageCapital;
                    
                    //console.log( capital + " " + income);
                    
                    var child = {"age": 16, "income": predictedIncome, "capital": capital, "children": [], "percentileBirth": newPercentile, "alive": true};
                    actors.push(child);
                    
                    actor.children.push(child);
                }
            }
            
        }   
    }
    
    function evaluateEquality() {
        var totalCapital = 0;
        var totalIncome = 0;
        
        for (var i = 0; i < actors.length; i++) {
            var actor = actors[i];
            
            totalCapital += actor.capital;
            totalIncome += actor.income;
        }
        
        var averageCapital = totalCapital / actors.length;
        var averageIncome = totalIncome / actors.length;
        
        var capitalIncomeRatio = totalCapital / totalIncome;
        
        var percentiles = [1.0, 0.99, 0.9, 0.5, 0.0];
        
        var actorsByCapital = actors.sort(function(x, y) {
            return d3.ascending(x.capital, y.capital);
        });
        
        var capitalShareResults = [];
        var incomeShareResults = [];
        
        for (var i = 0; i < percentiles.length - 1; i++) {
            var start = Math.floor(percentiles[i+1] * actors.length);
            var end = Math.ceil(percentiles[i] * actors.length); 
            var classCapital = 0;
            var classIncome = 0;
            for (var j = start; j < end; j++) {
                var actor = actors[j];
                
                classCapital += actor.capital;
                classIncome += actor.income;
            }
            
            var capitalPercent = classCapital / totalCapital;
            var incomePercent = classIncome / totalIncome;
            
            //console.log("Class between " + percentiles[i+1]*100 + " and " + percentiles[i]*100 + " percentiles");
            //console.log("has " + incomePercent + "% of total income, and " + capitalPercent + "% of all capital.");
            //console.log("--------");
            
            capitalShareResults.push(capitalPercent);
            incomeShareResults.push(incomePercent);
        }
        
        //console.log("The average capital wealth is: " + averageCapital);
        //console.log("The average income is: " + averageIncome);
        //console.log("The capital income ratio: " + capitalIncomeRatio);
        //console.log("----------------------------------");
        
        return [percentiles, capitalShareResults, incomeShareResults, averageCapital, averageIncome, capitalIncomeRatio];
    }
    
    function sumArr(arrays) {
        var result = [];
        for (var i = 0; i < arrays.length; i++) {
            for (var j = 0; j < arrays[i].length; j++) {
                if (result.length <= j) {
                    result.push(arrays[i][j]);
                }
                else {
                    result[j] += arrays[i][j];
                }
            }
        }
        return result;
    }
    
    function addSvgGraph(graphLabel, xScale, yScale) {
        var totalWidth = width + margin.left + margin.right;
        var totalHeight = height + margin.top + margin.bottom;
        
        var svg = d3.select("body").append("svg")
            .attr("width", totalWidth)
            .attr("height", totalHeight)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        svg.append("text")
            .attr("x", width / 2.0)
            .attr("y", 0)
            .attr("dy", ".35em")
            .style("font-size", "30px")
            .text(graphLabel);
            
        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .style("fill", "none")
            .style("stroke", "#000")
            .style("font-size", "16px")
            .call(d3.axisBottom(xScale));
        svg.append("g")
            .attr("class", "y axis")
            .style("fill", "none")
            .style("stroke", "#000")
            .style("font-size", "16px")
            .call(d3.axisLeft(yScale));   
            
        return svg;
    }
    
    function addLineToSvg(svg, data, line, dataName) {
        svg.append("path")
            .datum(data) 
            .attr("class", "line")
            .style("fill", "none")
            .style("stroke", "#000")
            .attr("d", line);
            
        svg.append("text")
            .attr("x", 15)
            .attr("y", function() {
                var yScale = line.y();
                return yScale(data[0]) + 25;
            })
            .attr("dy", "0.0em")
            .style("font-size", "20px")
            .text(dataName);
    }
    
    function initSimulation() {
        d3.selectAll("svg").remove();
    
        initActors();

        //console.log(actors[0]);
        //console.log(baseLaborIncome(0.57));
        
        console.log("Starting population: " + actors.length);
        
        var data = evaluateEquality();

        var capitalShareResults = [];
        var avgCapitalResults = [];
        var avgIncomeResults = [];
        var capitalIncomeRatioResults = [];
        for (var i = 0; i < data[0].length - 1; i++) {
            capitalShareResults.push([]);
        }
        for (var i = 0; i < numYears; i++) {
            gameTurn();
            var data = evaluateEquality();
            for (var j = 0; j < data[0].length - 1; j++) {
                capitalShareResults[j].push(data[1][j]);
            }
            avgCapitalResults.push(data[3]);
            avgIncomeResults.push(data[4]);
            capitalIncomeRatioResults.push(data[5]);
        }
        
        console.log(capitalShareResults);
        
        console.log("Ending population: " + actors.length);

        console.log(avgCapitalResults);
        console.log(avgIncomeResults);
        
        //Render all the data found previously
        
        //var renderData = [0.10, 0.20, 0.30, 0.40, 0.10, 0.20, 0.30, 0.40, 0.0, -0.10, 0.20, 0.30, 0.10];
        
        var reversedResults = capitalShareResults.reverse();
        
        var compiledResults = [];
        for (var i = 1; i <= reversedResults.length; i++) {
            var arrays = [];
            for (var j = 0; j < i; j++) {
                arrays.push(reversedResults[j]);
            }
            compiledResults.push(sumArr(arrays));
        }        
          
        // The number of datapoints
        var n = compiledResults[0].length;

        // 5. X scale will use the index of our data
        var xScale = d3.scaleLinear()
            .domain([0, n-1]) // input
            .range([0, width]); // output

        // 6. Y scale will use the randomly generate number 
        var yScale = d3.scaleLinear()
            .domain([0, 1]) // input 
            .range([height, 0]); // output 
            
        // 7. d3's line generator
        var line = d3.line()
            .x(function(d, i) { return xScale(i); }) // set the x values for the line generator
            .y(function(d) { return yScale(d); }) // set the y values for the line generator 
            .curve(d3.curveMonotoneX) // apply smoothing to the line    
            
        // 1. Add the SVG to the page and employ #2
        var svg = addSvgGraph("Inequality of capital", xScale, yScale);

        addLineToSvg(svg, compiledResults[3], line, ">99th Percentile");
        addLineToSvg(svg, compiledResults[2], line, "90-99th Percentile");
        addLineToSvg(svg, compiledResults[1], line, "50-90th Percentile");
        addLineToSvg(svg, compiledResults[0], line, "<50th Percentile");

            
        var xScale = d3.scaleLinear()
            .domain([0, n-1]) // input
            .range([0, width]); // output

        // 6. Y scale will use the randomly generate number 
        var yScale = d3.scaleLinear()
            .domain([0, 1000]) // input 
            .range([height, 0]); // output     
            
        var svg = addSvgGraph("Average capital and income", xScale, yScale);
            
        addLineToSvg(svg, avgCapitalResults, line, "Average Capital");
        addLineToSvg(svg, avgIncomeResults, line, "Average Income");
        
        
        
       
        
        var xScale = d3.scaleLinear()
            .domain([0, n-1]) // input
            .range([0, width]); // output

        // 6. Y scale will use the randomly generate number 
        var yScale = d3.scaleLinear()
            .domain([0, 25]) // input 
            .range([height, 0]); // output 
            
        var svg = addSvgGraph("Capital to income ratio", xScale, yScale);
            
        addLineToSvg(svg, capitalIncomeRatioResults, line, "Capital/Income Ratio");
    }
    
    var wealthTaxButton = d3.select("#toggleProgressiveWealthTax");
    var capitalTaxButton = d3.select("#toggleCapitalGainsTax");
   
    wealthTaxButton.on("click", function() {
        progressiveWealthTaxEnabled = !progressiveWealthTaxEnabled;
        initSimulation();
        if (progressiveWealthTaxEnabled) {
            d3.select(this).text("Progressive Wealth Tax (On)");
        }
        else {
            d3.select(this).text("Progressive Wealth Tax (Off)");
        }
    });
    capitalTaxButton.on("click", function() {
        capitalGainsTaxEnabled = !capitalGainsTaxEnabled;
        initSimulation();
        if (capitalGainsTaxEnabled) {
            d3.select(this).text("Capital Gains Tax (On)");
        }
        else {
            d3.select(this).text("Capital Gains Tax (Off)");
        }
    });
    
    initSimulation();
    
    
    </script>
</body>