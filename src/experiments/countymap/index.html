<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>US Census Visuals</title>
    
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <style>
    body,button,a,h1 {
        font-family: 'Roboto', serif;
        font-size: 16px;
    }
    
    html { overflow-y: hidden; }
    
    .counties {
        fill: none;
    }

    .states {
        fill: none;
        stroke: #fff;
        stroke-linejoin: round;
    }

    #aboutText {
        font-size: 16px;
    }

    #mapChoices {
        opacity: 0;
        background-color: rgba(255, 255, 255, 0.0);
    }

    #mapchoices button {
        background-color: #cccccc;
        border: 1px solid white;
        color: black; /* White text */
        padding: 5px 12px; /* Some padding */
        cursor: pointer; /* Pointer/hand icon */
        float: left; /* Float the buttons side by side */
    }

    /* Clear floats (clearfix hack) */
    #mapchoices:after {
        content: "";
        clear: both;
        display: table;
        opacity: 0;
        background-color: rgba(255, 255, 255, 0.0);
    }

    #mapchoices button:not(:last-child) {
        border-right: none; /* Prevent double borders */
    }

    /* Add a background color on hover */
    #mapchoices button:hover {
        background-color: #ff3b30;
    }

    #mapchoices #current {
        background-color: #ff3b30;
    }

    #saveButton, #toggleMenu, #resetMap {
        background-color: #ffaaaa;
        border: 1px solid white;
        color: black; /* White text */
        padding: 5px 12px; /* Some padding */
        cursor: pointer; /* Pointer/hand icon */
        float: left; /* Float the buttons side by side */
        font-size: 16px;
    }

    .svg {
        overflow: hidden;
    }

    </style>
</head>
<body>
    <div id="mapchoices">
      
    </div>
    <div id="aboutText">
      
    </div>
    <button id='saveButton'>Save Map as PNG</button>
    <button id='toggleMenu'>Toggle Menu On/Off</button>
    <button id='resetMap'>Reset Map View</button>
    <!--<button id='saveButton'>Download this data</button>-->
    &emsp;
    <a href="./censusdata.zip">Download All Data (ZIP)</a>
    &emsp;
    <a href="./totalCountyCensusData.csv">Download Summary Data (CSV)</a>
    <svg width="1920" height="1080"></svg>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
    <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
    <script src="./svgsave.js"></script>
    <script>
    
    function dictionaryAdd() {
        var result = d3.map();
        for (var i = 0; i < arguments.length; i++) {
            var d3map = arguments[i];
            var entries = d3map.entries();
            for (var j = 0; j < entries.length; j++) {
                var key = entries[j][0], value = entries[j][1];
                if (result.get(key) === undefined) {
                    result.set(key, 0);
                }
                result.set(num(result.get(key)) + num(value));
            }
        }
        return result;
    }
    
    function dictionaryDivide(dividend, divisor) { //returns dividend / divisor, key by key
        var result = d3.map();
        var entries = dividend.entries();
        for (var j = 0; j < entries.length; j++) {
            var key = entries[j]["key"], value = entries[j]["value"];
            if (divisor.get(key) === undefined) {
                
            }
            else {
                /*
                console.log(value);
                console.log(divisor.get(key));
                console.log(num(value))
                console.log(num(divisor.get(key)))
                console.log("--------");
                */
                result.set(key, num(value) / num(divisor.get(key)))
            }
        }
        return result;
    }
    
    //console.log(dictionaryDivide(d3.map().set("a", 1.0), d3.map().set("a", 2.0)));
    
    function arrayDivide(dividend, divisor) {
        //Find all common entries first
        /*
        var result = d3.map();
        var common = {};
        for (var i = 0; i < dividend.length; i++) {
            common[dividend[i]["key"]] = 1;
        }
        for (var i = 0; i < divisor.length; i++) {
            common[divisor[i]["key"]]++;
        }
        for (var key in common) {
            
        }
        for (var i = 0; i < dividend.length; i++) {
            var posKey = dividend[i]["key"];
            if (common.hasOwnProperty(posKey)) {
                if (common[posKey] === 2) {
                    var a = num(dividend);
                    result.put(dividend[i]["key"])
                }
            }
        }
        */
        var mapA = d3.map();
        var mapB = d3.map();
        for (var i = 0; i < dividend.length; i++) {
            var key = dividend[i]["key"];
            var value = dividend[i]["value"];
            mapA.set(key, value);
        }
        for (var i = 0; i < divisor.length; i++) {
            var key = divisor[i]["key"];
            var value = divisor[i]["value"];
            mapB.set(key, value);
        }
        return dictionaryDivide(mapA, mapB);
    }

    //var mode = "Unemployment";
    //var mode = "Income";
    //var mode = "Poverty";
    var mode = null; // = "MiningQuarryingOilGas";

    //Sort the total data into many individual files        
    allModes = {
            "Unemployment" : "unemployment.csv|id|rate",
            "Income" : "povertyincome.csv|County ID|Median Household Income in Dollars",
            "Poverty" : "povertyincome.csv|County ID|All Ages in Poverty Percent",
            "PopulationDensity" : "./populationdensity/DEC_00_SF1_GCTPH1.US05PR.csv|CountyID|DENSITY_SQ_MILE",
            "SubstanceAbuse" : "./substanceabuse/substanceabuseProcessed.csv|FIPS|EstimatedAgeAdjustedDeathRateMin",
            "GDPPerCapita" : "./gdppercapita/gdppercapitaProcessedId.csv|CountyId|PerCapitaIncome",
            "Gini" : "./giniequality/processedGini.csv|CountyId|GiniMeasure",
            
            //"PopulationPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC01",
            "WhiteOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC20",
            "BlackOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC21",
            "IndianOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC22",
            "AsianOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC23",
            "PacificIslanderOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC24",
            "OtherOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC25",
            "MultiOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC26",
            "HispanicOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC28",
            
            /*
            "WhitePercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalWhiteOrigin"
                ],
                "function" : function(d) {
                    console.log(d["TotalPopulation"]);
                    console.log(d["TotalWhiteOrigin"]);
                    return arrayDivide(d["TotalPopulation"], d["TotalWhiteOrigin"]);
                }   
            },
            "BlackPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalBlackOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalBlackOrigin"]);
                }   
            },
            "IndianPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalIndianOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalIndianOrigin"]);
                }   
            },
            "AsianPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalAsianOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalAsianOrigin"]);
                }   
            },
            "PacificIslanderPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalPacificIslanderOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalPacificIslanderOrigin"]);
                }   
            },
            "OtherPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalOtherOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalOtherOrigin"]);
                }   
            },
            "MultiPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalMultiOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalMultiOrigin"]);
                }   
            },
            "HispanicPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalHispanicOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalHispanicOrigin"]);
                }   
            }
            */
        };
        
    industryStrings = ["AllSectors",
            "AgricultureForestryFishingHunting",
            "MiningQuarryingOilGas",
            "Utilities",
            "Construction",
            "Manufacturing",
            "WholesaleTrade",
            "RetailTrade",
            "TransportationWarehousing",
            "Information",
            "FinanceInsurance",
            "RealEstate",
            "ProfessionalScientificTechnical",
            "Management",
            "AdministrativeSupportWaste",
            "Education",
            "HealthcareSocialAssistance",
            "ArtsEntertainmentRecreation",
            "AccommodationFood",
            "OtherServices",
            "IndustriesNotClassified"
    ];
            
    educationStrings = [
            "Total1824",
            "LHS1824",
            "HS1824",
            "SC1824",
            "BH1824",
            "TotalG25",
            "L9G25",
            "912G25",
            "HSG25",
            "SCG25",
            "ADG25",
            "BDG25",
            "GPG25"
    ];
        
    workforcePercentageStrings = [
        "NaturalResources", "Construction", "Manufacturing", "WholesaleTrade", "RetailTrade", 
        "TransportationUtilities", "Information", "Finance", "ProfessionalScientific", "Education", 
        "ArtsEntertainment", "OtherServices", "Administration"
    ];
        
    //Organize all data by type i.e. income, unemployment, etc.
    for (var i = 0; i < industryStrings.length; i++) {
        industryString = industryStrings[i];
        constr = "./businessbycounty/processed/" + industryString + ".csv|GEO.id2|PAYANN";
        allModes[industryString] = constr;
    }
        
    for (var i = 0; i < educationStrings.length; i++) {
        educationString = educationStrings[i];
        constr = "./education/simplifiedEducationCount.csv|CountyID|" + educationString;
        allModes[educationString] = constr;
    }
    
    for (var i = 0; i < workforcePercentageStrings.length; i++) {
        workforcePercentageString = workforcePercentageStrings[i]
        constr = "./industry/industryPercentageProcessed.csv|CountyId|" + workforcePercentageString;
        allModes["WorkforcePercentage" + workforcePercentageString] = constr;
    }
    
    var allModesDesc = {
        "Unemployment" : null,
        "Income" : null,
        "Poverty" : null,
        "PopulationDensity" : null,
        "SubstanceAbuse" : null,
        "GDPPerCapita" : null,
        "AllSectors" : null,
        "AgricultureForestryFishingHunting" : null,
        "MiningQuarryingOilGas" : null,
        "Utilities" : null,
        "Construction" : null,
        "Manufacturing" : null,
        "WholesaleTrade" : null,
        "RetailTrade" : null,
        "TransportationWarehousing" : null,
        "Information" : null,
        "FinanceInsurance" : null,
        "RealEstate" : null,
        "ProfessionalScientificTechnical" : null,
        "Management" : null,
        "AdministrativeSupportWaste" : null,
        "Education" : null,
        "HealthcareSocialAssistance" : null,
        "ArtsEntertainmentRecreation" : null,
        "AccommodationFood" : null,
        "OtherServices" : null,
        "IndustriesNotClassified" : null,
        "Total1824" : "Number of people aged 18-24",
        "LHS1824" : "Number of people aged 18-24",
        "HS1824" : "Of ages 18-24, completed high school or higher",
        "SC1824" : "Of ages 18-24, completed some college or higher",
        "BH1824" : "Of ages 18-24, completed bachelors or higher",
        "TotalG25" : "Number of people aged 25+",
        "L9G25" : "Of ages 18-24, did not complete 9th grade",
        "912G25" : "Of ages 18-24, completed some high school or higher",
        "HSG25" : "Of ages 18-24, completed high school diploma or higher",
        "SCG25" : "Of ages 18-24, completed some college or higher",
        "ADG25" : "Of ages 18-24, completed associate's degree or higher",
        "BDG25" : "Of ages 18-24, completed bachelor's degree or higher",
        "GPG25" : "Of ages 18-24, completed post-grad degree"
    };

    var mapMenu = d3.select("#mapchoices");
    var aboutText = d3.select("#aboutText");

    var menuVisible = true;
    
    function getQueryVariable(variable)
    {
           var query = window.location.search.substring(1);
           var vars = query.split("&");
           for (var i=0;i<vars.length;i++) {
                   var pair = vars[i].split("=");
                   if(pair[0] == variable){return pair[1];}
           }
           return(false);
    }

    function num(input) {
        //if (x == null || isNaN(x)) return null;
        if (typeof input === "string") {
            n = input.replace(/[^0-9.]/g, "");
        }
        else {
            n = input;
        }
        if (!isNaN(parseFloat(n)) && isFinite(n)) {
            return n;
        }
        return null;
    }
    
    function numberWithCommas(x) {
        if (x == null) return "";
        var parts = x.toString().split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
    }

    function percentage(d) {
        return countyNameById.get(d.id) + ": " + d.rate + "%";
    }
    function dollars(d) {
        return countyNameById.get(d.id) + ": " + "$" + numberWithCommas(d.rate);
    }
    function dollarsTimesThousand(d) {
        return countyNameById.get(d.id) + ": " + "$" + numberWithCommas(d.rate * 1000);
    }
    function rawText(d) {
        return countyNameById.get(d.id) + ": " + numberWithCommas(d.rate);
    }
    
    //General template for json/csv callback
    //variables: selectedMapping - d3 map, clickAction(d) - function, getText(d) - function
    //TODO: Implement this
    function jsonCsvDataReady(error, us) {
      if (error) throw error;

      container.append("g")
          .attr("class", "counties")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.counties).features)
        .enter().append("path")
          .attr("fill", function(d) { return color(d.rate = dataMap.get(d.id)); })
          .attr("d", path)
          .on("click", function(d) {console.log(d);})
          //.attr("countyid", function(d) { return d.id; })
        .append("title")
          .text(function(d) { return getTextFunction(d); });
          
      container.append("path")
          .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
          .attr("class", "states")
          .attr("d", path);
    }

    //TODO: Turn this into a utility method and not some hard-coded spaghetti
    var educationType = "";
    var higher1824 = [
        "LHS1824","HS1824","SC1824","BH1824"
    ];
    var higherG25 = [
        "L9G25","912G25","HSG25","SCG25","ADG25","BDG25","GPG25"
    ];  
    function educationReady(error, us) {
      if (error) throw error;
      
      container.append("g")
          .attr("class", "counties")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.counties).features)
        .enter().append("path")
          .attr("fill", function(d) {
            if (educationType === "Total1824") {
                return color(d.rate = dataMap.get(d.id)["Total1824"]); 
            }
            else if (educationType === "TotalG25") {
                return color(d.rate = dataMap.get(d.id)["TotalG25"]);
            }
            var percentage = 0;
            if (educationType.indexOf("1824") != -1) {
                var index = higher1824.indexOf(educationType);
                var count = 0;
                var total = dataMap.get(d.id)["Total1824"];
                for (var i = index; i < higher1824.length; i++) {
                    count = count + dataMap.get(d.id)[higher1824[i]];
                }
                percentage = count / total;
            }
            else if (educationType.indexOf("G25") != -1) {
                var index = higherG25.indexOf(educationType);
                var count = 0;
                var total = dataMap.get(d.id)["TotalG25"];
                for (var i = index; i < higherG25.length; i++) {
                    count = count + dataMap.get(d.id)[higherG25[i]];
                }
                percentage = count / total;
            }
            return color(d.rate = percentage); 
          })
          .attr("d", path)
          .on("click", function(d) {console.log(d.id); })
          //.attr("countyid", function(d) { return d.id; })
        .append("title")
          .text(function(d) { return countyNameById.get(d.id) + ": " + numberWithCommas(d.rate); });

      container.append("path")
          .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
          .attr("class", "states")
          .attr("d", path);
    }

    var maptype = getQueryVariable("maptype");
    if (maptype && $.inArray(maptype, allModes.keys()) != -1) {
        mode = maptype;
    }
    else {
        //console.log("Invalid map URL parameter: " + maptype);
    }

    // Define the div for the tooltip
    var divTooltip = d3.select("body").append("div")	
        .attr("class", "tooltip")				
        .style("opacity", 0);  

    var color = null;
    var title = "Default Title";
    var desc = "Default Description";
    var desc2 = "Default Extended Description"

    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");
        
    var container = svg.append("g");


    var dataMap = d3.map();

    var path = d3.geoPath();

    var g = container.append("g")
        .attr("class", "key")
        .attr("transform", "translate(0,40)");
        
    var countyNameById = d3.map();
     
    var getTextFunction = null;
        
    function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    } 

    function loadAboutText() {
        mapMenu.selectAll("*").remove();
        mapMenu.html("");
        for (var chooseMode in allModes) {
            if (allModes.hasOwnProperty(chooseMode)) {
                //var chooseMode = allModes[i];  
                var id = chooseMode == mode ? "current" : "";
                var title = allModesDesc[chooseMode] == null ? chooseMode + " per County" : allModesDesc[chooseMode];
                var button = mapMenu.append("button").text(chooseMode).attr("title", title).attr("id", id).on("click", function() {
                    console.log(this.textContent);
                    loadMapWithMode(this.textContent);
                    //window.history.pushState('index', this.textContent, '/index.html');
                    //console.log("Redirect " + "./index.html?maptype=" + mode);
                    //window.location.href = "index.html?maptype=" + new String(mode);
                    //window.location.href = "./index.html?maptype=" + mode;
                    //window.location.reload();
                });
            }
        }
        mapMenu.append("button").text("Urban Centers").attr("title", "Urban Centers").on("click", function() {
            console.log(this.textContent);
            window.location.href = "./urbancenters/urbancenters.html";
        });
        mapMenu.append("button").text("Closest Urban Centers").attr("title", "Closest Urban Centers").on("click", function() {
            console.log(this.textContent);
            window.location.href = "./urbancenters/urbancentersvoronoi.html";
        });
        
        //console.log(mapMenu.html());
        //mapMenu.html(mapMenu.html() + "<p>Description</p>");
        //console.log(mapMenu.html());
        
        aboutText.html(
            "<p>A visualization of US Census data in d3.js. Data is represented county per county.</p>" +
            "<p>This data includes household income, poverty, industry statistics, education completions, and more.</p>" +
            "<p>In this project we learn about the demographics of the United States and what affects people's living conditions and communities.</p>"
        );
    }    
     
    function loadCsvAndCallBack(dataString, callback, dataMap) {
        var tokens = dataString.split("|");
        var csvFileName = tokens[0], idColumnName = tokens[1], dataColumnName = tokens[2];
        
        d3.queue()
            .defer(d3.json, "https://d3js.org/us-10m.v1.json")
            .defer(d3.csv, csvFileName, function(d) { 
                var income = 0;
                if (d[dataColumnName] === undefined) { //Account for possibly empty lines
                    income = 0;
                }
                else {
                    income = num(d[dataColumnName]);
                    dataMap.set(d[idColumnName], +income);
                }
            })
            .await(callback);
    }
     
    function loadMapWithMode(mode) {
        //Initialize everything, possibly or not for the first time, so we can redraw
    
        if (mode == null) {
            loadAboutText();
            return;
        }
        else {
            aboutText.html("");
        }

        svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height");
            
        
        //TODO: Replace with a solution that updates the whole map insteading of replacing it
        svg.selectAll("*").remove();

        container = svg.append("g");
        
        dataMap = d3.map();
       
        path = d3.geoPath();

        countyNameById = d3.map();
        
        getTextFunction = null;
        
        //console.log(svg.select("g"));
        
        g = container.append("g")
            .attr("class", "key")
            .attr("transform", "translate(0,40)");
            
        //Buttons at the top where the user can switch modes    
        mapMenu.selectAll("*").remove();
        mapMenu.html("");
        for (var chooseMode in allModes) {
            if (allModes.hasOwnProperty(chooseMode)) {
                //var chooseMode = allModes[i];  
                var id = chooseMode == mode ? "current" : "";
                var title = allModesDesc[chooseMode] == null ? chooseMode + " per County" : allModesDesc[chooseMode];
                var button = mapMenu.append("button").text(chooseMode).attr("title", title).attr("id", id).on("click", function() {
                    console.log(this.textContent);
                    loadMapWithMode(this.textContent);
                    //window.history.pushState('index', this.textContent, '/index.html');
                    //console.log("Redirect " + "./index.html?maptype=" + mode);
                    //window.location.href = "index.html?maptype=" + new String(mode);
                    //window.location.href = "./index.html?maptype=" + mode;
                    //window.location.reload();
                });
            }
        }
        mapMenu.append("button").text("Urban Centers").attr("title", "Urban Centers").on("click", function() {
            console.log(this.textContent);
            window.location.href = "./urbancenters/urbancenters.html";
        });
        mapMenu.append("button").text("Closest Urban Centers").attr("title", "Closest Urban Centers").on("click", function() {
            console.log(this.textContent);
            window.location.href = "./urbancenters/urbancentersvoronoi.html";
        });

        //Load in the official full list of counties
        d3.queue()
            .defer(d3.csv, "./countyIdByNameProcessed.csv", function(d) { 
                //console.log(d);
                //console.log(d["TotalCountyId"] + ", " + d["CountyName"]);
                if (d["TotalCountyId"] === null) {
                
                }
                else {
                    countyNameById.set(d["TotalCountyId"], d["CountyName"] + ", " + d["StateAbbr"]); 
                }
            });

        //TODO: Do not hardcode this data
        if (mode === "Unemployment") {  
            color = d3.scaleThreshold()
                .domain(d3.range(2, 10))
                .range(d3.schemeBlues[9]);
            title = "Unemployment";  
            desc = "Unemployment percentage per county";
            x = d3.scaleLinear().domain([2, 10]).rangeRound([450, 900]);
            getTextFunction = percentage;
        }
        else if (mode === "Income") {
            color = d3.scaleThreshold()
                .domain(d3.range(20000, 100000, 10000))
                .range(d3.schemeGreens[9]);
            title = "Median Household Income"; 
            desc = "Median household income by county";        
            x = d3.scaleLinear().domain([20000, 100000, 10000]).rangeRound([450, 900]);  
            getTextFunction = dollars;
        }
        else if (mode === "Poverty") {
            color = d3.scaleThreshold()
                .domain(d3.range(6, 36, 3))
                .range(d3.schemeReds[9]);
            x = d3.scaleLinear()
                .domain([6, 36, 3])
                .rangeRound([450, 900]);
            title = "Percentage under Poverty Line";
            desc = "Percentage of people below poverty line per county";    
            getTextFunction = percentage;
        }
        else if (mode === "PopulationDensity") {
            color = d3.scaleThreshold()
                .domain([0, 10, 50, 100, 350, 1000, 2500, 5000, 10000, 50000])
                .range(d3.schemeReds[9]);
            title = "Population Density";
            desc = "Population Density per County per Square Mile";
            x = d3.scaleQuantize()
              .domain([0, 10, 50, 100, 350, 1000, 2500, 5000, 10000, 50000])
              .range([450, 900]);
            getTextFunction = rawText;
        }
        else if (mode === "SubstanceAbuse") {
            color = d3.scaleThreshold()
                .domain([0, 2, 4, 8, 12, 16, 20, 24, 28, 32])
                .range(d3.schemeReds[9]); 
            title = "Substance Abuse";
            desc = "Substance Abuse per County";
            x = d3.scaleQuantize()
              .domain([0, 2, 4, 8, 12, 16, 20, 24, 28, 32])
              .range([450, 900]);
            getTextFunction = rawText;
        }
        else if (mode === "GDPPerCapita") {  
            color = d3.scaleThreshold()
                .domain([0, 19000, 20900, 22000, 23100, 24750, 27250, 30000, 35000, 70000])
                .range(d3.schemeGreens[9]);
            title = "GDP per Capita";
            desc = "GDP per Capita per County";
            x = d3.scaleQuantize()
              .domain([0, 19000, 20900, 22000, 23100, 24750, 27250, 30000, 35000, 70000])
              .range([450, 900]);
            getTextFunction = dollars;
        }
        else if (mode === "Gini") {  
            color = d3.scaleThreshold()
                .domain(d3.range(0.35, 0.65, 0.05))
                .range(d3.schemeReds[6]);
            title = "Gini Inequality";
            desc = "Gini Inequality Index per County";
            x = d3.scaleQuantize()
              .domain(d3.range(0.35, 0.65, 0.05))
              .range([450, 900]);
            getTextFunction = percentage;
        }
        else if ($.inArray(mode, industryStrings) != -1) {   
            title = mode;
            
            desc = "Annual Payroll per County and Industry";
            
            x = null;
              
            if (mode === "AllSectors") {
                color = d3.scaleThreshold()
                    .domain([0, 100000, 300000, 1000000, 2500000, 10000000, 25000000, 100000000])
                    .range(d3.schemeReds[7]);
                    
                x = d3.scaleQuantize()
                  .domain([0, 100000, 300000, 1000000, 2500000, 10000000, 25000000, 100000000])
                  .range([450, 900]);
            }
            else {
                color = d3.scaleThreshold()
                    .domain([0, 1000, 10000, 50000, 200000, 500000, 1000000, 2500000, 10000000])
                    .range(d3.schemeReds[8]);
            
                x = d3.scaleQuantize()
                    .domain([0, 1000, 10000, 50000, 200000, 500000, 1000000, 2500000, 10000000])
                    .range([450, 900]);
            }
            
            getTextFunction = dollarsTimesThousand;
        }
        else if (mode === "Total1824" || mode === "TotalG25") {
            color = d3.scaleThreshold()
                .domain([0, 500, 2500, 10000, 50000, 100000, 250000, 1000000, 2500000, 5000000])
                .range(d3.schemeReds[9]);
             
            title = mode;
            
            desc = "Total population of age group in county";
            
            x = d3.scaleQuantize()
              .domain([0, 500, 2500, 10000, 50000, 100000, 250000, 1000000, 2500000, 5000000])
              .range([450, 900]);
                
            educationType = mode;
            
            getTextFunction = rawText;
            
            d3.queue()
                .defer(d3.json, "https://d3js.org/us-10m.v1.json")
                .defer(d3.csv, "./education/simplifiedEducationCount.csv", function(d) { 
                    addData = {};
                    //var educationModes = [
                        //"Total1824","LHS1824","HS1824","SC1824","BH1824","TotalG25","L9G25","912G25","HSG25","SCG25","ADG25","BDG25","GPG25"
                    //];
                    for (var i = 0; i < educationStrings.length; i++) {
                        addData[educationStrings[i]] = +d[educationStrings[i]];
                    }
                    dataMap.set(d["CountyID"], addData);
                })
                .await(educationReady);
        }
        else if ($.inArray(mode, educationStrings) != -1) {
            color = d3.scaleThreshold()
                .domain([0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0])
                .range(d3.schemeReds[9]);

            title = mode;    

            desc = "Percentage of people in age-group and county who have completed this degree or greater";
            
            x = d3.scaleLinear()
                .domain([0.1, 1, 0.1])
                .rangeRound([450, 900]);
            
            educationType = mode;
            
            getTextFunction = rawText;
            
            d3.queue()
                .defer(d3.json, "https://d3js.org/us-10m.v1.json")
                .defer(d3.csv, "./education/simplifiedEducationCount.csv", function(d) { 
                    addData = {};
                    //var educationModes = [
                        //"Total1824","LHS1824","HS1824","SC1824","BH1824","TotalG25","L9G25","912G25","HSG25","SCG25","ADG25","BDG25","GPG25"
                    //];
                    for (var i = 0; i < educationStrings.length; i++) {
                        addData[educationStrings[i]] = +d[educationStrings[i]];
                    }
                    dataMap.set(d["CountyID"], addData);
                })
                .await(educationReady);
        }
        else if (mode.includes("Percentage")) {
            smallPercentageModes = [
                "IndianOriginPercentage", 
                "AsianOriginPercentage", 
                "PacificIslanderOriginPercentage", 
                "OtherOriginPercentage", 
                "MultiOriginPercentage"
            ];
            title = mode;    
            desc = mode;
            getTextFunction = percentage;
           
            if ($.inArray(mode, smallPercentageModes) !== -1 || $.inArray(mode, workforcePercentageStrings) !== -1) {
                color = d3.scaleThreshold()
                    .domain([0, 5, 10, 15, 20, 25, 30, 35, 40, 45])
                    .range(d3.schemeBlues[9]);
                
                x = d3.scaleLinear()
                    .domain([0, 5, 10, 15, 20, 25, 30, 35, 40, 45])
                    .rangeRound([450, 900]);
            }
            else {
                color = d3.scaleThreshold()
                    .domain([0, 10, 20, 30, 40, 50, 60, 70, 80, 90])
                    .range(d3.schemeBlues[9]);
                
                x = d3.scaleLinear()
                    .domain([0, 10, 20, 30, 40, 50, 60, 70, 80, 90])
                    .rangeRound([450, 900]);
            }
            
        }
        else {
            color = d3.scaleThreshold()
                .domain([0, 100, 500, 2000, 10000, 20000, 50000, 200000, 500000, 1000000])
                .range(d3.schemeBlues[9]);

            title = mode;    

            desc = mode;
            
            x = d3.scaleLinear()
                .domain([0, 100, 500, 2000, 10000, 20000, 50000, 200000, 500000, 1000000])
                .rangeRound([450, 900]);
                
            getTextFunction = rawText;
        }
        
        //Look up and load the data under inspection
        if (mode in allModes && $.inArray(mode, educationStrings) === -1) {
            if (typeof allModes[mode] === "object" && "compositeData" in allModes[mode]) {
                var dataObject = allModes[mode];
                var listRequired = dataObject["required"];
                var processFunction = dataObject["function"];
                var dataDictionary = {};
                var numDataLoaded = 0;
                
                for (var i = 0; i < listRequired.length; i++) {
                    var copyDataName = listRequired[i];
                    var dataString = allModes[listRequired[i]];

                    var tokens = dataString.split("|");
                    var csvFileName = tokens[0], idColumnName = tokens[1], dataColumnName = tokens[2];
                    
                    d3.csv(csvFileName) //TODO
                        .row(function(d) { return {key: d[idColumnName], value: +num(d[dataColumnName])}; })
                        .get(function(error, rows) {
                            dataDictionary[listRequired[numDataLoaded]] = d3.map(rows);
                            numDataLoaded++;
                            if (numDataLoaded === listRequired.length) {
                                dataMap = processFunction(dataDictionary);
                                console.log(dataMap);
                                d3.queue()
                                    .defer(d3.json, "https://d3js.org/us-10m.v1.json")
                                    .await(function(error, us) {
                                        jsonCsvDataReady(error, us);
                                    });
                            }
                        });
                        
                    

                }
            }   
            else {
                var dataString = allModes[mode]; //Contains the file name|county id column|true data column
                loadCsvAndCallBack(dataString, jsonCsvDataReady, dataMap);
            }
        }

        if (mode !== null) {
            desc2 = allModesDesc[mode];
        }
       
        if (color == null) {

        }
        else {
            g.selectAll("rect")
              .data(color.range().map(function(d) {
                  d = color.invertExtent(d);
                  if (d[0] == null) d[0] = x.domain()[0];
                  if (d[1] == null) d[1] = x.domain()[1];
                  return d;
                }))
              .enter().append("rect")
                .attr("height", 8)
                .attr("x", function(d) { return x(d[0]); })
                .attr("width", function(d) { return x(d[1]) - x(d[0]); })
                .attr("fill", function(d) { return color(d[0]); });
                
            g.selectAll("text").remove();

            g.append("text")
                .attr("class", "caption")
                .attr("x", x.range()[0])
                .attr("y", -6)
                .attr("fill", "#000")
                .attr("text-anchor", "start")
                .attr("font-weight", "bold")
                .text(title + ": " + desc);
                
            /*
            g.append("text")
                .attr("class", "caption")
                .attr("x", x.range()[0])
                .attr("y", 36)
                .attr("fill", "#000")
                .attr("text-anchor", "start")
                .attr("font-weight", "bold")
                .text(desc);
            */
            
            g.call(d3.axisBottom(x)
                .tickSize(13)
                .tickFormat(function(x, i) { 
                    return i ? x : x; 
                })
                .tickValues(color.domain()))
              .select(".domain")
                .remove();

            //svg.call(d3.zoom().on("zoom", function () {
                    //svg.attr("transform", d3.event.transform)
                    //}));
        }
        
        // Set-up the export button
        d3.select('#saveButton').on('click', function(){
            var svgString = getSVGString(svg.node());
            svgString2Image( svgString, 2*width, 2*height, 'png', save ); // passes Blob and filesize String to the callback

            function save( dataBlob, filesize ){
                saveAs( dataBlob, 'D3 vis exported to PNG.png' ); // FileSaver.js function
            }
        });
    }

    loadMapWithMode(mode);

    d3.select("#toggleMenu").on('click', function() {
        if (menuVisible) {
            mapMenu.transition(1000).style("display", "none");
            aboutText.transition(1000).style("display", "none");
        }
        else {
            mapMenu.transition(1000).style("display", "block");
            aboutText.transition(1000).style("display", "block");
        }
        menuVisible = !menuVisible;
    });
    
    d3.select("#resetMap").on('click', function() {
        //container.attr("transform")
        container.attr("transform", {"k": "1", "x": "0", "y": "0"});
    });

    //Zoom functions

    function dragstarted(d) {
      d3.event.sourceEvent.stopPropagation();
      d3.select(this).classed("dragging", true);
    }

    function dragged(d) {
      d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
      currentHighlightCity = null;
     divTooltip.style("opacity", 0);
    }

    function dragended(d) {
     console.log("Drag ended");
      d3.select(this).classed("dragging", false);
    }

    var zoom = d3.zoom()
        .scaleExtent([1, 10])
        .on("zoom", function() {
            container.attr("transform", d3.event.transform);
            //console.log(d3.event.transform);
            currentHighlightCity = null;
            divTooltip.style("opacity", 0);
            /*
            console.log(d3.event.scale);
            if (d3.event.scale <= 10) {
                container.select(".airport-dots").style("opacity", 1);
            }
            else {
                container.select(".airport-dots").style("opacity", 0);
            }
            */
        });

    var drag = d3.drag()
        .subject(function(d) { return d; })
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended);
        
    svg.call(zoom);

    </script>
</body>