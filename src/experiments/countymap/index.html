<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>US Census Visuals</title>
    
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <style>
    body,button,a,h1 {
        font-family: 'Roboto', serif;
        font-size: 16px;
    }
    
    html { 
        overflow-y: hidden; 
        overflow-x: hidden;
    }
    
    .counties {
        fill: none;
    }

    .states {
        fill: none;
        stroke: #fff;
        stroke-linejoin: round;
    }

    #aboutText {
        font-size: 16px;
    }

    #mapChoices {
        opacity: 0;
        background-color: rgba(255, 255, 255, 0.0);
    }

    #mapchoices button {
        background-color: #cccccc;
        border: 1px solid white;
        color: black; /* White text */
        padding: 5px 12px; /* Some padding */
        cursor: pointer; /* Pointer/hand icon */
        float: left; /* Float the buttons side by side */
    }

    /* Clear floats (clearfix hack) */
    #mapchoices:after {
        content: "";
        clear: both;
        display: table;
        opacity: 0;
        background-color: rgba(255, 255, 255, 0.0);
    }

    #mapchoices button:not(:last-child) {
        border-right: none; /* Prevent double borders */
    }

    /* Add a background color on hover */
    #mapchoices button:hover {
        background-color: #ff3b30;
    }

    #mapchoices #current {
        background-color: #ff3b30;
    }
    
    #saveButton, #toggleMenu, #resetMap {
        background-color: #ffaaaa;
        border: 1px solid white;
        color: black; /* White text */
        padding: 5px 12px; /* Some padding */
        cursor: pointer; /* Pointer/hand icon */
        float: left; /* Float the buttons side by side */
        font-size: 16px;
    }

    .svg {
        overflow: hidden;
    }

    div.tooltip {	
        position: absolute;			
        text-align: center;							
        padding: 2px;				
        font: 12px sans-serif;		
        background: lightsteelblue;	
        border: 0px;		
        border-radius: 8px;			
        pointer-events: none;		
        display:block;
        overflow:auto;
    }
    
    </style>
</head>
<body>
    <div id="mapchoices">
      
    </div>
    <div id="aboutText">
      
    </div>
    <button id='saveButton'>Save Map as PNG</button>
    <button id='toggleMenu'>Toggle Menu On/Off</button>
    <button id='resetMap'>Reset Map View</button>
    
    <!-- Allow the user to type in any two data types to see a red-blue correlation map -->
    Correlation 1 (Red): <input id='redCorrelationInput'></input>
    Correlation 2 (Blue): <input id='blueCorrelationInput'></input>
    <button id='createCorrelationMap'>Create Correlation Map</button>
    <!--<button id='saveButton'>Download this data</button>-->
    &emsp;
    <a href="./censusdata.zip">Download All Data (ZIP)</a>
    &emsp;
    <a href="./totalCountyCensusData.csv">Download Summary Data (CSV)</a>
    <svg width="1920" height="1080"></svg>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
    <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
    <script src="./svgsave.js"></script>
    <script> 

    //Calculates the area from -infinity to x, of a distribution Normal(mean, variance)
    function cdf(x, mean, variance) {
        return 0.5 * (1 + erf((x - mean) / (Math.sqrt(2 * variance))));
    }

    function erf(x) {
        // save the sign of x
        var sign = (x >= 0) ? 1 : -1;
        x = Math.abs(x);

        // constants
        var a1 =  0.254829592;
        var a2 = -0.284496736;
        var a3 =  1.421413741;
        var a4 = -1.453152027;
        var a5 =  1.061405429;
        var p  =  0.3275911;

        // A&S formula 7.1.26
        var t = 1.0/(1.0 + p*x);
        var y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
        return sign * y; // erf(-x) = -erf(x);
    }

    function componentToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
    }

    function rgbToHex(r, g, b) {
        return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }
    
    function dictionaryAdd() {
        var result = d3.map();
        for (var i = 0; i < arguments.length; i++) {
            var d3map = arguments[i];
            var entries = d3map.entries();
            for (var j = 0; j < entries.length; j++) {
                var key = entries[j][0], value = entries[j][1];
                if (result.get(key) === undefined) {
                    result.set(key, 0);
                }
                result.set(num(result.get(key)) + num(value));
            }
        }
        return result;
    }
    
    function dictionaryDivide(dividend, divisor) { //returns dividend / divisor, key by key
        var result = d3.map();
        var entries = dividend.entries();
        for (var j = 0; j < entries.length; j++) {
            var key = entries[j]["key"], value = entries[j]["value"];
            if (divisor.get(key) === undefined) {
                
            }
            else {
                /*
                console.log(value);
                console.log(divisor.get(key));
                console.log(num(value))
                console.log(num(divisor.get(key)))
                console.log("--------");
                */
                result.set(key, num(value) / num(divisor.get(key)))
            }
        }
        return result;
    }
    
    function dictionarySubtract(base, subtract) {
        var result = d3.map();
        var entries = base.entries();
        for (var j = 0; j < entries.length; j++) {
            var key = entries[j]["key"], value = entries[j]["value"];
            if (subtract.get(key) === undefined) {
                
            }
            else {
                result.set(key, num(value) - num(subtract.get(key)))
            }
        }
        return result;
    }
    
    function scaleMap(inspectMap, factor) {
        var scaled = d3.map();
        var entries = inspectMap.entries();
        for (var i = 0; i < entries.length; i++) {
            var entry = entries[i];
            scaled.set(entry.key, num(entry.value) * factor);
        }
        return scaled;
    }
    
    function meanMap(inspectMap) {
        var avg = 0.0;
        var entries = inspectMap.entries();
        for (var i = 0; i < entries.length; i++) {
            avg += num(entries[i].value);
        }
        return avg / entries.length;
    }
    
    function sampleVarianceMap(inspectMap) {
        var avg = meanMap(inspectMap);
        var variance = 0.0;
        var entries = inspectMap.entries();
        for (var i = 0; i < entries.length; i++) {
            var dx = num(entries[i].value) - avg;
            variance += dx * dx;
        }
        //console.log(variance);
        //console.log(variance / (entries.length - 1));
        return Math.sqrt(variance / (entries.length - 1));
    }
    
    function normalizeMap(inspectMap) {
        var avg = meanMap(inspectMap);
        var variance = sampleVarianceMap(inspectMap);
        
        var result = d3.map();
        var entries = inspectMap.entries();
        
        for (var i = 0; i < entries.length; i++) {
            var entry = entries[i];
            //console.log(num(entry.value) + " " + avg + " " + variance);
            var normalized = (num(entry.value) - avg) / variance;
            result.set(entry.key, normalized);
        }
        return result;
    }
    
    //console.log(dictionaryDivide(d3.map().set("a", 1.0), d3.map().set("a", 2.0)));
    
    function arrayDivide(dividend, divisor) {
        //Find all common entries first
        /*
        var result = d3.map();
        var common = {};
        for (var i = 0; i < dividend.length; i++) {
            common[dividend[i]["key"]] = 1;
        }
        for (var i = 0; i < divisor.length; i++) {
            common[divisor[i]["key"]]++;
        }
        for (var key in common) {
            
        }
        for (var i = 0; i < dividend.length; i++) {
            var posKey = dividend[i]["key"];
            if (common.hasOwnProperty(posKey)) {
                if (common[posKey] === 2) {
                    var a = num(dividend);
                    result.put(dividend[i]["key"])
                }
            }
        }
        */
        var mapA = d3.map();
        var mapB = d3.map();
        for (var i = 0; i < dividend.length; i++) {
            var key = dividend[i]["key"];
            var value = dividend[i]["value"];
            mapA.set(key, value);
        }
        for (var i = 0; i < divisor.length; i++) {
            var key = divisor[i]["key"];
            var value = divisor[i]["value"];
            mapB.set(key, value);
        }
        return dictionaryDivide(mapA, mapB);
    }

    function normalizedCorrelationMap(mapA, mapB) {
        var normalizedFirst = normalizeMap(mapA);
        var normalizedSecond = normalizeMap(mapB);

        var result = d3.map();
        var entries = normalizedFirst.entries();
        for (var i = 0; i < entries.length; i++) {
            var key = entries[i].key;
            if (normalizedSecond.has(key)) {
                var value1 = num(normalizedFirst.get(key));
                var value2 = num(normalizedSecond.get(key));
                var normalizedDiff = Math.abs(value1 - value2);
                //console.log(value1 + " " + value2 + " " + normalizedDiff);
                if (normalizedDiff > 0.75) {
                    if (value1 > value2) {
                        //return shades of red as normalizedDiff increases
                        //0 - 0.3
                        var extremeness = Math.min(normalizedDiff - 0.75, 1);
                        result.set(key, 0.3 * (1 - extremeness));
                    }
                    else {
                        //0.5 - 0.8
                        //return shades of blue
                        var extremeness = Math.min(normalizedDiff - 0.75, 1);
                        result.set(key, 0.5 + 0.3 * extremeness);
                    }
                }
                else { 
                    var avg = (value1 + value2) / 2.0;
                    //return shades of purple as average increases
                    //0.9 - 1.7
                    var extremeness = Math.max(0, Math.min(avg, 2)) / 2.0;
                    result.set(key, 0.9 + 0.8 * extremeness);
                    //console.log(value1 + " " + value2 + " " + extremeness);
                }
                //console.log(result.get(key));
            }
        }
        
        return result;
    }
    
    function normalizedInverseCorrelationMap(mapA, mapB) {
        var normalizedFirst = normalizeMap(mapA);
        var normalizedSecond = normalizeMap(mapB);

        var result = d3.map();
        var entries = normalizedFirst.entries();
        for (var i = 0; i < entries.length; i++) {
            var key = entries[i].key;
            if (normalizedSecond.has(key)) {
                var value1 = num(normalizedFirst.get(key));
                var value2 = num(normalizedSecond.get(key));
                var diff = Math.max(-3, Math.min(value1 - value2, 3));

                var extremeness = (diff + 3) * 1.1 / 6.0;
                result.set(key, extremeness);
            }
        }
        
        return result;
    }
    
    function normalizedTriCorrelationMap(mapA, mapB, mapC) {
        var normalizedFirst = normalizeMap(mapA);
        var normalizedSecond = normalizeMap(mapB);
        var normalizedThird = normalizeMap(mapC);

        var result = d3.map();
        var entries = normalizedFirst.entries();
        for (var i = 0; i < entries.length; i++) {
            var key = entries[i].key;
            if (normalizedSecond.has(key) && normalizedThird.has(key)) {
                var value1 = num(normalizedFirst.get(key));
                var value2 = num(normalizedSecond.get(key));
                var value3 = num(normalizedThird.get(key));
                
                var red = cdf(value1, 0, 1), green = cdf(value2, 0, 1), blue = cdf(value3, 0, 1);
                red = Math.floor(red * 255.0);
                green = Math.floor(green * 255.0);
                blue = Math.floor(blue * 255.0);
                
                result.set(key, [red, green, blue]);
                //console.log(result.get(key));
            }
        }
        
        return result;
    }
    
    //var mode = "Unemployment";
    //var mode = "Income";
    //var mode = "Poverty";
    var mode = null; // = "MiningQuarryingOilGas";

    //Sort the total data into many individual files        
    var allModes = {
            "Unemployment" : "unemployment.csv|id|rate",
            "Income" : "povertyincome.csv|County ID|Median Household Income in Dollars",
            "Poverty" : "povertyincome.csv|County ID|All Ages in Poverty Percent",
            "PopulationDensity" : "./populationdensity/DEC_00_SF1_GCTPH1.US05PR.csv|CountyID|DENSITY_SQ_MILE",
            "SubstanceAbuse" : "./substanceabuse/substanceabuseProcessed.csv|FIPS|EstimatedAgeAdjustedDeathRateMin",
            "GDPPerCapita" : "./gdppercapita/gdppercapitaProcessedId.csv|CountyId|PerCapitaIncome",
            "Gini" : "./giniequality/processedGini.csv|CountyId|GiniMeasure",
            "Religion" : "./religion/religionProcessedId.csv|CountyId|AdherentsPercent",
            "CongregationDensity" : "./religion/religionProcessedId.csv|CountyId|CongregationsPer10000",
            "Crime" : "./crime/crimeDataProcessed.csv|CountyId|crime_rate_per_100000",
            "Veterans" : "./rural_atlas/Veterans.csv|FIPS|Vets18OPct",
            "UrbanIndex" : "./rural_atlas/CountyClassifications.csv|FIPS|RuralUrbanContinuumCode2013",
            "PopulationGrowth" : "./rural_atlas/People.csv|FIPS|PopChangeRate1516",
            
            //"PopulationPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC01",
            "WhiteOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC20",
            "BlackOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC21",
            "IndianOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC22",
            "AsianOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC23",
            "PacificIslanderOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC24",
            "OtherOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC25",
            "MultiOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC26",
            "HispanicOriginPercentage" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC28",
            
            "TotalPopulationCount" : "./selecteddemographics/processedDemographics.csv|CountyId|HC01_EST_VC01",
            "OtherStatePopulationCount" : "./selecteddemographics/processedDemographics.csv|CountyId|HC03_EST_VC01",
            "ForeignPopulationCount" : "./selecteddemographics/processedDemographics.csv|CountyId|HC04_EST_VC01",
            
            "OutOfStatePercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulationCount",
                    "OtherStatePopulationCount"
                ],
                "function" : function(d) {
                    return scaleMap(dictionaryDivide(d["OtherStatePopulationCount"], d["TotalPopulationCount"]), 100.0);
                }   
            },
            
            "Correlation" : {
                "compositeData" : true,
                "required" : [
                    "Poverty", //red
                    "Crime" //blue
                ],
                "function" : function(data, listRequired) {
                    //return scaleMap(dictionaryDivide(d["OtherStatePopulationCount"], d["TotalPopulationCount"]), 100.0);
                    //d3.schemeRdBu[9].concat(d3.schemePurples[9])
                    
                    color = d3.scaleThreshold()
                        .domain(d3.range(0, 1.7, 0.1))
                        .range(d3.schemeRdBu[9].concat(d3.schemePurples[9]));
                    title = listRequired[0] + " and " + listRequired[1]; 
                    desc = title + " by County";        
                    x = d3.scaleLinear().domain(d3.range(0, 1.7, 0.1)).rangeRound([450, 900]);  
                    getTextFunction = rawText;
                    
                    return normalizedCorrelationMap(data[listRequired[0]], data[listRequired[1]]);
                }   
            },
            "InverseCorrelation" : {
                "compositeData" : true,
                "required" : [
                    "Poverty",
                    "Crime" 
                ],
                "function" : function(data, listRequired) {
                    //return scaleMap(dictionaryDivide(d["OtherStatePopulationCount"], d["TotalPopulationCount"]), 100.0);
                    //d3.schemeRdBu[9].concat(d3.schemePurples[9])
                    
                    color = d3.scaleThreshold()
                        .domain(d3.range(0, 1.0, 0.1))
                        .range(d3.schemeRdBu[11]);
                    title = listRequired[0] + " and " + listRequired[1]; 
                    desc = title + " by County";        
                    x = d3.scaleLinear().domain(d3.range(0, 1.0, 0.1)).rangeRound([450, 900]);  
                    getTextFunction = rawText;
                    
                    return normalizedInverseCorrelationMap(data[listRequired[0]], data[listRequired[1]]);
                }   
            },
            "TripleCorrelation" : {
                "compositeData" : true,
                "required" : [
                    "Poverty", //red
                    "SubstanceAbuse", //green
                    "Crime" //blue
                ],
                "function" : function(data, listRequired) {
                    //return scaleMap(dictionaryDivide(d["OtherStatePopulationCount"], d["TotalPopulationCount"]), 100.0);
                    //d3.schemeRdBu[9].concat(d3.schemePurples[9])
                    
                    color = function(arr) {
                        if (arr === undefined) {
                            return "#000000";
                        }   
                        //console.log(arr);
                        console.log(rgbToHex(arr[0], arr[1], arr[2]));
                        return rgbToHex(arr[0], arr[1], arr[2]);
                    };
                    title = listRequired[0] + ", " + listRequired[1] + ", and " + listRequired[2]; 
                    desc = title + " by County";        
                    x = d3.scaleLinear().domain(d3.range(0, 1.7, 0.1)).rangeRound([450, 900]);  
                    getTextFunction = rawText;
                    
                    return normalizedTriCorrelationMap(data[listRequired[0]], data[listRequired[1]], data[listRequired[2]]);
                }   
            },
            "PovertyCrime" : {
                "compositeData" : true,
                "required" : [
                    "Poverty", //red
                    "Crime" //blue
                ],
                "function" : function(data, listRequired) {
                    //return scaleMap(dictionaryDivide(d["OtherStatePopulationCount"], d["TotalPopulationCount"]), 100.0);
                    //d3.schemeRdBu[9].concat(d3.schemePurples[9])
                    
                    color = d3.scaleThreshold()
                        .domain(d3.range(0, 1.7, 0.1))
                        .range(d3.schemeRdBu[9].concat(d3.schemePurples[9]));
                    title = "Poverty and Crime"; 
                    desc = "Poverty and Crime by County";        
                    x = d3.scaleLinear().domain(d3.range(0, 1.7, 0.1)).rangeRound([450, 900]);  
                    getTextFunction = rawText;
                    
                    return normalizedCorrelationMap(data["Poverty"], data["Crime"]);
                }   
            },
            "PovertySubstanceAbuse" : {
                "compositeData" : true,
                "required" : [
                    "Poverty", //red
                    "SubstanceAbuse" //blue
                ],
                "function" : function(data, listRequired) {
                    //return scaleMap(dictionaryDivide(d["OtherStatePopulationCount"], d["TotalPopulationCount"]), 100.0);
                    //d3.schemeRdBu[9].concat(d3.schemePurples[9])
                    
                    color = d3.scaleThreshold()
                        .domain(d3.range(0, 1.7, 0.1))
                        .range(d3.schemeRdBu[9].concat(d3.schemePurples[9]));
                    title = "Poverty and Substance Abuse"; 
                    desc = "Poverty and Substance Abuse by County";        
                    x = d3.scaleLinear().domain(d3.range(0, 1.7, 0.1)).rangeRound([450, 900]);  
                    getTextFunction = rawText;
                    
                    return normalizedCorrelationMap(data["Poverty"], data["SubstanceAbuse"]);
                }   
            },
            
            /*
            "ForeignPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulationCount",
                    "ForeignPopulationCount"
                ],
                "function" : function(d) {
                    console.log(d["ForeignPopulationCount"])
                    console.log(d["TotalPopulationCount"])
                    console.log(scaleMap(dictionaryDivide(d["ForeignPopulationCount"], d["TotalPopulationCount"]), 100.0))
                    return scaleMap(dictionaryDivide(d["ForeignPopulationCount"], d["TotalPopulationCount"]), 100.0);
                }   
            }
            */
            /*
            ,
            "BlackPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalBlackOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalBlackOrigin"]);
                }   
            },
            "IndianPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalIndianOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalIndianOrigin"]);
                }   
            },
            "AsianPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalAsianOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalAsianOrigin"]);
                }   
            },
            "PacificIslanderPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalPacificIslanderOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalPacificIslanderOrigin"]);
                }   
            },
            "OtherPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalOtherOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalOtherOrigin"]);
                }   
            },
            "MultiPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalMultiOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalMultiOrigin"]);
                }   
            },
            "HispanicPercentage" : {
                "compositeData" : true,
                "required" : [
                    "TotalPopulation",
                    "TotalHispanicOrigin"
                ],
                "function" : function(d) {
                    return arrayDivide(d["TotalPopulation"], d["TotalHispanicOrigin"]);
                }   
            }
            */
        };    
        
    console.log(d3.schemeRdBu[9].concat(d3.schemePurples[9]));
        
    industryStrings = ["AllSectors",
            "AgricultureForestryFishingHunting",
            "MiningQuarryingOilGas",
            "Utilities",
            "Construction",
            "Manufacturing",
            "WholesaleTrade",
            "RetailTrade",
            "TransportationWarehousing",
            "Information",
            "FinanceInsurance",
            "RealEstate",
            "ProfessionalScientificTechnical",
            "Management",
            "AdministrativeSupportWaste",
            "Education",
            "HealthcareSocialAssistance",
            "ArtsEntertainmentRecreation",
            "AccommodationFood",
            "OtherServices",
            "IndustriesNotClassified"
    ];
            
    educationStrings = [
            "Total1824",
            "LHS1824",
            "HS1824",
            "SC1824",
            "BH1824",
            "TotalG25",
            "L9G25",
            "912G25",
            "HSG25",
            "SCG25",
            "ADG25",
            "BDG25",
            "GPG25"
    ];
    
    var buttonTreeHierarchy = [
            "AllData",
            "Unemployment",
            "Income",
            "Poverty",
            "PopulationDensity", 
            "SubstanceAbuse", 
            "GDPPerCapita",
            "Gini",
            "Religion",
            "CongregationDensity",
            "Crime",
            "Veterans",
            "UrbanIndex",
            "PopulationGrowth",
            
            [
                "IndustryData",
                "AllSectors",
                "AgricultureForestryFishingHunting",
                "MiningQuarryingOilGas",
                "Utilities",
                "Construction",
                "Manufacturing",
                "WholesaleTrade",
                "RetailTrade",
                "TransportationWarehousing",
                "Information",
                "FinanceInsurance",
                "RealEstate",
                "ProfessionalScientificTechnical",
                "Management",
                "AdministrativeSupportWaste",
                "Education",
                "HealthcareSocialAssistance",
                "ArtsEntertainmentRecreation",
                "AccommodationFood",
                "OtherServices",
                "IndustriesNotClassified"
            ],
            
            [
                "EducationData",
                "Total1824",
                "LHS1824",
                "HS1824",
                "SC1824",
                "BH1824",
                "TotalG25",
                "L9G25",
                "912G25",
                "HSG25",
                "SCG25",
                "ADG25",
                "BDG25",
                "GPG25"
            ],
            
            [
                "OriginPercentages",
                "WhiteOriginPercentage",
                "BlackOriginPercentage",
                "IndianOriginPercentage",
                "AsianOriginPercentage",
                "PacificIslanderOriginPercentage",
                "OtherOriginPercentage",
                "MultiOriginPercentage",
                "HispanicOriginPercentage",
            ],
            
            [
                "PopulationCounts",
                "TotalPopulationCount",
                "OtherStatePopulationCount",
                "ForeignPopulationCount",
                "OutOfStatePercentage"
            ],
            
            [
                "Correlations",
                "Correlation",
                "InverseCorrelation",
                "TripleCorrelation",
                "PovertyCrime",
                "PovertySubstanceAbuse"
            ]
    ];
        
    var bigTownPopCutoff = 500000;   
        
    workforcePercentageStrings = [
        "NaturalResources", "Construction", "Manufacturing", "WholesaleTrade", "RetailTrade", 
        "TransportationUtilities", "Information", "Finance", "ProfessionalScientific", "Education", 
        "ArtsEntertainment", "OtherServices", "Administration"
    ];
        
    //Organize all data by type i.e. income, unemployment, etc.
    for (var i = 0; i < industryStrings.length; i++) {
        industryString = industryStrings[i];
        constr = "./businessbycounty/processed/" + industryString + ".csv|GEO.id2|PAYANN";
        allModes[industryString] = constr;
    }
        
    for (var i = 0; i < educationStrings.length; i++) {
        educationString = educationStrings[i];
        constr = "./education/simplifiedEducationCount.csv|CountyID|" + educationString;
        allModes[educationString] = constr;
    }
    
    for (var i = 0; i < workforcePercentageStrings.length; i++) {
        workforcePercentageString = workforcePercentageStrings[i]
        constr = "./industry/industryPercentageProcessed.csv|CountyId|" + workforcePercentageString;
        allModes["WorkforcePercentage" + workforcePercentageString] = constr;
    }
    
    var allModesDesc = {
        "Unemployment" : null,
        "Income" : null,
        "Poverty" : null,
        "PopulationDensity" : null,
        "SubstanceAbuse" : null,
        "GDPPerCapita" : null,
        "AllSectors" : null,
        "AgricultureForestryFishingHunting" : null,
        "MiningQuarryingOilGas" : null,
        "Utilities" : null,
        "Construction" : null,
        "Manufacturing" : null,
        "WholesaleTrade" : null,
        "RetailTrade" : null,
        "TransportationWarehousing" : null,
        "Information" : null,
        "FinanceInsurance" : null,
        "RealEstate" : null,
        "ProfessionalScientificTechnical" : null,
        "Management" : null,
        "AdministrativeSupportWaste" : null,
        "Education" : null,
        "HealthcareSocialAssistance" : null,
        "ArtsEntertainmentRecreation" : null,
        "AccommodationFood" : null,
        "OtherServices" : null,
        "IndustriesNotClassified" : null,
        "Total1824" : "Number of people aged 18-24",
        "LHS1824" : "Number of people aged 18-24",
        "HS1824" : "Of ages 18-24, completed high school or higher",
        "SC1824" : "Of ages 18-24, completed some college or higher",
        "BH1824" : "Of ages 18-24, completed bachelors or higher",
        "TotalG25" : "Number of people aged 25+",
        "L9G25" : "Of ages 18-24, did not complete 9th grade",
        "912G25" : "Of ages 18-24, completed some high school or higher",
        "HSG25" : "Of ages 18-24, completed high school diploma or higher",
        "SCG25" : "Of ages 18-24, completed some college or higher",
        "ADG25" : "Of ages 18-24, completed associate's degree or higher",
        "BDG25" : "Of ages 18-24, completed bachelor's degree or higher",
        "GPG25" : "Of ages 18-24, completed post-grad degree"
    };

    var mapMenu = d3.select("#mapchoices");
    var aboutText = d3.select("#aboutText");
    var createCorMap = d3.select("#createCorrelationMap");

    var menuVisible = true;
    
    function getQueryVariable(variable)
    {
           var query = window.location.search.substring(1);
           var vars = query.split("&");
           for (var i=0;i<vars.length;i++) {
                   var pair = vars[i].split("=");
                   if(pair[0] == variable){return pair[1];}
           }
           return(false);
    }

    function num(input) {
        //if (x == null || isNaN(x)) return null;
        if (typeof input === "string") {
            n = input.replace(/[^0-9.-]/g, "");
        }
        else {
            n = input;
        }
        if (!isNaN(parseFloat(n)) && isFinite(n)) {
            return parseFloat(n);
        }
        return null;
    }
    
    console.log(num(1.4));
    console.log(num("1.4"));
    console.log(num("-37.9"));
    console.log(num(-37.9));
    console.log(-37.9);
    
    function numberWithCommas(x) {
        if (x == null) return "";
        var parts = x.toString().split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
    }

    function percentage(d) {
        return countyNameById.get(d.id) + ": " + d.rate + "%";
    }
    function dollars(d) {
        return countyNameById.get(d.id) + ": " + "$" + numberWithCommas(d.rate);
    }
    function dollarsTimesThousand(d) {
        return countyNameById.get(d.id) + ": " + "$" + numberWithCommas(d.rate * 1000);
    }
    function rawText(d) {
        return countyNameById.get(d.id) + ": " + numberWithCommas(d.rate);
    }
    
    function getDataComparisons(inspectId) {
        var allEntries = dataMap.entries();
        /*
        var filteredEntries = allEntries.filter(function(d) { 
            var population = num(populationById.get(d.key));
            return population >= bigTownPopCutoff;
        });
        */
        
        countiesSortedField = allEntries.sort(function(x, y) {
            var value1 = dataMap.get(x.key);
            var value2 = dataMap.get(y.key);
            if (value1 === value2) {
                var rand = Math.random() - 0.5;
                if (rand === 0) return 1;
                return rand / Math.abs(rand); //Return the sign of rand, 1 or -1
            }
            else {
                return d3.descending(dataMap.get(x.key), dataMap.get(y.key));
            }
        });
    
        var inspectValue = dataMap.get(inspectId);
        var sortedIndex = 0;
        for (var i = 0; i < countiesSortedField.length - 1; i++) {
            var prevCountyId = countiesSortedField[i].key;
            var nextCountyId = countiesSortedField[i+1].key;
            var prevValue = dataMap.get(prevCountyId);
            var nextValue = dataMap.get(nextCountyId);
            if (inspectValue <= prevValue && inspectValue >= nextValue) {
                sortedIndex = i;
                break;
            }
        }
        
        var top = Math.max(0, sortedIndex - 5 + 1);
        var bottom = Math.min(countiesSortedField.length - 1, sortedIndex + 5 + 2);
        
        var texts = []
        
        for (var i = top; i < sortedIndex; i++) {
            var otherCountyId = countiesSortedField[i].key;
            var tempKeyValue = {"id" : otherCountyId, "rate" : dataMap.get(otherCountyId)};
            var textValue = getTextFunction(tempKeyValue);
            texts.push(textValue);
        }
        
        //texts.push(); //push this county under inspection?
        
        for (var i = sortedIndex; i < bottom; i++) {
            var otherCountyId = countiesSortedField[i].key;
            var tempKeyValue = {"id" : otherCountyId, "rate" : dataMap.get(otherCountyId)};
            var textValue = getTextFunction(tempKeyValue);
            texts.push(textValue);
        }
        
        return texts;
    }
    
    //General template for json/csv callback
    //variables: selectedMapping - d3 map, clickAction(d) - function, getText(d) - function
    //TODO: Implement this
    function jsonCsvDataReady(error, us) {
      if (error) throw error;
      
      entries = dataMap.entries();
      sortedEntries = entries.sort(function(x, y) {
        return d3.descending(x.value, y.value);
      });
      
      container.append("g")
          .attr("class", "counties")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.counties).features)
        .enter().append("path")
          .attr("fill", function(d) { return color(d.rate = dataMap.get(d.id)); })
          .attr("d", path)
          .on("click", function(d) {
            var texts = getDataComparisons(d.id);
            
            divTooltip.style("opacity", 1); 
            var countyName = countyNameById.get(d.id);
            divTooltip.html("<p>" + getTextFunction(d) + "</p>")
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");	
                
            divTooltip.html(divTooltip.html() + "<p>");
            for (var i = 0; i < texts.length; i++) {
                divTooltip.html(divTooltip.html() + texts[i] + "<br>");
            }
            divTooltip.html(divTooltip.html() + "</p>");
          })
          /*
          .on("mousemove", function(d) {
            
          })
          */
          //.attr("countyid", function(d) { return d.id; })
        .append("title")
          .text(function(d) { return getTextFunction(d); });
          
      container.append("path")
          .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
          .attr("class", "states")
          .attr("d", path);
    }

    //TODO: Turn this into a utility method and not some hard-coded spaghetti
    var educationType = "";
    var higher1824 = [
        "LHS1824","HS1824","SC1824","BH1824"
    ];
    var higherG25 = [
        "L9G25","912G25","HSG25","SCG25","ADG25","BDG25","GPG25"
    ];  
    function educationReady(error, us) {
      if (error) throw error;
      
      container.append("g")
          .attr("class", "counties")
        .selectAll("path")
        .data(topojson.feature(us, us.objects.counties).features)
        .enter().append("path")
          .attr("fill", function(d) {
            if (educationType === "Total1824") {
                return color(d.rate = dataMap.get(d.id)["Total1824"]); 
            }
            else if (educationType === "TotalG25") {
                return color(d.rate = dataMap.get(d.id)["TotalG25"]);
            }
            var percentage = 0;
            if (educationType.indexOf("1824") != -1) {
                var index = higher1824.indexOf(educationType);
                var count = 0;
                var total = dataMap.get(d.id)["Total1824"];
                for (var i = index; i < higher1824.length; i++) {
                    count = count + dataMap.get(d.id)[higher1824[i]];
                }
                percentage = count / total;
            }
            else if (educationType.indexOf("G25") != -1) {
                var index = higherG25.indexOf(educationType);
                var count = 0;
                var total = dataMap.get(d.id)["TotalG25"];
                for (var i = index; i < higherG25.length; i++) {
                    count = count + dataMap.get(d.id)[higherG25[i]];
                }
                percentage = count / total;
            }
            return color(d.rate = percentage); 
          })
          .attr("d", path)
          .on("click", function(d) {console.log(d.id); })
          //.attr("countyid", function(d) { return d.id; })
        .append("title")
          .text(function(d) { return countyNameById.get(d.id) + ": " + numberWithCommas(d.rate); });

      container.append("path")
          .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
          .attr("class", "states")
          .attr("d", path);
    }

    var maptype = getQueryVariable("maptype");
    if (maptype && maptype in allModes) {
        mode = maptype;
    }
    else {
        //console.log("Invalid map URL parameter: " + maptype);
    }

    // Define the div for the tooltip
    var divTooltip = d3.select("body").append("div")	
        .attr("class", "tooltip")				
        .style("opacity", 0)
        .style("z-index", 1);        

    var color = null;
    
    var correlationColorScheme = null;
    
    var title = "Default Title";
    var desc = "Default Description";
    var desc2 = "Default Extended Description"

    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");
        
    var container = svg.append("g");

    var dataMap = d3.map();

    var path = d3.geoPath();

    var g = container.append("g")
        .attr("class", "key")
        .attr("transform", "translate(0,40)");
        
    var countyNameById = d3.map();
    var populationById = d3.map();
    var countiesSortedPopulation = null; 
    var topCountiesPop = null; 
     
    var getTextFunction = null;
    
    var pageCounter = 0;
        
    function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    } 

    function clearAndRefreshMenu() {
        //Buttons at the top where the user can switch modes    
        mapMenu.selectAll("*").remove();
        mapMenu.html("");
        createButtons();
        mapMenu.append("button").text("Urban Centers").attr("title", "Urban Centers").on("click", function() {
            console.log(this.textContent);
            window.location.href = "./urbancenters/urbancenters.html";
        });
        mapMenu.append("button").text("Closest Urban Centers").attr("title", "Closest Urban Centers").on("click", function() {
            console.log(this.textContent);
            window.location.href = "./urbancenters/urbancentersvoronoi.html";
        });
    }
    
    function createButtonTreeMenu(parentDiv, inspectList) {
        if (inspectList.length <= 1) {
            return null;
        }
        var menuDiv = parentDiv.append("div");
        
        var menuButton = parentDiv.append("button")
            .text(inspectList[0])
            .attr("title", inspectList[0])
            .attr("class", "menuTreeButton")
            .attr("id", "menuTree" + inspectList[0])
            .on("click", function() {
                var current = menuDiv.style("display");
                if (current === "block") {
                    menuDiv.style("display", "none");
                    menuButton.style("background-color", "#aaaadd");
                    menuButton.style("color", "#ffffff");
                }   
                else {
                    menuDiv.style("display", "block");
                    menuButton.style("background-color", "#ffaaaa");  
                    menuButton.style("color", "black");
                }
            });
        menuButton.style("background-color", "#aaaadd");
        menuButton.style("color", "#ffffff");
        
        for (var i = 1; i < inspectList.length; i++) {
            var elem = inspectList[i];
            if ($.isArray(elem)) {
                if (elem.length > 0) {
                    /*
                    var button = menuDiv.append("button").text(elem[0]).attr("title", elem[0]).attr("id", "placeholder").on("click", function() {
                        console.log(this.textContent);
                        loadMapWithMode(this.textContent);
                    });
                    */
                    createButtonTreeMenu(menuDiv, elem);
                }
            }
            else {
                //menuDiv.html(menuDiv.html() + "&emsp;");
                var button = menuDiv.append("button")
                    .text(elem)
                    .attr("title", elem)
                    .attr("class", "menuTreeButton")
                    .attr("id", "menuTree" + elem)
                    .on("click", function() {
                        divTooltip.style("opacity", 0.0);
                        
                        //Buttons at the top where the user can switch modes  
                        //clearAndRefreshMenu();
                        
                        console.log(this.textContent);
                        container.attr("transform", {"k": "1", "x": "0", "y": "0"});
                        loadMapWithMode(this.textContent);
                        
                        window.history.pushState('page' + pageCounter, this.textContent, '/src/experiments/countymap/index.html?maptype=' + this.textContent);
                        pageCounter++;
                    });
                button.style("background-color", "#cccccc");
                button.style("color", "black");
            }
        }
        menuDiv.style("display", "none");
        
        return menuDiv;
    }
    function createButtons() {
        var menuDiv = createButtonTreeMenu(d3.select("#mapchoices"), buttonTreeHierarchy);
        menuDiv.style("display", "block");
        
        var allDataMenuButton = d3.select("#menuTreeAllData");
        allDataMenuButton.style("background-color", "#ffaaaa");  
        allDataMenuButton.style("color", "black");
    }

    function loadAboutText() {
        mapMenu.selectAll("*").remove();
        mapMenu.html("");
        /*
        for (var chooseMode in allModes) {
            if (allModes.hasOwnProperty(chooseMode)) {
                //var chooseMode = allModes[i];  
                var id = chooseMode == mode ? "current" : "";
                var title = allModesDesc[chooseMode] == null ? chooseMode + " per County" : allModesDesc[chooseMode];
                var button = mapMenu.append("button").text(chooseMode).attr("title", title).attr("id", id).on("click", function() {
                    console.log(this.textContent);
                    loadMapWithMode(this.textContent);
                    //window.history.pushState('index', this.textContent, '/index.html');
                    //console.log("Redirect " + "./index.html?maptype=" + mode);
                    //window.location.href = "index.html?maptype=" + new String(mode);
                    //window.location.href = "./index.html?maptype=" + mode;
                    //window.location.reload();
                });
            }
        }
        */
        createButtons();
        
        mapMenu.append("button").text("Urban Centers").attr("title", "Urban Centers").on("click", function() {
            console.log(this.textContent);
            window.location.href = "./urbancenters/urbancenters.html";
        });
        mapMenu.append("button").text("Closest Urban Centers").attr("title", "Closest Urban Centers").on("click", function() {
            console.log(this.textContent);
            window.location.href = "./urbancenters/urbancentersvoronoi.html";
        });
        
        //console.log(mapMenu.html());
        //mapMenu.html(mapMenu.html() + "<p>Description</p>");
        //console.log(mapMenu.html());
        
        aboutText.html(
            "<p>A visualization of US Census data in d3.js. Data is represented county per county.</p>" +
            "<p>This data includes household income, poverty, industry statistics, education completions, and more.</p>" +
            "<p>In this project we learn about the demographics of the United States and what affects people's living conditions and communities.</p>"
        );
    }    
     
    function loadCsvAndCallBack(dataString, callback, dataMap) {
        var tokens = dataString.split("|");
        var csvFileName = tokens[0], idColumnName = tokens[1], dataColumnName = tokens[2];
        
        d3.queue()
            .defer(d3.json, "https://d3js.org/us-10m.v1.json")
            .defer(d3.csv, csvFileName, function(d) { 
                var income = 0;
                if (d[dataColumnName] === undefined) { //Account for possibly empty lines
                    income = 0;
                }
                else {
                    income = num(d[dataColumnName]);
                    dataMap.set(d[idColumnName], +income);
                }
            })
            .await(callback);
    }
     
    function loadMapWithMode(mode) {
        //Initialize everything, possibly or not for the first time, so we can redraw
    
        if (mode == null) {
            loadAboutText();
            return;
        }
        else {
            aboutText.html("");
        }

        svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height");
        svg.style("z-index", 0);
            
        
        //TODO: Replace with a solution that updates the whole map insteading of replacing it
        svg.selectAll("*").remove();

        container = svg.append("g");
        /*
        container.on("mousemove", function(d) {
            console.log("call");
            divTooltip.style("opacity", 1);
            divTooltip.style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");	
            divTooltip.html("Test");
        });
        */
        
        dataMap = d3.map();
       
        path = d3.geoPath();

        countyNameById = d3.map();
        populationById = d3.map();
        
        getTextFunction = null;
        
        //console.log(svg.select("g"));
        
        g = container.append("g")
            .attr("class", "key")
            .attr("transform", "translate(0,40)");

        //Load in the official full list of counties
        d3.queue()
            .defer(d3.csv, "./countyIdByNameProcessed.csv", function(d) { 
                //console.log(d);
                //console.log(d["TotalCountyId"] + ", " + d["CountyName"]);
                if (d["TotalCountyId"] === null) {
                
                }
                else {
                    countyNameById.set(d["TotalCountyId"], d["CountyName"] + ", " + d["StateAbbr"]); 
                }
            });
            
        d3.queue()
            .defer(d3.csv, "./population/populationProcessed.csv", function(d) { 
                //console.log(d);
                //console.log(d["TotalCountyId"] + ", " + d["CountyName"]);
                if (d["PopulationTotal"] === null) {
                
                }
                else {
                    populationById.set(d["CountyId"], num(d["PopulationTotal"])); 
                }
            })
            .await(function(error) {
                entries = populationById.entries();
                countiesSortedPopulation = entries.sort(function(x, y) {
                    return d3.descending(x.value, y.value);
                });
                topCountiesPop = [];
                var i = 0;
                while (true) {
                    if (i >= entries.length) break;
                    var entry = entries[i];
                    if (entry.value >= bigTownPopCutoff) {
                        topCountiesPop.push(entry);
                        i++;
                    }
                    else {
                        break;
                    }
                }
            });   

        //TODO: Do not hardcode this data
        if (mode === "Unemployment") {  
            color = d3.scaleThreshold()
                .domain(d3.range(2, 10))
                .range(d3.schemeBlues[9]);
            title = "Unemployment";  
            desc = "Unemployment percentage per county";
            x = d3.scaleLinear().domain([2, 10]).rangeRound([450, 900]);
            getTextFunction = percentage;
        }
        else if (mode === "Income") {
            color = d3.scaleThreshold()
                .domain(d3.range(20000, 100000, 10000))
                .range(d3.schemeGreens[9]);
            title = "Median Household Income"; 
            desc = "Median household income by county";        
            x = d3.scaleLinear().domain([20000, 100000, 10000]).rangeRound([450, 900]);  
            getTextFunction = dollars;
        }
        else if (mode === "Poverty") {
            color = d3.scaleThreshold()
                .domain(d3.range(6, 36, 3))
                .range(d3.schemeReds[9]);
            x = d3.scaleLinear()
                .domain([6, 36, 3])
                .rangeRound([450, 900]);
            title = "Percentage under Poverty Line";
            desc = "Percentage of people below poverty line per county";    
            getTextFunction = percentage;
        }
        else if (mode === "PopulationDensity") {
            color = d3.scaleThreshold()
                .domain([10, 50, 100, 350, 1000, 2500, 5000, 10000, 50000])
                .range(d3.schemeReds[8]);
            title = "Population Density";
            desc = "Population Density per County per Square Mile";
            x = d3.scaleThreshold()
              .domain([0, 10, 50, 100, 350, 1000, 2500, 5000, 10000, 50000])
              .range(d3.range(450, 950, 50));
            getTextFunction = rawText;
        }
        else if (mode === "SubstanceAbuse") {
            color = d3.scaleThreshold()
                .domain([0, 2, 4, 8, 12, 16, 20, 24, 28, 32])
                .range(d3.schemeReds[9]); 
            title = "Substance Abuse";
            desc = "Substance Abuse per County";
            x = d3.scaleThreshold()
              .domain([0, 2, 4, 8, 12, 16, 20, 24, 28, 32])
              .range(d3.range(450, 950, 50));
            getTextFunction = rawText;
        }
        else if (mode === "GDPPerCapita") {  
            color = d3.scaleThreshold()
                .domain([0, 19000, 20900, 22000, 23100, 24750, 27250, 30000, 35000, 70000])
                .range(d3.schemeGreens[9]);
            title = "GDP per Capita";
            desc = "GDP per Capita per County";
            x = d3.scaleThreshold()
              .domain([0, 19000, 20900, 22000, 23100, 24750, 27250, 30000, 35000, 70000])
              .range(d3.range(450, 950, 50));
            getTextFunction = dollars;
        }
        else if (mode === "Gini") {  
            color = d3.scaleThreshold()
                .domain(d3.range(0.35, 0.65, 0.05))
                .range(d3.schemeReds[6]);
            title = "Gini Inequality";
            desc = "Gini Inequality Index per County";
            x = d3.scaleLinear()
              .domain([0.35, 0.65, 0.05])
              .rangeRound([450, 950]);
            getTextFunction = rawText;
        }
        else if (mode === "Religion" || mode === "CongregationDensity") {  
            color = d3.scaleThreshold()
                .domain(d3.range(0, 90, 10))
                .range(d3.schemeReds[9]);
            if (mode === "Religion") {
                title = "Religion";
                desc = "Religious Percentage per County";
            }
            else {
                title = "Congregation Density";
                desc = "Number of Congregations and Places of Worship per 10000 People in County";
            }
            x = d3.scaleLinear()
              .domain([0, 90, 10])
              .rangeRound([450, 900]);
            getTextFunction = percentage;
        }
        else if (mode === "Crime") {  
            color = d3.scaleThreshold()
                .domain(d3.range(0, 900, 100))
                .range(d3.schemeReds[9]);
            title = "Crime";
            desc = "Crime per 100,000 People in County";
            x = d3.scaleLinear()
              .domain([0, 900, 100])
              .rangeRound([450, 900]);
            getTextFunction = rawText;
        }
        else if (mode === "Veterans") {  
            color = d3.scaleThreshold()
                .domain(d3.range(2, 20, 2))
                .range(d3.schemeReds[9]);
            title = "Veterans";
            desc = "Veterans Percentage in County";
            x = d3.scaleLinear()
              .domain([2, 20, 2])
              .rangeRound([450, 900]);
            getTextFunction = percentage;
        }
        else if (mode === "UrbanIndex") {
            color = d3.scaleThreshold()
                .domain(d3.range(1, 9, 1))
                .range(d3.schemeReds[9]);
            title = "Rural-Urban Index";
            desc = "Rural-Urban Index by County";
            x = d3.scaleLinear()
              .domain([1, 9, 1])
              .rangeRound([450, 900]);
            getTextFunction = rawText;
        }
        else if (mode === "PopulationGrowth") {
            color = d3.scaleThreshold()
                .domain(d3.range(-1, 3.5, 0.5))
                .range(d3.schemeReds[9]);
            title = "Population Growth";
            desc = "Population Growth Percentage by County";
            x = d3.scaleLinear()
              .domain([-1, 3.5, 0.5])
              .rangeRound([450, 900]);
            getTextFunction = percentage;
        }
        else if ($.inArray(mode, industryStrings) != -1) {   
            title = mode;
            
            desc = "Annual Payroll per County and Industry";
            
            x = null;
              
            if (mode === "AllSectors") {
                color = d3.scaleThreshold()
                    .domain([0, 100000, 300000, 1000000, 2500000, 10000000, 25000000, 100000000])
                    .range(d3.schemeReds[7]);
                    
                x = d3.scaleThreshold()
                  .domain([0, 100000, 300000, 1000000, 2500000, 10000000, 25000000, 100000000])
                  .range(d3.range(450, 950, 500.0 / 8));
            }
            else {
                color = d3.scaleThreshold()
                    .domain([0, 1000, 10000, 50000, 200000, 500000, 1000000, 2500000, 10000000])
                    .range(d3.schemeReds[8]);
            
                x = d3.scaleThreshold()
                    .domain([0, 1000, 10000, 50000, 200000, 500000, 1000000, 2500000, 10000000])
                    .range(d3.range(450, 950, 500 / 8));
            }
            
            getTextFunction = dollarsTimesThousand;
        }
        else if (mode === "Total1824" || mode === "TotalG25") {
            color = d3.scaleThreshold()
                .domain([0, 500, 2500, 10000, 50000, 100000, 250000, 1000000, 2500000, 5000000])
                .range(d3.schemeReds[9]);
             
            title = mode;
            
            desc = "Total population of age group in county";
            
            x = d3.scaleThreshold()
              .domain([0, 500, 2500, 10000, 50000, 100000, 250000, 1000000, 2500000, 5000000])
              .range(d3.range(450, 950, 50));
                
            educationType = mode;
            
            getTextFunction = rawText;
            
            d3.queue()
                .defer(d3.json, "https://d3js.org/us-10m.v1.json")
                .defer(d3.csv, "./education/simplifiedEducationCount.csv", function(d) { 
                    addData = {};
                    //var educationModes = [
                        //"Total1824","LHS1824","HS1824","SC1824","BH1824","TotalG25","L9G25","912G25","HSG25","SCG25","ADG25","BDG25","GPG25"
                    //];
                    for (var i = 0; i < educationStrings.length; i++) {
                        addData[educationStrings[i]] = +d[educationStrings[i]];
                    }
                    dataMap.set(d["CountyID"], addData);
                })
                .await(educationReady);
        }
        else if ($.inArray(mode, educationStrings) != -1) {
            color = d3.scaleThreshold()
                .domain([0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0])
                .range(d3.schemeReds[9]);

            title = mode;    

            desc = "Percentage of people in age-group and county who have completed this degree or greater";
            
            x = d3.scaleLinear()
                .domain([0.1, 1, 0.1])
                .rangeRound([450, 900]);
            
            educationType = mode;
            
            getTextFunction = rawText;
            
            d3.queue()
                .defer(d3.json, "https://d3js.org/us-10m.v1.json")
                .defer(d3.csv, "./education/simplifiedEducationCount.csv", function(d) { 
                    addData = {};
                    //var educationModes = [
                        //"Total1824","LHS1824","HS1824","SC1824","BH1824","TotalG25","L9G25","912G25","HSG25","SCG25","ADG25","BDG25","GPG25"
                    //];
                    for (var i = 0; i < educationStrings.length; i++) {
                        addData[educationStrings[i]] = +d[educationStrings[i]];
                    }
                    dataMap.set(d["CountyID"], addData);
                })
                .await(educationReady);
        }
        else if (mode.includes("Percentage")) {
            smallPercentageModes = [
                "IndianOriginPercentage", 
                "AsianOriginPercentage", 
                "PacificIslanderOriginPercentage", 
                "OtherOriginPercentage", 
                "MultiOriginPercentage"
            ];
            title = mode;    
            desc = mode;
            getTextFunction = percentage;
           
            if ($.inArray(mode, smallPercentageModes) !== -1) {
                color = d3.scaleThreshold()
                    .domain([0, 5, 10, 15, 20, 25, 30, 35, 40, 45])
                    .range(d3.schemeBlues[9]);
                
                x = d3.scaleLinear()
                    .domain([0, 5, 10, 15, 20, 25, 30, 35, 40, 45])
                    .rangeRound([450, 900]);
            }
            else if ($.inArray(mode, workforcePercentageStrings) !== -1) {
                color = d3.scaleThreshold()
                    .domain([0, 2.5, 5, 7.5, 10, 12.5, 15, 20])
                    .range(d3.schemeBlues[7]);
                
                x = d3.scaleLinear()
                    .domain([0, 2.5, 5, 7.5, 10, 12.5, 15, 20])
                    .rangeRound([450, 900]);
            }
            else {
                color = d3.scaleThreshold()
                    .domain([0, 10, 20, 30, 40, 50, 60, 70, 80, 90])
                    .range(d3.schemeBlues[9]);
                
                x = d3.scaleLinear()
                    .domain([0, 10, 20, 30, 40, 50, 60, 70, 80, 90])
                    .rangeRound([450, 900]);
            }
            
        }
        else {
            color = d3.scaleThreshold()
                .domain([0, 100, 500, 2000, 10000, 20000, 50000, 200000, 500000, 1000000])
                .range(d3.schemeBlues[9]);

            title = mode;    

            desc = mode;
            
            x = d3.scaleLinear()
                .domain([0, 100, 500, 2000, 10000, 20000, 50000, 200000, 500000, 1000000])
                .rangeRound([450, 900]);
                
            getTextFunction = rawText;
        }
        
        //Look up and load the data under inspection
        if (mode in allModes && $.inArray(mode, educationStrings) === -1) {
            if (typeof allModes[mode] === "object" && "compositeData" in allModes[mode]) {
                var dataObject = allModes[mode];
                var listRequired = dataObject["required"];
                var processFunction = dataObject["function"];
                var dataDictionary = {};
                var numDataLoaded = 0;
                
                dataStrings = ["unemployment.csv", "unemployment.csv", "unemployment.csv", "unemployment.csv", "unemployment.csv"];
                for (var i = 0; i < listRequired.length; i++) {
                    var copyDataName = listRequired[i];
                    var dataStringTemplate = allModes[listRequired[i]];
                    /*
                    if (dataStringTemplate.indexOf("|") !== -1) {
                        dataStrings[i] = dataStringTemplate.split("|")[0];
                    }
                    else {
                        dataStrings[i] = dataStringTemplate;
                    }
                    */
                    dataStrings[i] = dataStringTemplate;
                }
                 
                d3.queue()
                    .defer(d3.csv, dataStrings[0].split("|")[0])
                    .defer(d3.csv, dataStrings[1].split("|")[0])
                    .defer(d3.csv, dataStrings[2].split("|")[0])
                    .defer(d3.csv, dataStrings[3].split("|")[0])
                    .defer(d3.csv, dataStrings[4].split("|")[0])
                    .await(function(error, file1, file2, file3, file4, file5) {
                        if (error) {
                            console.error('Oh dear, something went wrong: ' + error);
                        }
                        files = [file1, file2, file3, file4, file5];
                        for (var i = 0; i < 5; i++) {
                            if (dataStrings[i].indexOf("|") !== -1) {
                                var tokens = dataStrings[i].split("|");
                                var csvFileName = tokens[0], idColumnName = tokens[1], dataColumnName = tokens[2];
                                var copyMap = d3.map();
                                
                                for (var j = 0; j < files[i].length; j++) {
                                    var entry = files[i][j];
                                    copyMap.set(entry[idColumnName] + "", entry[dataColumnName]);
                                }
                                
                                dataDictionary[listRequired[i]] = copyMap;
                            }
                        }   
                        
                        dataMap = processFunction(dataDictionary, listRequired);
                        d3.queue()
                            .defer(d3.json, "https://d3js.org/us-10m.v1.json")
                            .await(function(error, us) {
                                jsonCsvDataReady(error, us);
                            });
                    });
                    
                    
                    
                    
                    /*
                    d3.csv(csvFileName) //TODO
                        .row(function(d) { return {key: d[idColumnName], value: +num(d[dataColumnName])}; })
                        .get(function(error, rows) {
                            console.log(dataString);
                            var copyMap = d3.map();
                            for (var j = 0; j < rows.length; j++) {
                                var entry = rows[j];
                                copyMap.set(entry.key, entry.value);
                            }
                            dataDictionary[listRequired[numDataLoaded]] = copyMap;
                            
                            console.log(copyMap);
                            
                            numDataLoaded++;
                            if (numDataLoaded === listRequired.length) {
                                dataMap = processFunction(dataDictionary);
                                d3.queue()
                                    .defer(d3.json, "https://d3js.org/us-10m.v1.json")
                                    .await(function(error, us) {
                                        jsonCsvDataReady(error, us);
                                    });
                            }
                        });*/

            }   
            else {
                var dataString = allModes[mode]; //Contains the file name|county id column|true data column
                loadCsvAndCallBack(dataString, jsonCsvDataReady, dataMap);
            }
        }

        if (mode !== null) {
            desc2 = allModesDesc[mode];
        }
       
        if (color == null) {

        }
        else {
            g.selectAll("rect")
              .data(color.range().map(function(d) {
                  d = color.invertExtent(d);
                  if (d[0] == null) d[0] = x.domain()[0];
                  if (d[1] == null) d[1] = x.domain()[1];
                  return d;
                }))
              .enter().append("rect")
                .attr("height", 8)
                .attr("x", function(d) { return x(d[0]); })
                .attr("width", function(d) { return x(d[1]) - x(d[0]); })
                .attr("fill", function(d) { return color(d[0]); });
                
            g.selectAll("text").remove();

            g.append("text")
                .attr("class", "caption")
                .attr("x", x.range()[0])
                .attr("y", -6)
                .attr("fill", "#000")
                .attr("text-anchor", "start")
                .attr("font-weight", "bold")
                .text(title + ": " + desc);
                
            /*
            g.append("text")
                .attr("class", "caption")
                .attr("x", x.range()[0])
                .attr("y", 36)
                .attr("fill", "#000")
                .attr("text-anchor", "start")
                .attr("font-weight", "bold")
                .text(desc);
            */
            
            g.call(d3.axisBottom(x)
                .tickSize(13)
                .tickFormat(function(x, i) { 
                    if (x % 1 === 0) {
                        return x;
                    }
                    else {
                        return x.toFixed(2);
                    }
                })
                .tickValues(color.domain()))
              .select(".domain")
                .remove();

            //svg.call(d3.zoom().on("zoom", function () {
                    //svg.attr("transform", d3.event.transform)
                    //}));
        }
        
        // Set-up the export button
        d3.select('#saveButton').on('click', function(){
            var svgString = getSVGString(svg.node());
            svgString2Image( svgString, 2*width, 2*height, 'png', save ); // passes Blob and filesize String to the callback

            function save( dataBlob, filesize ){
                saveAs( dataBlob, 'CensusVisual' + mode + '.png' ); // FileSaver.js function
            }
        });
    }

    loadMapWithMode(mode);
    clearAndRefreshMenu();

    d3.select("#toggleMenu").on('click', function() {
        if (menuVisible) {
            mapMenu.transition(1000).style("display", "none");
            aboutText.transition(1000).style("display", "none");
        }
        else {
            mapMenu.transition(1000).style("display", "block");
            aboutText.transition(1000).style("display", "block");
        }
        menuVisible = !menuVisible;
    });
    
    d3.select("#resetMap").on('click', function() {
        //container.attr("transform")
        container.attr("transform", {"k": "1", "x": "0", "y": "0"});
    });
    
    createCorMap.on('click', function() {
        var text1 = d3.select("#redCorrelationInput").property("value");
        var text2 = d3.select("#blueCorrelationInput").property("value");
        if (text1 in allModes && text2 in allModes) {
            var modifyData = allModes["Correlation"];
            modifyData["required"] = [text1, text2];
            loadMapWithMode("Correlation");
        }
    }); 

    //Zoom functions

    function dragstarted(d) {
      d3.event.sourceEvent.stopPropagation();
      d3.select(this).classed("dragging", true);
    }

    function dragged(d) {
      d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
      currentHighlightCity = null;
     divTooltip.style("opacity", 0);
    }

    function dragended(d) {
     console.log("Drag ended");
      d3.select(this).classed("dragging", false);
    }

    var zoom = d3.zoom()
        .scaleExtent([1, 10])
        .on("zoom", function() {
            container.attr("transform", d3.event.transform);
            //console.log(d3.event.transform);
            currentHighlightCity = null;
            divTooltip.style("opacity", 0);
            /*
            console.log(d3.event.scale);
            if (d3.event.scale <= 10) {
                container.select(".airport-dots").style("opacity", 1);
            }
            else {
                container.select(".airport-dots").style("opacity", 0);
            }
            */
        });

    var drag = d3.drag()
        .subject(function(d) { return d; })
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended);
        
    svg.call(zoom);

    </script>
</body>